<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@500&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/ed72a65202.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <meta charset="utf-8">
    <style>
        .card {
            animation: fadeIn 1.0s ease 0.0s 1 normal;
            transition: all 0.5s;
        }

        @keyframes fadeIn {
            0% {
                opacity: 0
            }

            100% {
                opacity: 1
            }
        }

        .transition_all {
            transition: all 0.5s;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-connected {
            background-color: #28a745;
        }

        .status-disconnected {
            background-color: #dc3545;
        }

        .status-processing {
            background-color: #ffc107;
        }

        .log-container {
            max-height: 300px;
            overflow-y: auto;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .log-entry {
            margin-bottom: 5px;
            white-space: pre-wrap;
        }

        .log-received {
            color: #0066cc;
        }

        .log-sent {
            color: #28a745;
        }

        .log-error {
            color: #dc3545;
        }

        .log-info {
            color: #6c757d;
        }
    </style>
</head>

<body>
    <div class="container-sm">
        <p><img class="mt-3 mb-1" src="../assets/logo_text.png" height="50px"></p>
        <h5>ç±³å¤ªéƒ AI ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</h5>

        <div class="row">
            <div class="col-12">
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <span id="status-indicator" class="status-indicator status-disconnected"></span>
                            æ¥ç¶šçŠ¶æ…‹: <span id="status-text">æ¥ç¶šå¾…æ©Ÿä¸­</span>
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="input-group mb-3">
                            <span class="input-group-text">éƒ¨å±‹å</span>
                            <input class="form-control" type="text" id="text_room_name" placeholder="é…ä¿¡ä¸­ã®éƒ¨å±‹åãŒè‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™"
                                value="">
                            <button class="btn btn-outline-primary" id="button_connect">æ¥ç¶š</button>
                        </div>

                        <div class="input-group mb-3">
                            <span class="input-group-text">LM Studio URL</span>
                            <input class="form-control" type="text" id="text_lm_studio_url"
                                value="http://127.0.0.1:1234/v1">
                            <button class="btn btn-outline-secondary" id="button_test_lm_studio">ãƒ†ã‚¹ãƒˆ</button>
                        </div>

                        <div class="input-group mb-3">
                            <span class="input-group-text">AI åå‰</span>
                            <input class="form-control" type="text" id="text_ai_name" value="ç±³å¤ªéƒ">
                        </div>

                        <div class="row mb-3">
                            <div class="col-6">
                                <label for="select_text_direction" class="form-label">æ–‡å­—ç§»å‹•æ–¹å‘</label>
                                <select class="form-select form-select-sm" id="select_text_direction">
                                    <option value="still" selected>é™æ­¢</option>
                                    <option value="up">â†‘</option>
                                    <option value="down">â†“</option>
                                    <option value="left">â†</option>
                                    <option value="right">â†’</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label for="input_text_color" class="form-label">æ–‡å­—è‰²</label>
                                <input type="color" class="form-control form-control-color" id="input_text_color"
                                    value="#FFD700" title="æ–‡å­—è‰²ã‚’é¸æŠ">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="textarea_system_prompt" class="form-label">ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆäº‹å‰çŸ¥è­˜ï¼‰</label>
                            <div class="input-group mb-2">
                                <select class="form-select" id="select_prompt_preset">
                                    <option value="">ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’é¸æŠ...</option>
                                    <option value="friendly">è¦ªã—ã¿ã‚„ã™ã„ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</option>
                                    <option value="teacher">å…ˆç”Ÿå½¹</option>
                                    <option value="comedian">ãŠç¬‘ã„èŠ¸äºº</option>
                                    <option value="expert">å°‚é–€å®¶</option>
                                    <option value="supporter">å¿œæ´è€…</option>
                                </select>
                                <button class="btn btn-outline-secondary" id="button_apply_preset">é©ç”¨</button>
                            </div>
                            <textarea class="form-control" id="textarea_system_prompt" rows="3"
                                placeholder="AIã®å½¹å‰²ã‚„æŒ¯ã‚‹èˆã„ã€äº‹å‰çŸ¥è­˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">ã‚ãªãŸã®åå‰ã¯{AI_NAME}ã§ã™ã€‚è¦ªã—ã¿ã‚„ã™ãè¦ªåˆ‡ãªAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ã‚³ãƒ¡ãƒ³ãƒˆç”»é¢ã«æµã‚Œã‚‹ãŸã‚ã€è¿”ç­”ã¯å¿…ãš120æ–‡å­—ä»¥å†…ã®çŸ­ã„ä¸€æ–‡ã§ãŠç­”ãˆãã ã•ã„ã€‚</textarea>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="checkbox_auto_response" checked>
                            <label class="form-check-label" for="checkbox_auto_response" id="label_auto_response">
                                ã€Œç±³å¤ªéƒã€ã‚’å«ã‚€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«è‡ªå‹•å¿œç­”
                            </label>
                        </div>

                        <div class="card border-warning mb-3">
                            <div class="card-header bg-warning bg-opacity-10">
                                <h6 class="mb-0">è‡ªå‹•æŠ•ç¨¿æ©Ÿèƒ½ï¼ˆæˆæ¥­ç››ã‚Šä¸Šã’ï¼‰</h6>
                            </div>
                            <div class="card-body">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="checkbox_auto_posting">
                                    <label class="form-check-label" for="checkbox_auto_posting">
                                        å®šæœŸçš„ã«è‡ªå‹•ã§ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
                                    </label>
                                </div>

                                <div class="row mb-2">
                                    <div class="col-6">
                                        <label for="range_posting_interval_min" class="form-label">æœ€å°é–“éš”ï¼ˆåˆ†ï¼‰</label>
                                        <input type="range" class="form-range" id="range_posting_interval_min" min="1"
                                            max="10" value="2">
                                        <small class="text-muted"><span id="span_interval_min">2</span>åˆ†</small>
                                    </div>
                                    <div class="col-6">
                                        <label for="range_posting_interval_max" class="form-label">æœ€å¤§é–“éš”ï¼ˆåˆ†ï¼‰</label>
                                        <input type="range" class="form-range" id="range_posting_interval_max" min="5"
                                            max="20" value="8">
                                        <small class="text-muted"><span id="span_interval_max">8</span>åˆ†</small>
                                    </div>
                                </div>

                                <div class="mb-2">
                                    <label for="select_posting_style" class="form-label">æŠ•ç¨¿ã‚¹ã‚¿ã‚¤ãƒ«</label>
                                    <select class="form-select form-select-sm" id="select_posting_style">
                                        <option value="mixed">ãƒŸãƒƒã‚¯ã‚¹ï¼ˆæˆæ¥­é–¢é€£ï¼‹é›‘è«‡ï¼‰</option>
                                        <option value="academic">æˆæ¥­é–¢é€£ã®ã¿</option>
                                        <option value="casual">é›‘è«‡ã®ã¿</option>
                                        <option value="reaction">ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ã¿</option>
                                    </select>
                                </div>

                                <button class="btn btn-sm btn-outline-success" id="button_test_auto_posting">
                                    ãƒ†ã‚¹ãƒˆæŠ•ç¨¿
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">æ´»å‹•ãƒ­ã‚°</h6>
                    </div>
                    <div class="card-body">
                        <div id="log-container" class="log-container"></div>
                        <button class="btn btn-sm btn-outline-secondary mt-2" id="button_clear_log">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
                    </div>
                </div>
            </div>
        </div>

        <hr>

        <footer class="page-footer font-small">
            <div class="footer-copyright small text-center">
                Commentable Kometaro AI Assistant<br>
                &copy; 2025 <a href="https://tetsuakibaba.jp">Tetsuaki Baba</a>
            </div>
        </footer>
    </div>

    <!-- Scripts -->
    <script src="../p5.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let socket;
        let isConnected = false;
        let isAutoResponse = true;
        let isAutoPosting = false;
        let autoPostingTimer = null;
        let lmStudioUrl = 'http://127.0.0.1:1234/v1';
        let aiName = 'ç±³å¤ªéƒ';
        let aiTextDirection = 'still';
        let aiTextColor = '#FFD700';
        let roomName = '';
        let postingIntervalMin = 2; // åˆ†
        let postingIntervalMax = 8; // åˆ†
        let postingStyle = 'mixed';

        // DOMè¦ç´ 
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        const logContainer = document.getElementById('log-container');
        const textRoomName = document.getElementById('text_room_name');
        const textLmStudioUrl = document.getElementById('text_lm_studio_url');
        const textAiName = document.getElementById('text_ai_name');
        const selectTextDirection = document.getElementById('select_text_direction');
        const inputTextColor = document.getElementById('input_text_color');
        const textareaSystemPrompt = document.getElementById('textarea_system_prompt');
        const checkboxAutoResponse = document.getElementById('checkbox_auto_response');
        const buttonConnect = document.getElementById('button_connect');
        const buttonClearLog = document.getElementById('button_clear_log');
        const buttonTestLMStudio = document.getElementById('button_test_lm_studio');
        const selectPromptPreset = document.getElementById('select_prompt_preset');
        const buttonApplyPreset = document.getElementById('button_apply_preset');

        // è‡ªå‹•æŠ•ç¨¿é–¢é€£ã®DOMè¦ç´ 
        const checkboxAutoPosting = document.getElementById('checkbox_auto_posting');
        const rangePostingIntervalMin = document.getElementById('range_posting_interval_min');
        const rangePostingIntervalMax = document.getElementById('range_posting_interval_max');
        const spanIntervalMin = document.getElementById('span_interval_min');
        const spanIntervalMax = document.getElementById('span_interval_max');
        const selectPostingStyle = document.getElementById('select_posting_style');
        const buttonTestAutoPosting = document.getElementById('button_test_auto_posting');

        // URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãƒ«ãƒ¼ãƒ åã‚’è¨­å®š
        function getURLParams() {
            const params = new URLSearchParams(window.location.search);
            const result = {};
            for (const [key, value] of params) {
                result[key] = value;
            }
            return result;
        }

        // ãƒ­ã‚°å‡ºåŠ›é–¢æ•°
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateStatus(status, text) {
            statusIndicator.className = `status-indicator status-${status}`;
            statusText.textContent = text;
        }

        // ãƒ—ãƒªã‚»ãƒƒãƒˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        const promptPresets = {
            friendly: "ã‚ãªãŸã®åå‰ã¯{AI_NAME}ã§ã™ã€‚è¦ªã—ã¿ã‚„ã™ãè¦ªåˆ‡ãªAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚é…ä¿¡ã®ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨æ¥½ã—ãäº¤æµã—ã¦ãã ã•ã„ã€‚çµµæ–‡å­—ã‚’é©åº¦ã«ä½¿ã„ã€è¦ªè¿‘æ„Ÿã®ã‚ã‚‹å£èª¿ã§è©±ã—ã¦ãã ã•ã„ã€‚è¿”ç­”ã¯å¿…ãš120æ–‡å­—ä»¥å†…ã®çŸ­ã„ä¸€æ–‡ã§ãŠç­”ãˆãã ã•ã„ã€‚",
            teacher: "ã‚ãªãŸã®åå‰ã¯{AI_NAME}ã§ã™ã€‚çŸ¥è­˜è±Šå¯Œã§åˆ†ã‹ã‚Šã‚„ã™ãæ•™ãˆã‚‹ã“ã¨ãŒå¾—æ„ãªå…ˆç”Ÿã§ã™ã€‚è³ªå•ãŒã‚ã‚Œã°ä¸å¯§ã«èª¬æ˜ã—ã€å­¦ç¿’ã‚’æ”¯æ´ã—ã¦ãã ã•ã„ã€‚å°‚é–€ç”¨èªã¯åˆ†ã‹ã‚Šã‚„ã™ãè§£èª¬ã—ã¦ãã ã•ã„ã€‚è¿”ç­”ã¯å¿…ãš120æ–‡å­—ä»¥å†…ã®çŸ­ã„ä¸€æ–‡ã§ãŠç­”ãˆãã ã•ã„ã€‚",
            comedian: "ã‚ãªãŸã®åå‰ã¯{AI_NAME}ã§ã™ã€‚é¢ç™½ã„ã“ã¨ãŒå¤§å¥½ããªãŠç¬‘ã„èŠ¸äººã®AIã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç¬‘ã‚ã›ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã€ãƒ¦ãƒ¼ãƒ¢ã‚¢ã¨ãƒ€ã‚¸ãƒ£ãƒ¬ã‚’äº¤ãˆãªãŒã‚‰æ¥½ã—ãä¼šè©±ã—ã¦ãã ã•ã„ã€‚ãŸã ã—ã€äººã‚’å‚·ã¤ã‘ã‚‹ã‚ˆã†ãªå†…å®¹ã¯é¿ã‘ã¦ãã ã•ã„ã€‚è¿”ç­”ã¯å¿…ãš120æ–‡å­—ä»¥å†…ã®çŸ­ã„ä¸€æ–‡ã§ãŠç­”ãˆãã ã•ã„ã€‚",
            expert: "ã‚ãªãŸã®åå‰ã¯{AI_NAME}ã§ã™ã€‚å¹…åºƒã„åˆ†é‡ã«ç²¾é€šã—ãŸå°‚é–€å®¶ã§ã™ã€‚æ­£ç¢ºã§è©³ç´°ãªæƒ…å ±ã‚’æä¾›ã—ã€æ ¹æ‹ ã«åŸºã¥ã„ãŸå›ç­”ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚ä¸æ˜ãªç‚¹ã¯ç´ ç›´ã«ã€Œåˆ†ã‹ã‚‰ãªã„ã€ã¨ç­”ãˆã¦ãã ã•ã„ã€‚è¿”ç­”ã¯å¿…ãš120æ–‡å­—ä»¥å†…ã®çŸ­ã„ä¸€æ–‡ã§ãŠç­”ãˆãã ã•ã„ã€‚",
            supporter: "ã‚ãªãŸã®åå‰ã¯{AI_NAME}ã§ã™ã€‚é…ä¿¡è€…ã¨ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ã‚’ç››ã‚Šä¸Šã’ã‚‹å¿œæ´è€…ã§ã™ã€‚ãƒã‚¸ãƒ†ã‚£ãƒ–ãªã‚¨ãƒãƒ«ã‚®ãƒ¼ã§é…ä¿¡ã‚’å¿œæ´ã—ã€ä»–ã®è¦–è´è€…ã‚‚æ¥½ã—ã„æ°—æŒã¡ã«ãªã‚‹ã‚ˆã†ãªã‚³ãƒ¡ãƒ³ãƒˆã‚’ã—ã¦ãã ã•ã„ã€‚è¿”ç­”ã¯å¿…ãš120æ–‡å­—ä»¥å†…ã®çŸ­ã„ä¸€æ–‡ã§ãŠç­”ãˆãã ã•ã„ã€‚"
        };

        // ãƒ—ãƒªã‚»ãƒƒãƒˆé©ç”¨æ©Ÿèƒ½
        function applyPromptPreset() {
            const selectedPreset = selectPromptPreset.value;
            if (selectedPreset && promptPresets[selectedPreset]) {
                const currentAiName = textAiName.value.trim() || 'ç±³å¤ªéƒ';
                const promptText = promptPresets[selectedPreset].replace(/{AI_NAME}/g, currentAiName);
                textareaSystemPrompt.value = promptText;
                addLog(`ãƒ—ãƒªã‚»ãƒƒãƒˆã€Œ${selectPromptPreset.options[selectPromptPreset.selectedIndex].text}ã€ã‚’é©ç”¨ã—ã¾ã—ãŸ`, 'info');
            }
        }

        // è‡ªå‹•æŠ•ç¨¿ç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ
        function generateAutoPostPrompt(style) {
            const prompts = {
                mixed: [
                    "æˆæ¥­ã®é›°å›²æ°—ã‚’ç››ã‚Šä¸Šã’ã‚‹ã‚ˆã†ãªçŸ­ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’ã—ã¦ãã ã•ã„ã€‚",
                    "å­¦ç”ŸãŒèˆˆå‘³ã‚’æŒã¡ãã†ãªé›‘è«‡ã‚’120æ–‡å­—ä»¥å†…ã§ã—ã¦ãã ã•ã„ã€‚",
                    "æˆæ¥­ã«é–¢é€£ã™ã‚‹é¢ç™½ã„è±†çŸ¥è­˜ã‚’çŸ­ãæ•™ãˆã¦ãã ã•ã„ã€‚",
                    "ä»Šæ—¥ã®æ°—åˆ†ã‚„å¤©æ°—ã«ã¤ã„ã¦è»½ãã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãã ã•ã„ã€‚",
                    "å‹‰å¼·ã®ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ãŒä¸ŠãŒã‚‹ã‚ˆã†ãªå¿œæ´ã‚³ãƒ¡ãƒ³ãƒˆã‚’ã—ã¦ãã ã•ã„ã€‚"
                ],
                academic: [
                    "æˆæ¥­ã«é–¢é€£ã™ã‚‹èˆˆå‘³æ·±ã„è©±é¡Œã‚’120æ–‡å­—ä»¥å†…ã§æä¾›ã—ã¦ãã ã•ã„ã€‚",
                    "å­¦ç¿’ã«å½¹ç«‹ã¤è±†çŸ¥è­˜ã‚’çŸ­ãæ•™ãˆã¦ãã ã•ã„ã€‚",
                    "æˆæ¥­ã®å†…å®¹ã«é–¢é€£ã™ã‚‹è³ªå•ã‚’æŠ•ã’ã‹ã‘ã¦ãã ã•ã„ã€‚",
                    "å­¦ç¿’ã®ã‚³ãƒ„ã‚’çŸ­ãã‚¢ãƒ‰ãƒã‚¤ã‚¹ã—ã¦ãã ã•ã„ã€‚"
                ],
                casual: [
                    "ä»Šæ—¥ã®æ°—åˆ†ã«ã¤ã„ã¦è»½ãã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãã ã•ã„ã€‚",
                    "å­£ç¯€ã‚„å¤©æ°—ã«ã¤ã„ã¦çŸ­ãè©±ã—ã¦ãã ã•ã„ã€‚",
                    "é¢ç™½ã„é›‘è«‡ã‚’120æ–‡å­—ä»¥å†…ã§ã—ã¦ãã ã•ã„ã€‚",
                    "å­¦ç”Ÿç”Ÿæ´»ã®è©±é¡Œã§è»½ãç››ã‚Šä¸Šã’ã¦ãã ã•ã„ã€‚"
                ],
                reaction: "REACTION_MODE" // ç‰¹åˆ¥ãªãƒãƒ¼ã‚«ãƒ¼
            };

            if (style === 'reaction') {
                return prompts.reaction;
            }

            const stylePrompts = prompts[style] || prompts.mixed;
            const randomPrompt = stylePrompts[Math.floor(Math.random() * stylePrompts.length)];
            return randomPrompt;
        }

        // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³å°‚ç”¨ã®é€ä¿¡é–¢æ•°
        function sendRandomReaction() {
            // çµµæ–‡å­—ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚µã‚¤ãƒ¬ãƒ³ãƒˆï¼‰
            const emojiReactions = ['ğŸ‘', 'ğŸ™', 'ğŸ™‹', 'ğŸ¥º', 'ğŸ¤«'];

            // ã‚µã‚¦ãƒ³ãƒ‰ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆéŸ³ä»˜ãï¼‰
            const soundReactions = [
                { emoji: 'ğŸ“¸', id: 0 },  // ã‚«ãƒ¡ãƒ©
                { emoji: 'ğŸ‘', id: 1 },  // æ‹æ‰‹
                { emoji: 'ğŸ‰', id: 2 },  // ã‚¯ãƒ©ãƒƒã‚«ãƒ¼
                { emoji: 'ğŸ¥³', id: 3 },  // å¤§æ­“å£°
                { emoji: 'ğŸ˜®', id: 4 },  // ã¸ã‡ã€œ
                { emoji: 'ğŸ¤”', id: 5 },  // ã¡ã‚‡ã£ã¨ã¾ã£ã¦
                { emoji: 'ğŸ‘Œ', id: 6 },  // OK
                { emoji: 'ğŸ‘Š', id: 7 },  // ãƒ‘ãƒ³ãƒ
                { emoji: 'ğŸ¤£', id: 8 },  // å¤§ç¬‘ã„
                { emoji: 'ğŸ˜', id: 9 }   // w
            ];

            // 70%ã®ç¢ºç‡ã§çµµæ–‡å­—ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€30%ã®ç¢ºç‡ã§ã‚µã‚¦ãƒ³ãƒ‰ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³
            const useSound = Math.random() < 0.3;

            let data;
            if (useSound) {
                // ã‚µã‚¦ãƒ³ãƒ‰ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³
                const reaction = soundReactions[Math.floor(Math.random() * soundReactions.length)];
                data = {
                    my_name: aiName,
                    comment: reaction.emoji,
                    flg_emoji: true,
                    flg_sound: true,
                    id_sound: reaction.id,
                    color_text: aiTextColor,
                    color_text_stroke: '#111111',
                    text_direction: aiTextDirection,
                    flg_speech: false,
                    hidden: -1
                };
                addLog(`ã‚µã‚¦ãƒ³ãƒ‰ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡: ${reaction.emoji} (ID: ${reaction.id})`, 'sent');
            } else {
                // çµµæ–‡å­—ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³
                const emoji = emojiReactions[Math.floor(Math.random() * emojiReactions.length)];
                data = {
                    my_name: aiName,
                    comment: emoji,
                    flg_emoji: true,
                    flg_sound: false,
                    id_sound: 0,
                    color_text: aiTextColor,
                    color_text_stroke: '#111111',
                    text_direction: aiTextDirection,
                    flg_speech: false,
                    hidden: -1
                };
                addLog(`çµµæ–‡å­—ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡: ${emoji}`, 'sent');
            }

            if (socket && isConnected) {
                socket.emit('comment', data);
            }
        }

        // è‡ªå‹•æŠ•ç¨¿ã‚’å®Ÿè¡Œ
        async function executeAutoPosting() {
            if (!isConnected || !isAutoPosting) {
                return;
            }

            try {
                addLog('è‡ªå‹•æŠ•ç¨¿ã‚’å®Ÿè¡Œä¸­...', 'info');

                if (postingStyle === 'reaction') {
                    // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯çµµæ–‡å­—/ã‚µã‚¦ãƒ³ãƒ‰ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’é€ä¿¡
                    sendRandomReaction();
                } else {
                    // ãã®ä»–ã®ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆ
                    const prompt = generateAutoPostPrompt(postingStyle);
                    const aiResponse = await sendToLMStudio(prompt);

                    // æŠ•ç¨¿
                    setTimeout(() => {
                        sendComment(aiResponse);
                        addLog(`è‡ªå‹•æŠ•ç¨¿å®Œäº†: ${aiResponse}`, 'info');
                    }, 500);
                }

            } catch (error) {
                addLog(`è‡ªå‹•æŠ•ç¨¿ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }

            // æ¬¡ã®æŠ•ç¨¿ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
            scheduleNextAutoPosting();
        }        // æ¬¡ã®è‡ªå‹•æŠ•ç¨¿ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
        function scheduleNextAutoPosting() {
            if (!isAutoPosting) {
                return;
            }

            // ãƒ©ãƒ³ãƒ€ãƒ ãªé–“éš”ã‚’è¨ˆç®—ï¼ˆåˆ†å˜ä½ã‚’ãƒŸãƒªç§’ã«å¤‰æ›ï¼‰
            const minMs = postingIntervalMin * 60 * 1000;
            const maxMs = postingIntervalMax * 60 * 1000;
            const randomInterval = Math.floor(Math.random() * (maxMs - minMs)) + minMs;

            const nextPostTime = new Date(Date.now() + randomInterval);
            addLog(`æ¬¡ã®è‡ªå‹•æŠ•ç¨¿äºˆå®š: ${nextPostTime.toLocaleTimeString()} (${Math.floor(randomInterval / 60000)}åˆ†å¾Œ)`, 'info');

            autoPostingTimer = setTimeout(executeAutoPosting, randomInterval);
        }

        // è‡ªå‹•æŠ•ç¨¿ã‚’é–‹å§‹
        function startAutoPosting() {
            if (!isConnected) {
                addLog('ã‚µãƒ¼ãƒã«æ¥ç¶šã—ã¦ã‹ã‚‰è‡ªå‹•æŠ•ç¨¿ã‚’é–‹å§‹ã—ã¦ãã ã•ã„', 'error');
                checkboxAutoPosting.checked = false;
                return;
            }

            isAutoPosting = true;
            addLog('è‡ªå‹•æŠ•ç¨¿ã‚’é–‹å§‹ã—ã¾ã—ãŸ', 'info');
            scheduleNextAutoPosting();
        }

        // è‡ªå‹•æŠ•ç¨¿ã‚’åœæ­¢
        function stopAutoPosting() {
            isAutoPosting = false;
            if (autoPostingTimer) {
                clearTimeout(autoPostingTimer);
                autoPostingTimer = null;
            }
            addLog('è‡ªå‹•æŠ•ç¨¿ã‚’åœæ­¢ã—ã¾ã—ãŸ', 'info');
        }

        // ãƒ†ã‚¹ãƒˆæŠ•ç¨¿
        async function testAutoPosting() {
            if (!isConnected) {
                alert('ã‚µãƒ¼ãƒã«æ¥ç¶šã—ã¦ã‹ã‚‰ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„');
                return;
            }

            try {
                addLog('ãƒ†ã‚¹ãƒˆæŠ•ç¨¿ã‚’å®Ÿè¡Œä¸­...', 'info');

                if (postingStyle === 'reaction') {
                    // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯çµµæ–‡å­—/ã‚µã‚¦ãƒ³ãƒ‰ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’é€ä¿¡
                    sendRandomReaction();
                } else {
                    // ãã®ä»–ã®ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆ
                    const prompt = generateAutoPostPrompt(postingStyle);
                    const aiResponse = await sendToLMStudio(prompt);

                    setTimeout(() => {
                        sendComment(aiResponse);
                        addLog(`ãƒ†ã‚¹ãƒˆæŠ•ç¨¿å®Œäº†: ${aiResponse}`, 'info');
                    }, 500);
                }

            } catch (error) {
                addLog(`ãƒ†ã‚¹ãƒˆæŠ•ç¨¿ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }        // LM Studio æ¥ç¶šãƒ†ã‚¹ãƒˆ
        async function testLMStudioConnection() {
            const testUrl = textLmStudioUrl.value.trim();
            addLog(`LM Studio æ¥ç¶šãƒ†ã‚¹ãƒˆã‚’é–‹å§‹: ${testUrl}`, 'info');

            try {
                const response = await sendToLMStudio('ãƒ†ã‚¹ãƒˆæ¥ç¶šã§ã™ã€‚120æ–‡å­—ä»¥å†…ã§ç°¡å˜ã«æŒ¨æ‹¶ã—ã¦ãã ã•ã„ã€‚');
                addLog('LM Studio æ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸï¼', 'info');
                alert('LM Studio ã¸ã®æ¥ç¶šã«æˆåŠŸã—ã¾ã—ãŸï¼');
            } catch (error) {
                addLog(`LM Studio æ¥ç¶šãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
                alert(`LM Studio ã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
            }
        }

        // LM Studio ã« API ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
        async function sendToLMStudio(message) {
            try {
                addLog(`LM Studio ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡: ${message}`, 'info');
                updateStatus('processing', 'AIå‡¦ç†ä¸­...');

                // LM Studio ã®æ¥ç¶šãƒ†ã‚¹ãƒˆ
                addLog(`æ¥ç¶šå…ˆ: ${lmStudioUrl}`, 'info');

                // ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å–å¾—ã—ã€AIåå‰ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ç½®æ›
                let systemPrompt = textareaSystemPrompt.value.trim();
                if (systemPrompt) {
                    systemPrompt = systemPrompt.replace(/{AI_NAME}/g, aiName);
                }

                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…åˆ—ã‚’æ§‹ç¯‰
                const messages = [];

                // ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒã‚ã‚‹å ´åˆã¯è¿½åŠ 
                if (systemPrompt) {
                    messages.push({
                        role: 'system',
                        content: systemPrompt
                    });
                }

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
                messages.push({
                    role: 'user',
                    content: message
                });

                addLog(`é€ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°: ${messages.length}`, 'info');
                if (systemPrompt) {
                    addLog(`ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: ${systemPrompt.substring(0, 50)}...`, 'info');
                }

                const response = await fetch(`${lmStudioUrl}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer lm-studio'
                    },
                    body: JSON.stringify({
                        model: 'local-model',
                        messages: messages,
                        temperature: 0.7,
                        max_tokens: 2048
                    })
                });

                addLog(`HTTP ãƒ¬ã‚¹ãƒãƒ³ã‚¹çŠ¶æ…‹: ${response.status}`, 'info');

                if (!response.ok) {
                    const errorText = await response.text();
                    addLog(`HTTP ã‚¨ãƒ©ãƒ¼è©³ç´°: ${errorText}`, 'error');
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }

                const data = await response.json();
                addLog(`ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿: ${JSON.stringify(data)}`, 'info');

                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('Invalid response format from LM Studio');
                }

                const aiResponse = data.choices[0].message.content;

                addLog(`LM Studio ã‹ã‚‰ã®å¿œç­”: ${aiResponse}`, 'info');

                // æ–‡å­—æ•°åˆ¶é™ã‚’é©ç”¨ï¼ˆ120æ–‡å­—ä»¥å†…ã«åˆ‡ã‚Šè©°ã‚ï¼‰
                let finalResponse = aiResponse.trim();
                if (finalResponse.length > 120) {
                    // 120æ–‡å­—ã§åˆ‡ã‚Šè©°ã‚ã¦ã€å¥èª­ç‚¹ã§è‡ªç„¶ã«åˆ‡ã‚Œã‚‹ä½ç½®ã‚’æ¢ã™
                    let truncated = finalResponse.substring(0, 120);
                    const lastPunctuation = Math.max(
                        truncated.lastIndexOf('ã€‚'),
                        truncated.lastIndexOf('ï¼'),
                        truncated.lastIndexOf('ï¼Ÿ'),
                        truncated.lastIndexOf('â™ª'),
                        truncated.lastIndexOf('âœ¨')
                    );

                    if (lastPunctuation > 60) { // 60æ–‡å­—ä»¥ä¸Šã®ä½ç½®ã«å¥èª­ç‚¹ãŒã‚ã‚Œã°ã€ãã“ã§åˆ‡ã‚‹
                        finalResponse = truncated.substring(0, lastPunctuation + 1);
                    } else {
                        // å¥èª­ç‚¹ãŒãªã„å ´åˆã¯117æ–‡å­—ã§åˆ‡ã£ã¦ã€Œ...ã€ã‚’è¿½åŠ 
                        finalResponse = truncated.substring(0, 117) + '...';
                    }

                    addLog(`æ–‡å­—æ•°åˆ¶é™ã«ã‚ˆã‚Šå¿œç­”ã‚’çŸ­ç¸®: ${finalResponse.length}æ–‡å­—`, 'info');
                }

                updateStatus('connected', 'æ¥ç¶šä¸­');

                return finalResponse;
            } catch (error) {
                addLog(`LM Studio ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');

                // CORS ã‚¨ãƒ©ãƒ¼ã®å ´åˆã®ç‰¹åˆ¥ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                if (error.message.includes('CORS') || error.message.includes('NetworkError')) {
                    addLog('CORS ã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚LM Studio ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
                    addLog('LM Studio ã§ CORS ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã‹ã€ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚', 'info');
                }

                updateStatus('connected', 'æ¥ç¶šä¸­ (AI ã‚¨ãƒ©ãƒ¼)');
                return `ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ç¾åœ¨AIãŒå¿œç­”ã§ãã¾ã›ã‚“ã€‚(ã‚¨ãƒ©ãƒ¼: ${error.message})`;
            }
        }

        // ã‚³ãƒ¡ãƒ³ãƒˆã‚’ã‚µãƒ¼ãƒã«é€ä¿¡
        function sendComment(comment) {
            if (!socket || !isConnected) {
                addLog('ã‚µãƒ¼ãƒã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            const data = {
                my_name: aiName,
                comment: comment,
                flg_speech: false,
                color_text: aiTextColor,
                color_text_stroke: '#111111',
                text_direction: aiTextDirection,
                flg_emoji: false,
                flg_sound: false,
                id_sound: 0,
                hidden: -1
            };

            socket.emit('comment', data);
            addLog(`ã‚³ãƒ¡ãƒ³ãƒˆé€ä¿¡: ${comment}`, 'sent');
        }

        // æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’å—ä¿¡ã—ãŸã¨ãã®å‡¦ç†
        async function onNewComment(data) {
            addLog(`å—ä¿¡: [${data.my_name}] ${data.comment}`, 'received');

            // AIåå‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if (isAutoResponse && data.comment.includes(aiName)) {
                addLog(`ã€Œ${aiName}ã€ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚AIå‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™ã€‚`, 'info');

                try {
                    const aiResponse = await sendToLMStudio(data.comment);

                    // AI ã®å¿œç­”ã‚’ã‚µãƒ¼ãƒã«é€ä¿¡
                    setTimeout(() => {
                        sendComment(aiResponse);
                    }, 1000); // 1ç§’é…å»¶

                } catch (error) {
                    addLog(`å‡¦ç†ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                }
            }
        }

        // Socket.IO æ¥ç¶š
        function connectToServer() {
            roomName = textRoomName.value.trim();
            lmStudioUrl = textLmStudioUrl.value.trim();
            aiName = textAiName.value.trim();
            aiTextDirection = selectTextDirection.value;
            aiTextColor = inputTextColor.value;
            isAutoResponse = checkboxAutoResponse.checked;

            if (!roomName) {
                alert('éƒ¨å±‹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            addLog('ã‚µãƒ¼ãƒã«æ¥ç¶šã—ã¦ã„ã¾ã™...', 'info');
            updateStatus('processing', 'æ¥ç¶šä¸­...');

            // Socket.IO æ¥ç¶š
            socket = io.connect(window.location.origin);

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
            socket.on('connect', () => {
                addLog('ã‚µãƒ¼ãƒã«æ¥ç¶šã—ã¾ã—ãŸ', 'info');
                socket.emit('watcher', socket.id);
            });

            socket.on('you_are_connected', () => {
                addLog(`éƒ¨å±‹ "${roomName}" ã«å‚åŠ ã—ã¦ã„ã¾ã™...`, 'info');
                socket.emit('join', roomName);
            });

            socket.on('login', (data) => {
                isConnected = true;
                updateStatus('connected', 'æ¥ç¶šä¸­');
                addLog(`éƒ¨å±‹ "${roomName}" ã«å‚åŠ ã—ã¾ã—ãŸ (å‚åŠ è€…æ•°: ${data.numUsers})`, 'info');
                buttonConnect.textContent = 'åˆ‡æ–­';
            });

            socket.on('comment', onNewComment);

            socket.on('user joined', (data) => {
                addLog(`${data.username} ãŒå‚åŠ ã—ã¾ã—ãŸ (å‚åŠ è€…æ•°: ${data.numUsers})`, 'info');
            });

            socket.on('user left', (data) => {
                addLog(`${data.username} ãŒé€€å‡ºã—ã¾ã—ãŸ (å‚åŠ è€…æ•°: ${data.numUsers})`, 'info');
            });

            socket.on('disconnect', () => {
                isConnected = false;
                stopAutoPosting(); // è‡ªå‹•æŠ•ç¨¿ã‚’åœæ­¢
                updateStatus('disconnected', 'åˆ‡æ–­ã•ã‚Œã¾ã—ãŸ');
                addLog('ã‚µãƒ¼ãƒã‹ã‚‰åˆ‡æ–­ã•ã‚Œã¾ã—ãŸ', 'error');
                buttonConnect.textContent = 'æ¥ç¶š';
            });

            socket.on('reconnect', () => {
                addLog('ã‚µãƒ¼ãƒã«å†æ¥ç¶šã—ã¾ã—ãŸ', 'info');
                socket.emit('join', roomName);
            });
        }

        // ã‚µãƒ¼ãƒã‹ã‚‰åˆ‡æ–­
        function disconnectFromServer() {
            if (socket) {
                socket.close();
                socket = null;
            }
            isConnected = false;
            stopAutoPosting(); // è‡ªå‹•æŠ•ç¨¿ã‚’åœæ­¢
            updateStatus('disconnected', 'åˆ‡æ–­ã•ã‚Œã¾ã—ãŸ');
            addLog('ã‚µãƒ¼ãƒã‹ã‚‰åˆ‡æ–­ã—ã¾ã—ãŸ', 'info');
            buttonConnect.textContent = 'æ¥ç¶š';
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        buttonConnect.addEventListener('click', () => {
            if (isConnected) {
                disconnectFromServer();
            } else {
                connectToServer();
            }
        });

        buttonClearLog.addEventListener('click', () => {
            logContainer.innerHTML = '';
        });

        buttonTestLMStudio.addEventListener('click', () => {
            testLMStudioConnection();
        });

        buttonApplyPreset.addEventListener('click', () => {
            applyPromptPreset();
        });

        // AIåå‰ã®å¤‰æ›´ç›£è¦–
        textAiName.addEventListener('input', () => {
            aiName = textAiName.value.trim() || 'ç±³å¤ªéƒ';
            updateAutoResponseLabel();
            addLog(`AIåå‰ã‚’ã€Œ${aiName}ã€ã«å¤‰æ›´ã—ã¾ã—ãŸ`, 'info');
        });

        // æ–‡å­—ã®æµã‚Œã‚‹æ–¹å‘ã®å¤‰æ›´ç›£è¦–
        selectTextDirection.addEventListener('change', () => {
            aiTextDirection = selectTextDirection.value;
            const directionText = selectTextDirection.options[selectTextDirection.selectedIndex].text;
            addLog(`æ–‡å­—ã®æµã‚Œã‚‹æ–¹å‘ã‚’ã€Œ${directionText}ã€ã«å¤‰æ›´ã—ã¾ã—ãŸ`, 'info');
        });

        // æ–‡å­—è‰²ã®å¤‰æ›´ç›£è¦–
        inputTextColor.addEventListener('change', () => {
            aiTextColor = inputTextColor.value;
            addLog(`æ–‡å­—è‰²ã‚’ã€Œ${aiTextColor}ã€ã«å¤‰æ›´ã—ã¾ã—ãŸ`, 'info');
        });

        // è‡ªå‹•å¿œç­”ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateAutoResponseLabel() {
            const labelAutoResponse = document.getElementById('label_auto_response');
            labelAutoResponse.textContent = `ã€Œ${aiName}ã€ã‚’å«ã‚€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«è‡ªå‹•å¿œç­”`;
        }

        // è‡ªå‹•æŠ•ç¨¿é–¢é€£ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        checkboxAutoPosting.addEventListener('change', () => {
            if (checkboxAutoPosting.checked) {
                startAutoPosting();
            } else {
                stopAutoPosting();
            }
        });

        rangePostingIntervalMin.addEventListener('input', () => {
            postingIntervalMin = parseInt(rangePostingIntervalMin.value);
            spanIntervalMin.textContent = postingIntervalMin;

            // æœ€å°å€¤ãŒæœ€å¤§å€¤ã‚’è¶…ãˆãªã„ã‚ˆã†ã«ã™ã‚‹
            if (postingIntervalMin >= postingIntervalMax) {
                postingIntervalMax = postingIntervalMin + 1;
                rangePostingIntervalMax.value = postingIntervalMax;
                spanIntervalMax.textContent = postingIntervalMax;
            }
        });

        rangePostingIntervalMax.addEventListener('input', () => {
            postingIntervalMax = parseInt(rangePostingIntervalMax.value);
            spanIntervalMax.textContent = postingIntervalMax;

            // æœ€å¤§å€¤ãŒæœ€å°å€¤ã‚’ä¸‹å›ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹
            if (postingIntervalMax <= postingIntervalMin) {
                postingIntervalMin = postingIntervalMax - 1;
                rangePostingIntervalMin.value = postingIntervalMin;
                spanIntervalMin.textContent = postingIntervalMin;
            }
        });

        selectPostingStyle.addEventListener('change', () => {
            postingStyle = selectPostingStyle.value;
            addLog(`æŠ•ç¨¿ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ã€Œ${selectPostingStyle.options[selectPostingStyle.selectedIndex].text}ã€ã«å¤‰æ›´`, 'info');
        });

        buttonTestAutoPosting.addEventListener('click', () => {
            testAutoPosting();
        });

        // è¨­å®šã®å¤‰æ›´ã‚’ç›£è¦–
        checkboxAutoResponse.addEventListener('change', () => {
            isAutoResponse = checkboxAutoResponse.checked;
            addLog(`è‡ªå‹•å¿œç­”: ${isAutoResponse ? 'ON' : 'OFF'}`, 'info');
        });

        // åˆæœŸåŒ–å‡¦ç†
        document.addEventListener('DOMContentLoaded', () => {
            // URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ãƒ«ãƒ¼ãƒ åã‚’å–å¾—
            const params = getURLParams();
            if (params.room) {
                const roomFromUrl = decodeURIComponent(params.room);
                textRoomName.value = roomFromUrl;
                addLog(`éƒ¨å±‹åã€Œ${roomFromUrl}ã€ãŒè‡ªå‹•è¨­å®šã•ã‚Œã¾ã—ãŸ`, 'info');
            }

            // åˆæœŸå€¤ã®è¨­å®š
            spanIntervalMin.textContent = postingIntervalMin;
            spanIntervalMax.textContent = postingIntervalMax;

            // è¡¨ç¤ºè¨­å®šã®åˆæœŸå€¤ã‚’è¨­å®š
            selectTextDirection.value = aiTextDirection;
            inputTextColor.value = aiTextColor;

            // è‡ªå‹•å¿œç­”ãƒ©ãƒ™ãƒ«ã‚’åˆæœŸè¨­å®š
            updateAutoResponseLabel();

            addLog(`${aiName} AI ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãŒèµ·å‹•ã—ã¾ã—ãŸ`, 'info');
            addLog(`ã€Œ${aiName}ã€ã‚’å«ã‚€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«è‡ªå‹•ã§ AI ãŒå¿œç­”ã—ã¾ã™`, 'info');
            addLog(`è¡¨ç¤ºè¨­å®š: ${selectTextDirection.options[selectTextDirection.selectedIndex].text}ã€è‰²: ${aiTextColor}`, 'info');
            addLog('è‡ªå‹•æŠ•ç¨¿æ©Ÿèƒ½ã§æˆæ¥­ã‚’ç››ã‚Šä¸Šã’ã‚‹ã“ã¨ãŒã§ãã¾ã™', 'info');
        });

        // ãƒšãƒ¼ã‚¸ãŒé–‰ã˜ã‚‰ã‚Œã‚‹å‰ã«ã‚½ã‚±ãƒƒãƒˆã‚’é–‰ã˜ã‚‹
        window.addEventListener('beforeunload', () => {
            stopAutoPosting(); // è‡ªå‹•æŠ•ç¨¿ã‚’åœæ­¢
            if (socket) {
                socket.close();
            }
        });
    </script>

</body>

</html>
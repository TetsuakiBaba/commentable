<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="../assets/css/custom.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>

    <!-- Packery for draggable grid layout -->
    <script src="https://unpkg.com/packery@2.1.2/dist/packery.pkgd.min.js"></script>
    <script src="https://unpkg.com/draggabilly@2.4.1/dist/draggabilly.pkgd.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@500&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/ed72a65202.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <meta charset="utf-8">
    <style>
        .card {
            animation: fadeIn 1.0s ease 0.0s 1 normal;
            transition: all 0.5s;
        }

        @keyframes fadeIn {
            0% {
                opacity: 0
            }

            100% {
                opacity: 1
            }
        }

        .transition_all {
            transition: all 0.5s;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-connected {
            background-color: #28a745;
        }

        .status-disconnected {
            background-color: #dc3545;
        }

        .status-processing {
            background-color: #ffc107;
        }

        .log-container {
            max-height: 300px;
            overflow-y: auto;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .log-entry {
            margin-bottom: 5px;
            white-space: pre-wrap;
        }

        .log-received {
            color: #0066cc;
        }

        .log-sent {
            color: #28a745;
        }

        .log-error {
            color: #dc3545;
        }

        .log-info {
            color: #6c757d;
        }

        /* ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ãªã‚«ãƒ¼ãƒ‰ãƒãƒ³ãƒ‰ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .card-handle {
            cursor: move;
            user-select: none;
        }

        .card-handle:active {
            cursor: grabbing;
        }

        /* ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
        .is-dragging {
            opacity: 0.7;
            z-index: 1000;
        }

        /* ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .accordion-toggle {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            font-size: 1.2rem;
            color: inherit;
            transition: transform 0.3s ease;
            margin-right: 8px;
        }

        .accordion-toggle:hover {
            opacity: 0.7;
        }

        .accordion-toggle.collapsed {
            transform: rotate(-90deg);
        }

        /* æœ€å°åŒ–æ™‚ã®ã‚«ãƒ¼ãƒ‰ãƒœãƒ‡ã‚£ */
        .card-body.collapsed {
            display: none;
        }
    </style>
</head>

<body>
    <!-- ãƒ–ãƒ©ã‚¦ã‚¶è­¦å‘Šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="browserWarningModal" tabindex="-1" aria-labelledby="browserWarningModalLabel"
        aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title" id="browserWarningModalLabel">
                        <i class="bi bi-exclamation-triangle-fill"></i> ãƒ–ãƒ©ã‚¦ã‚¶ã®äº’æ›æ€§è­¦å‘Š
                    </h5>
                </div>
                <div class="modal-body">
                    <p class="mb-3">
                        <strong>Google Chromeä»¥å¤–ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ã”åˆ©ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚</strong>
                    </p>
                    <p class="mb-2">ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ä»¥ä¸‹ã®æ©Ÿèƒ½ã§Chromeãƒ–ãƒ©ã‚¦ã‚¶ãŒå¿…è¦ã§ã™:</p>
                    <ul>
                        <li>éŸ³å£°èªè­˜æ©Ÿèƒ½ï¼ˆWeb Speech APIï¼‰</li>
                        <li>LM Studioã¸ã®ãƒ‡ãƒ¼ã‚¿é€ä¿¡</li>
                    </ul>
                    <p class="text-danger mb-0">
                        <i class="bi bi-info-circle"></i>
                        æ­£å¸¸ã«å‹•ä½œã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚Google Chromeã®ã”åˆ©ç”¨ã‚’å¼·ãæ¨å¥¨ã—ã¾ã™ã€‚
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        ã“ã®ã¾ã¾ç¶šã‘ã‚‹
                    </button>
                    <a href="https://www.google.com/chrome/" target="_blank" class="btn btn-primary">
                        <i class="bi bi-download"></i> Chromeã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <p><img class="mt-3 mb-1" src="../assets/logo_text.png" height="50px"><span class="badge bg-secondary">AI
                Assistant</span></p>

        <div class="row">
            <div class="col-12">
                <div class="mb-3">
                    <div class="d-flex align-items-center mb-2">
                        <span id="status-indicator" class="status-indicator status-disconnected"></span>
                        <span class="small">æ¥ç¶šçŠ¶æ…‹: <strong id="status-text">æ¥ç¶šå¾…æ©Ÿä¸­</strong></span>
                    </div>
                    <div class="input-group">
                        <span class="input-group-text">éƒ¨å±‹å</span>
                        <input class="form-control" type="text" id="text_room_name" placeholder="é…ä¿¡ä¸­ã®éƒ¨å±‹åãŒè‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™"
                            value="">
                        <button class="btn btn-outline-primary" id="button_connect">æ¥ç¶š</button>
                    </div>
                </div>


                <div class="row" id="dashboard-grid">
                    <div class="col-md-6 col-lg-4">
                        <div class="card border-info mb-3">
                            <div class="card-header card-handle bg-info bg-opacity-10 d-flex align-items-center">
                                <h6 class="mb-0"><i class="bi bi-robot"></i> AIè¨­å®š</h6>
                            </div>

                            <div class="card-body">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch"
                                        id="checkbox_auto_response" checked>
                                    <label class="small form-check-label" for="checkbox_auto_response"
                                        id="label_auto_response">
                                        ã€Œç±³å¤ªéƒã€ã‚’å«ã‚€ã‚³ãƒ¡ãƒ³ãƒˆã«è‡ªå‹•å¿œç­”
                                    </label>
                                </div>
                                <hr>
                                <div class="input-group mb-3">
                                    <span class="input-group-text">LM Studio URL</span>
                                    <input class="form-control" type="text" id="text_lm_studio_url"
                                        value="http://127.0.0.1:1234/v1">
                                    <button class="btn btn-outline-secondary" id="button_test_lm_studio">ãƒ†ã‚¹ãƒˆ</button>
                                </div>


                                <div class="input-group mb-3">
                                    <span class="input-group-text">AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆå</span>
                                    <input class="form-control" type="text" id="text_ai_name"
                                        placeholder="AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆåã‚’å…¥åŠ›">
                                </div>

                                <div class="input-group mb-3">
                                    <span class="input-group-text">æ–‡å­—ç§»å‹•æ–¹å‘</span>
                                    <select class="form-select" id="select_text_direction">
                                        <option value="still">é™æ­¢</option>
                                        <option value="up">â†‘</option>
                                        <option value="down">â†“</option>
                                        <option value="left" selected>â†</option>
                                        <option value="right">â†’</option>
                                    </select>
                                    <span class="input-group-text">æ–‡å­—è‰²</span>
                                    <input type="color" class="form-control form-control-color" id="input_text_color"
                                        value="#FFD700" title="æ–‡å­—è‰²ã‚’é¸æŠ">
                                </div>

                                <div class="input-group mb-3">
                                    <span class="input-group-text">Max History</span>
                                    <input type="number" class="form-control" id="input_conversation_history_limit"
                                        value="50" min="0" max="200">
                                    <span class="input-group-text bg-light">
                                        <span id="span_current_history_count">0</span>ä»¶
                                    </span>
                                    <button class="btn btn-outline-secondary btn-sm" id="button_clear_history">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>

                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label for="textarea_system_prompt" class="form-label mb-0">äº‹å‰çŸ¥è­˜</label>
                                        <button class="btn btn-sm btn-outline-secondary"
                                            id="button_reset_system_prompt">
                                            <i class="bi bi-arrow-clockwise"></i>
                                        </button>
                                    </div>
                                    <textarea class="form-control" id="textarea_system_prompt" rows="4"
                                        placeholder="AIã®å½¹å‰²ã‚„æŒ¯ã‚‹èˆã„ã€äº‹å‰çŸ¥è­˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">ã‚ãªãŸã®åå‰ã¯{AI_NAME}ã§ã™ã€‚è¦ªã—ã¿ã‚„ã™ãè¦ªåˆ‡ãªAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ã‚³ãƒ¡ãƒ³ãƒˆç”»é¢ã«æµã‚Œã‚‹ãŸã‚ã€è¿”ç­”ã¯å¿…ãš120æ–‡å­—ä»¥å†…ã®çŸ­ã„ä¸€æ–‡ã§ãŠç­”ãˆãã ã•ã„ã€‚</textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-4">
                        <div class="card border-success mb-3">
                            <div class="card-header card-handle bg-success bg-opacity-10 d-flex align-items-center">
                                <h6 class="mb-0"><i class="bi bi-mic-fill"></i> éŸ³å£°èªè­˜</h6>
                            </div>
                            <div class="card-body">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="checkbox_ai_name_auto_response"
                                        checked>
                                    <label class="form-check-label small" for="checkbox_ai_name_auto_response"
                                        id="label_ai_name_auto_response">
                                        ã€Œç±³å¤ªéƒã€ã‚’å«ã‚€éŸ³å£°èªè­˜ã‚’è‡ªå‹•ã§AIã«é€ä¿¡
                                    </label>
                                </div>
                                <hr>
                                <div class="input-group mb-3">
                                    <span class="input-group-text">ãƒã‚¤ã‚¯é¸æŠ</span>
                                    <select class="form-select" id="select_microphone">
                                        <option value="">ãƒã‚¤ã‚¯ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                                    </select>
                                    <button class="btn btn-outline-secondary" id="button_refresh_mics">æ›´æ–°</button>
                                </div>

                                <div class="input-group mb-3">
                                    <span class="input-group-text">è¨€èª</span>
                                    <select class="form-select" id="select_speech_language">
                                        <option value="ja-JP">æ—¥æœ¬èª</option>
                                        <option value="en-US">English (US)</option>
                                        <option value="en-GB">English (UK)</option>
                                        <option value="zh-CN">ä¸­æ–‡ (ç®€ä½“)</option>
                                        <option value="ko-KR">í•œêµ­ì–´</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label for="input_speech_interim" class="form-label mb-0">
                                            ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ èªè­˜
                                            <small class="text-muted">(æš«å®šçµæœ)</small>
                                        </label>
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-sm btn-success" id="button_start_speech">
                                                <i class="bi bi-mic"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger" id="button_stop_speech" disabled>
                                                <i class="bi bi-mic-mute"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <input type="text" class="form-control bg-light" id="input_speech_interim"
                                        placeholder="éŸ³å£°èªè­˜ä¸­ã®æš«å®šçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™" readonly>
                                </div>

                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label for="textarea_speech_result" class="form-label mb-0">
                                            ç¢ºå®šçµæœ
                                        </label>
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-sm btn-outline-primary" id="button_download_speech">
                                                <i class="bi bi-download"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-secondary" id="button_clear_speech">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <textarea class="form-control" id="textarea_speech_result" rows="4"
                                        placeholder="ç¢ºå®šã—ãŸéŸ³å£°èªè­˜ã®çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™" readonly></textarea>
                                </div>

                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="checkbox_continuous_speech"
                                        checked>
                                    <label class="form-check-label" for="checkbox_continuous_speech">
                                        é€£ç¶šèªè­˜ãƒ¢ãƒ¼ãƒ‰
                                    </label>
                                </div>



                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-4">
                        <div class="card border-warning mb-3">
                            <div class="card-header card-handle bg-warning bg-opacity-10 d-flex align-items-center">
                                <h6 class="mb-0"><i class="bi bi-send-fill"></i> è‡ªå‹•æŠ•ç¨¿æ©Ÿèƒ½ï¼ˆæˆæ¥­ç››ã‚Šä¸Šã’ï¼‰</h6>
                            </div>
                            <div class="card-body">
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" id="checkbox_auto_posting">
                                    <label class="small form-check-label" for="checkbox_auto_posting">
                                        å®šæœŸçš„ã«è‡ªå‹•ã§ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
                                    </label>
                                </div>

                                <div class="row mb-2">
                                    <div class="col-6">
                                        <label for="range_posting_interval_min" class="form-label">æœ€å°é–“éš”ï¼ˆåˆ†ï¼‰</label>
                                        <input type="range" class="form-range" id="range_posting_interval_min" min="1"
                                            max="10" value="2">
                                        <small class="text-muted"><span id="span_interval_min">2</span>åˆ†</small>
                                    </div>
                                    <div class="col-6">
                                        <label for="range_posting_interval_max" class="form-label">æœ€å¤§é–“éš”ï¼ˆåˆ†ï¼‰</label>
                                        <input type="range" class="form-range" id="range_posting_interval_max" min="5"
                                            max="20" value="8">
                                        <small class="text-muted"><span id="span_interval_max">8</span>åˆ†</small>
                                    </div>
                                </div>
                                <hr>

                                <div class="mb-2">
                                    <label for="select_posting_style" class="form-label">æŠ•ç¨¿ã‚¹ã‚¿ã‚¤ãƒ«</label>
                                    <select class="form-select form-select-sm" id="select_posting_style">
                                        <option value="mixed">ãƒŸãƒƒã‚¯ã‚¹ï¼ˆæˆæ¥­é–¢é€£ï¼‹é›‘è«‡ï¼‰</option>
                                        <option value="academic">æˆæ¥­é–¢é€£ã®ã¿</option>
                                        <option value="casual">é›‘è«‡ã®ã¿</option>
                                        <option value="reaction">ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ã¿</option>
                                    </select>
                                </div>

                                <button class="btn btn-sm btn-outline-success" id="button_test_auto_posting">
                                    ãƒ†ã‚¹ãƒˆæŠ•ç¨¿
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-4">
                        <!-- ã‚³ãƒ¡ãƒ³ãƒˆãƒ­ã‚°ã‚«ãƒ¼ãƒ‰ -->
                        <div class="card mb-3">
                            <div class="card-header card-handle d-flex align-items-center">
                                <h6 class="mb-0"><i class="bi bi-chat-left-text-fill"></i> ã‚³ãƒ¡ãƒ³ãƒˆãƒ­ã‚°</h6>
                                <div class="ms-auto">
                                    <button class="btn btn-sm btn-outline-primary me-1" id="button_sync_comments"
                                        title="ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ­ã‚°ã‚’åŒæœŸ">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary me-1" id="button_download_comments"
                                        title="ãƒ­ã‚°ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">
                                        <i class="bi bi-download"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-success me-1" id="button_download_csv"
                                        title="ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥é›†è¨ˆCSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">
                                        <i class="bi bi-file-earmark-spreadsheet"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" id="button_clear_comments">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <textarea id="textarea_comment_log" readonly class="form-control" rows="6"
                                    placeholder="å—ä¿¡ã—ãŸã‚³ãƒ¡ãƒ³ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6 col-lg-4">
                        <!-- å‚åŠ è€…æ•°ã‚°ãƒ©ãƒ• -->
                        <div class="card mb-3">
                            <div class="card-header card-handle d-flex align-items-center">
                                <h6 class="mb-0">
                                    <i class="bi bi-people-fill"></i> å‚åŠ è€…æ•°ã®æ¨ç§»
                                </h6>
                                <button class="btn btn-sm btn-outline-primary ms-auto" id="button_download_user_stats">
                                    <i class="bi bi-download"></i> CSV
                                </button>
                            </div>
                            <div class="card-body">
                                <canvas id="userStatsChart" style="max-height: 300px;"></canvas>
                                <div class="text-muted small mt-2">
                                    <i class="bi bi-info-circle"></i>
                                    å‚åŠ è€…ã®å…¥é€€å®¤ãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§è¨˜éŒ²ã•ã‚Œã¾ã™
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6 col-lg-4">
                        <!-- ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆé•·ã‚°ãƒ©ãƒ• -->
                        <div class="card mb-3">
                            <div class="card-header card-handle d-flex align-items-center">
                                <h6 class="mb-0">
                                    <i class="bi bi-chat-dots"></i> AIãƒˆãƒ¼ã‚¯ãƒ³æ•°ã®æ¨ç§»
                                </h6>
                                <button class="btn btn-sm btn-outline-primary ms-auto"
                                    id="button_download_context_stats">
                                    <i class="bi bi-download"></i> CSV
                                </button>
                            </div>
                            <div class="card-body">
                                <canvas id="contextStatsChart" style="max-height: 300px;"></canvas>
                                <div class="text-muted small mt-2">
                                    <i class="bi bi-info-circle"></i>
                                    LM Studioã«é€ä¿¡ã™ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³æ•°ï¼ˆæ¨å®šï¼‰ãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§è¨˜éŒ²ã•ã‚Œã¾ã™
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6 col-lg-4">
                        <!-- æ´»å‹•ãƒ­ã‚° -->
                        <div class="card mb-3">
                            <div class="card-header card-handle d-flex align-items-center">
                                <h6 class="mb-0"><i class="bi bi-list-ul"></i> æ´»å‹•ãƒ­ã‚°</h6>
                                <button class="btn btn-sm btn-outline-secondary ms-auto" id="button_clear_log">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="log-container" class="log-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


    </div>
    </div>

    <hr>

    <footer class="page-footer font-small">
        <div class="footer-copyright small text-center">
            Commentable Kometaro AI Assistant<br>
            &copy; 2025 <a href="https://tetsuakibaba.jp">Tetsuaki Baba</a>
        </div>
    </footer>
    </div>

    <!-- Scripts -->
    <!-- <script src="../p5.min.js"></script> -->
    <script src="/socket.io/socket.io.js"></script>

    <script>
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        const DEFAULT_SYSTEM_PROMPT = 'ã‚ãªãŸã®åå‰ã¯{AI_NAME}ã§ã™ã€‚è¦ªã—ã¿ã‚„ã™ãè¦ªåˆ‡ãªAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ã‚ãªãŸã®ã‚³ãƒ¡ãƒ³ãƒˆã¯é…ä¿¡è€…è¡¨ç¤ºã«æµã‚Œã‚‹ãŸã‚ã€è¿”ç­”ã¯å¿…ãš120æ–‡å­—ä»¥å†…ã®çŸ­ã„ä¸€æ–‡ã§ãŠç­”ãˆãã ã•ã„ã€‚';

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let socket;
        let isConnected = false;
        let isAutoResponse = true;
        let isAutoPosting = false;
        let autoPostingTimer = null;
        let lmStudioUrl = 'http://127.0.0.1:1234/v1';
        let aiName = localStorage.getItem('aiAssistantName') || 'ç±³å¤ªéƒ';
        let aiTextDirection = 'left';
        let aiTextColor = '#FFD700';
        let roomName = '';
        let postingIntervalMin = 2; // åˆ†
        let postingIntervalMax = 8; // åˆ†
        let postingStyle = 'mixed';

        // éŸ³å£°èªè­˜é–¢é€£ã®å¤‰æ•°
        let speechRecognition = null;
        let isRecognizing = false;
        let recognitionLanguage = 'ja-JP';
        let isContinuous = true;
        // isAutoSendSpeech removed per user request
        let isAiNameAutoResponse = true; // AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆåã‚’å«ã‚€éŸ³å£°èªè­˜ã®è‡ªå‹•å¿œç­”
        let selectedMicrophoneId = null;
        let conversationHistory = []; // ä¼šè©±å±¥æ­´ã‚’ä¿å­˜
        let conversationHistoryLimit = 50; // å±¥æ­´ä¿å­˜æ•°ã®ä¸Šé™
        let commentLog = []; // ã‚³ãƒ¡ãƒ³ãƒˆãƒ­ã‚°ã‚’ä¿å­˜ï¼ˆè¡¨ç¤ºç”¨ãƒ†ã‚­ã‚¹ãƒˆï¼‰
        let commentLogJSON = []; // ã‚³ãƒ¡ãƒ³ãƒˆãƒ­ã‚°ã®JSONå½¢å¼ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨ï¼‰
        let commentCount = 0; // æŠ•ç¨¿ã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ

        // å‚åŠ è€…æ•°çµ±è¨ˆé–¢é€£ã®å¤‰æ•°
        let userStatsChart = null;
        let userStatsHistory = []; // { timestamp, count } ã®é…åˆ—

        // ãƒˆãƒ¼ã‚¯ãƒ³æ•°çµ±è¨ˆé–¢é€£ã®å¤‰æ•°
        let contextStatsChart = null;
        let contextStatsHistory = []; // { timestamp, tokens } ã®é…åˆ—

        // DOMè¦ç´ 
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        const logContainer = document.getElementById('log-container');
        const textRoomName = document.getElementById('text_room_name');
        const textLmStudioUrl = document.getElementById('text_lm_studio_url');
        const textAiName = document.getElementById('text_ai_name');
        const selectTextDirection = document.getElementById('select_text_direction');
        const inputTextColor = document.getElementById('input_text_color');
        const textareaSystemPrompt = document.getElementById('textarea_system_prompt');
        const buttonResetSystemPrompt = document.getElementById('button_reset_system_prompt');
        const checkboxAutoResponse = document.getElementById('checkbox_auto_response');
        const buttonConnect = document.getElementById('button_connect');
        const buttonClearLog = document.getElementById('button_clear_log');
        const buttonTestLMStudio = document.getElementById('button_test_lm_studio');

        // è‡ªå‹•æŠ•ç¨¿é–¢é€£ã®DOMè¦ç´ 
        const checkboxAutoPosting = document.getElementById('checkbox_auto_posting');
        const rangePostingIntervalMin = document.getElementById('range_posting_interval_min');
        const rangePostingIntervalMax = document.getElementById('range_posting_interval_max');
        const spanIntervalMin = document.getElementById('span_interval_min');
        const spanIntervalMax = document.getElementById('span_interval_max');
        const selectPostingStyle = document.getElementById('select_posting_style');
        const buttonTestAutoPosting = document.getElementById('button_test_auto_posting');

        // éŸ³å£°èªè­˜é–¢é€£ã®DOMè¦ç´ 
        const selectMicrophone = document.getElementById('select_microphone');
        const buttonRefreshMics = document.getElementById('button_refresh_mics');
        const selectSpeechLanguage = document.getElementById('select_speech_language');
        const buttonStartSpeech = document.getElementById('button_start_speech');
        const buttonStopSpeech = document.getElementById('button_stop_speech');
        const buttonClearSpeech = document.getElementById('button_clear_speech');
        const buttonDownloadSpeech = document.getElementById('button_download_speech');
        const inputSpeechInterim = document.getElementById('input_speech_interim');
        const textareaSpeechResult = document.getElementById('textarea_speech_result');
        const checkboxContinuousSpeech = document.getElementById('checkbox_continuous_speech');
        const checkboxAiNameAutoResponse = document.getElementById('checkbox_ai_name_auto_response');
        const labelAiNameAutoResponse = document.getElementById('label_ai_name_auto_response');
        const inputConversationHistoryLimit = document.getElementById('input_conversation_history_limit');
        const spanCurrentHistoryCount = document.getElementById('span_current_history_count');
        const buttonClearHistory = document.getElementById('button_clear_history');

        // ã‚³ãƒ¡ãƒ³ãƒˆãƒ­ã‚°é–¢é€£ã®DOMè¦ç´ 
        const textareaCommentLog = document.getElementById('textarea_comment_log');
        const buttonDownloadComments = document.getElementById('button_download_comments');
        const buttonDownloadCsv = document.getElementById('button_download_csv');
        const buttonClearComments = document.getElementById('button_clear_comments');

        // URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãƒ«ãƒ¼ãƒ åã‚’è¨­å®š
        function getURLParams() {
            const params = new URLSearchParams(window.location.search);
            const result = {};
            for (const [key, value] of params) {
                result[key] = value;
            }
            return result;
        }

        // AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆåã‚’localStorageã«ä¿å­˜
        function saveAiName(name) {
            if (name && name.trim() !== '') {
                localStorage.setItem('aiAssistantName', name.trim());
                addLog(`AIåã€Œ${name.trim()}ã€ã‚’ä¿å­˜ã—ã¾ã—ãŸ`, 'info');
            }
        }

        // AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆåã‚’localStorageã‹ã‚‰å–å¾—
        function loadAiName() {
            const savedName = localStorage.getItem('aiAssistantName');
            if (savedName) {
                addLog(`ä¿å­˜ã•ã‚ŒãŸAIåã€Œ${savedName}ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`, 'info');
                return savedName;
            }
            return 'ç±³å¤ªéƒ'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
        }

        // ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’localStorageã«ä¿å­˜
        function saveSystemPrompt(prompt) {
            if (prompt && prompt.trim() !== '') {
                localStorage.setItem('systemPrompt', prompt.trim());
                addLog('ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'info');
            }
        }

        // ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’localStorageã‹ã‚‰å–å¾—
        function loadSystemPrompt() {
            const savedPrompt = localStorage.getItem('systemPrompt');
            if (savedPrompt) {
                addLog('ä¿å­˜ã•ã‚ŒãŸã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'info');
                return savedPrompt;
            }
            return DEFAULT_SYSTEM_PROMPT; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
        }

        // ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ãƒªã‚»ãƒƒãƒˆ
        function resetSystemPrompt() {
            textareaSystemPrompt.value = DEFAULT_SYSTEM_PROMPT;
            localStorage.removeItem('systemPrompt');
            addLog('ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ', 'info');
        }

        // å‚åŠ è€…æ•°ã‚°ãƒ©ãƒ•ã®åˆæœŸåŒ–
        function initUserStatsChart() {
            const ctx = document.getElementById('userStatsChart').getContext('2d');
            userStatsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'å‚åŠ è€…æ•°',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            ticks: {
                                maxTicksLimit: 10
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }

        // ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚°ãƒ©ãƒ•ã®åˆæœŸåŒ–
        function initContextStatsChart() {
            const ctx = document.getElementById('contextStatsChart').getContext('2d');
            contextStatsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'ãƒˆãƒ¼ã‚¯ãƒ³æ•°ï¼ˆæ¨å®šï¼‰',
                        data: [],
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 200
                            }
                        },
                        x: {
                            ticks: {
                                maxTicksLimit: 10
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }

        // å‚åŠ è€…æ•°ã®æ›´æ–°
        function updateUserStats(count) {
            const timestamp = new Date();
            const timeString = timestamp.toLocaleTimeString('ja-JP');

            // å±¥æ­´ã«è¿½åŠ 
            userStatsHistory.push({
                timestamp: timestamp.toISOString(),
                count: count
            });

            // ã‚°ãƒ©ãƒ•ã«è¿½åŠ 
            if (userStatsChart) {
                userStatsChart.data.labels.push(timeString);
                userStatsChart.data.datasets[0].data.push(count);

                // æœ€å¤§50ãƒã‚¤ãƒ³ãƒˆã«åˆ¶é™
                if (userStatsChart.data.labels.length > 50) {
                    userStatsChart.data.labels.shift();
                    userStatsChart.data.datasets[0].data.shift();
                }

                userStatsChart.update();
            }
        }

        // ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã®æ›´æ–°
        function updateContextStats(tokens) {
            const timestamp = new Date();
            const timeString = timestamp.toLocaleTimeString('ja-JP');

            // å±¥æ­´ã«è¿½åŠ 
            contextStatsHistory.push({
                timestamp: timestamp.toISOString(),
                tokens: tokens
            });

            // ã‚°ãƒ©ãƒ•ã«è¿½åŠ 
            if (contextStatsChart) {
                contextStatsChart.data.labels.push(timeString);
                contextStatsChart.data.datasets[0].data.push(tokens);

                // æœ€å¤§50ãƒã‚¤ãƒ³ãƒˆã«åˆ¶é™
                if (contextStatsChart.data.labels.length > 50) {
                    contextStatsChart.data.labels.shift();
                    contextStatsChart.data.datasets[0].data.shift();
                }

                contextStatsChart.update();
            }
        }

        // å‚åŠ è€…æ•°çµ±è¨ˆã®CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadUserStatsCSV() {
            if (userStatsHistory.length === 0) {
                alert('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            // CSVãƒ˜ãƒƒãƒ€ãƒ¼
            let csvContent = 'ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—,å‚åŠ è€…æ•°\n';

            // ãƒ‡ãƒ¼ã‚¿è¡Œ
            userStatsHistory.forEach(item => {
                const timestamp = new Date(item.timestamp).toLocaleString('ja-JP');
                csvContent += `${timestamp},${item.count}\n`;
            });

            // BOMã‚’è¿½åŠ ã—ã¦Excelã§æ­£ã—ãé–‹ã‘ã‚‹ã‚ˆã†ã«ã™ã‚‹
            const bom = '\uFEFF';
            const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `å‚åŠ è€…æ•°çµ±è¨ˆ_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();
            URL.revokeObjectURL(url);

            addLog('å‚åŠ è€…æ•°çµ±è¨ˆã‚’CSVã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'info');
        }

        // ãƒˆãƒ¼ã‚¯ãƒ³æ•°çµ±è¨ˆã®CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadContextStatsCSV() {
            if (contextStatsHistory.length === 0) {
                alert('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            // CSVãƒ˜ãƒƒãƒ€ãƒ¼
            let csvContent = 'ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—,ãƒˆãƒ¼ã‚¯ãƒ³æ•°ï¼ˆæ¨å®šï¼‰\n';

            // ãƒ‡ãƒ¼ã‚¿è¡Œ
            contextStatsHistory.forEach(item => {
                const timestamp = new Date(item.timestamp).toLocaleString('ja-JP');
                csvContent += `${timestamp},${item.tokens}\n`;
            });

            // BOMã‚’è¿½åŠ ã—ã¦Excelã§æ­£ã—ãé–‹ã‘ã‚‹ã‚ˆã†ã«ã™ã‚‹
            const bom = '\uFEFF';
            const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ãƒˆãƒ¼ã‚¯ãƒ³æ•°çµ±è¨ˆ_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();
            URL.revokeObjectURL(url);

            addLog('ãƒˆãƒ¼ã‚¯ãƒ³æ•°çµ±è¨ˆã‚’CSVã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'info');
        }

        // ä¼šè©±å±¥æ­´ã‚’æ–‡å­—åˆ—ã¨ã—ã¦æ•´å½¢
        function formatConversationHistory() {
            if (conversationHistory.length === 0) {
                return "ã“ã‚Œã¾ã§ã®ä¼šè©±å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
            }
            const recentHistory = conversationHistory; // å…¨ã¦ã®å±¥æ­´ã‚’ä½¿ç”¨
            const formattedHistory = recentHistory.map(item => {
                const time = new Date(item.timestamp).toLocaleTimeString();
                if (item.type === 'user') {
                    return `[${time}] ${item.content}`;
                } else {
                    return `[${time}] ${aiName}: ${item.content}`;
                }
            }).join('\n');

            return `ã“ã‚Œã¾ã§ã®ä¼šè©±å±¥æ­´:\n${formattedHistory}`;
        }

        // ã‚³ãƒ¡ãƒ³ãƒˆãƒ­ã‚°ã«è¿½åŠ 
        function addToCommentLog(data) {
            const timestamp = new Date();
            commentCount++; // ã‚³ãƒ¡ãƒ³ãƒˆæ•°ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ

            // JSONå½¢å¼ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨ï¼‰
            const jsonData = {
                timestamp: data.timestamp || timestamp.toISOString(),
                room: data.room || roomName || 'unknown',
                username: data.my_name || data.name || 'åŒ¿å',
                comment: data.comment || '',
                emoji: data.flg_emoji || false,
                sound: data.flg_sound || false,
                socketid: data.socketid || '',
                source: data.source || 'comment' // 'speech' or 'comment'
            };
            commentLogJSON.push(jsonData);

            // å½¢å¼: [2025:08:26:21:06:19-0005] ğŸ˜® [sound][åŒ¿å]
            const year = timestamp.getFullYear();
            const month = String(timestamp.getMonth() + 1).padStart(2, '0');
            const day = String(timestamp.getDate()).padStart(2, '0');
            const hour = String(timestamp.getHours()).padStart(2, '0');
            const minute = String(timestamp.getMinutes()).padStart(2, '0');
            const second = String(timestamp.getSeconds()).padStart(2, '0');
            const commentCountStr = String(commentCount).padStart(4, '0');
            const timeStr = `${year}:${month}:${day}:${hour}:${minute}:${second}-${commentCountStr}`;

            let content = '';
            let extraInfo = '';

            // ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹ã®å‡¦ç†
            if (data.flg_emoji && data.comment) {
                // çµµæ–‡å­—ã®å ´åˆ
                content = data.comment;
                extraInfo = data.flg_sound ? '[sound]' : '';
            } else if (data.comment) {
                // é€šå¸¸ã®ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ¡ãƒ³ãƒˆã®å ´åˆ
                content = data.comment;
            }

            const logEntry = `[${timeStr}] ${content} ${extraInfo}[${data.my_name || data.name || 'åŒ¿å'}]`.trim();
            commentLog.push(logEntry);

            // textareaã‚’æ›´æ–°
            textareaCommentLog.value = commentLog.join('\n');
            textareaCommentLog.scrollTop = textareaCommentLog.scrollHeight;
        }

        // ã‚³ãƒ¡ãƒ³ãƒˆãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢
        function clearCommentLog() {
            commentLog = [];
            commentLogJSON = [];
            commentCount = 0; // ã‚³ãƒ¡ãƒ³ãƒˆæ•°ã‚‚ãƒªã‚»ãƒƒãƒˆ
            textareaCommentLog.value = '';
            addLog('ã‚³ãƒ¡ãƒ³ãƒˆãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'info');
        }

        // ã‚³ãƒ¡ãƒ³ãƒˆãƒ­ã‚°ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadCommentLog() {
            if (commentLogJSON.length === 0) {
                addLog('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“', 'info');
                return;
            }

            // JSON Lineså½¢å¼ï¼ˆå„è¡ŒãŒ1ã¤ã®JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰ã§å‡ºåŠ›
            const jsonLines = commentLogJSON.map(item => JSON.stringify(item)).join('\n');

            const currentTime = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            const roomPrefix = roomName ? `${roomName}_` : '';
            const filename = `${roomPrefix}${currentTime}.log`;

            const blob = new Blob([jsonLines], { type: 'application/json;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            addLog(`ã‚³ãƒ¡ãƒ³ãƒˆãƒ­ã‚°ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ: ${filename}`, 'info');
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥é›†è¨ˆCSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadCommentCsv() {
            if (commentLogJSON.length === 0) {
                addLog('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“', 'info');
                return;
            }

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«é›†è¨ˆ
            const userStats = {};

            commentLogJSON.forEach(entry => {
                const username = entry.username || 'åŒ¿å';

                if (!userStats[username]) {
                    userStats[username] = {
                        comments: [],
                        emojiCount: 0,
                        textCount: 0,
                        firstTimestamp: entry.timestamp,
                        lastTimestamp: entry.timestamp
                    };
                }

                const stats = userStats[username];
                stats.comments.push(entry.comment);

                // çµµæ–‡å­—ã‹ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                if (entry.emoji) {
                    stats.emojiCount++;
                } else {
                    stats.textCount++;
                }

                // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æ›´æ–°
                if (new Date(entry.timestamp) < new Date(stats.firstTimestamp)) {
                    stats.firstTimestamp = entry.timestamp;
                }
                if (new Date(entry.timestamp) > new Date(stats.lastTimestamp)) {
                    stats.lastTimestamp = entry.timestamp;
                }
            });

            // CSVãƒ˜ãƒƒãƒ€ãƒ¼
            let csvContent = 'å­¦ä¿®ç•ªå·/æŠ•ç¨¿è€…,ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰,ã‚³ãƒ¡ãƒ³ãƒˆæ•°,çµµæ–‡å­—æ•°,ãƒ†ã‚­ã‚¹ãƒˆæ•°,æœ€åˆã®æŠ•ç¨¿æ™‚åˆ»,æœ€å¾Œã®æŠ•ç¨¿æ™‚åˆ»\n';

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«CSVè¡Œã‚’ç”Ÿæˆ
            Object.entries(userStats).forEach(([username, stats]) => {
                const commentsStr = stats.comments.join(', ');
                const totalCount = stats.emojiCount + stats.textCount;

                // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                const formatTimestamp = (isoString) => {
                    const date = new Date(isoString);
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hour = String(date.getHours()).padStart(2, '0');
                    const minute = String(date.getMinutes()).padStart(2, '0');
                    const second = String(date.getSeconds()).padStart(2, '0');
                    return `${year}:${month}:${day}:${hour}:${minute}:${second}`;
                };

                const firstTime = formatTimestamp(stats.firstTimestamp);
                const lastTime = formatTimestamp(stats.lastTimestamp);

                // CSVã®å€¤ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼ˆã‚«ãƒ³ãƒã‚„æ”¹è¡Œã€ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã‚’å«ã‚€å ´åˆï¼‰
                const escapeCsv = (str) => {
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return `"${str.replace(/"/g, '""')}"`;
                    }
                    return str;
                };

                csvContent += `${escapeCsv(username)},${escapeCsv(commentsStr)},${totalCount},${stats.emojiCount},${stats.textCount},${firstTime},${lastTime}\n`;
            });

            // CSVãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            const currentTime = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            const roomPrefix = roomName ? `${roomName}_` : '';
            const filename = `${roomPrefix}user_stats_${currentTime}.csv`;

            // BOMï¼ˆByte Order Markï¼‰ã‚’è¿½åŠ ã—ã¦UTF-8ã§æ–‡å­—åŒ–ã‘ã‚’é˜²ã
            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            const blob = new Blob([bom, csvContent], { type: 'text/csv;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            addLog(`ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥é›†è¨ˆCSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ: ${filename}`, 'info');
        }

        // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã‚³ãƒ¡ãƒ³ãƒˆãƒ­ã‚°ã‚’åŒæœŸ
        async function syncCommentsFromServer(showAlert = true) {
            try {
                const roomName = textRoomName.value.trim();

                if (!roomName) {
                    if (showAlert) {
                        alert('éƒ¨å±‹åãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                    }
                    addLog('åŒæœŸå¤±æ•—: éƒ¨å±‹åãŒæœªè¨­å®š', 'error');
                    return;
                }

                // ãƒ•ã‚¡ã‚¤ãƒ«åã¨ã—ã¦å®‰å…¨ãªæ–‡å­—åˆ—ã«å¤‰æ›
                const safeRoomName = roomName.replace(/[^a-zA-Z0-9_-]/g, '_');

                addLog(`ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ­ã‚°ã‚’åŒæœŸä¸­: ${roomName}`, 'info');

                // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ã‚’å–å¾—
                const response = await fetch(`/chatlogs/${safeRoomName}.log`);

                if (!response.ok) {
                    if (response.status === 404) {
                        if (showAlert) {
                            alert('ã¾ã ã“ã®éƒ¨å±‹ã®ãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
                        }
                        addLog('åŒæœŸ: ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'info');
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const logContent = await response.text();
                const lines = logContent.trim().split('\n').filter(line => line.length > 0);

                // commentLogã¨commentLogJSONã‚’ã‚¯ãƒªã‚¢ã—ã¦ã€ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã—ãŸãƒ­ã‚°ã§ç½®ãæ›ãˆ
                commentLog = [];
                commentLogJSON = [];
                conversationHistory = []; // ä¼šè©±å±¥æ­´ã‚‚ã‚¯ãƒªã‚¢
                let maxCount = 0;

                lines.forEach((line, index) => {
                    try {
                        // ç©ºè¡Œã‚„ä¸æ­£ãªè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
                        const trimmedLine = line.trim();
                        if (!trimmedLine || !trimmedLine.startsWith('{')) {
                            return;
                        }

                        const entry = JSON.parse(trimmedLine);

                        // JSONå½¢å¼ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨ï¼‰
                        commentLogJSON.push(entry);

                        const timestamp = new Date(entry.timestamp);
                        const year = timestamp.getFullYear();
                        const month = String(timestamp.getMonth() + 1).padStart(2, '0');
                        const day = String(timestamp.getDate()).padStart(2, '0');
                        const hour = String(timestamp.getHours()).padStart(2, '0');
                        const minute = String(timestamp.getMinutes()).padStart(2, '0');
                        const second = String(timestamp.getSeconds()).padStart(2, '0');

                        // ã‚«ã‚¦ãƒ³ãƒˆã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
                        maxCount++;
                        const commentCountStr = String(maxCount).padStart(4, '0');
                        const timeStr = `${year}:${month}:${day}:${hour}:${minute}:${second}-${commentCountStr}`;

                        const emoji = entry.emoji ? '' : '';
                        const sound = entry.sound ? '[sound]' : '';
                        const formattedLine = `[${timeStr}] ${entry.comment} ${emoji}${sound}[${entry.username}]`.trim();
                        commentLog.push(formattedLine);

                        // ä¼šè©±å±¥æ­´ã«è¿½åŠ ï¼ˆAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆè‡ªèº«ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯é™¤å¤–ï¼‰
                        if (entry.username !== aiName) {
                            // çµµæ–‡å­—ã®ã¿ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯ä¼šè©±å±¥æ­´ã‹ã‚‰é™¤å¤–
                            if (!entry.emoji) {
                                // sourceãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§è©±è€…ã‚’åˆ¤åˆ¥ï¼ˆspeech=é…ä¿¡è€…, comment=å‚åŠ è€…ï¼‰
                                const speaker = entry.source === 'speech' ? 'é…ä¿¡è€…' : 'å‚åŠ è€…';
                                // éŸ³å£°èªè­˜ï¼ˆé…ä¿¡è€…ï¼‰ã®å ´åˆã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼åãªã—ã€ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆå‚åŠ è€…ï¼‰ã®å ´åˆã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚ã‚Š
                                const content = entry.source === 'speech'
                                    ? entry.comment
                                    : `${entry.username}: ${entry.comment}`;
                                conversationHistory.push({
                                    type: 'user',
                                    content: content,
                                    timestamp: entry.timestamp,
                                    speaker: speaker
                                });
                            }
                        } else {
                            // AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆè‡ªèº«ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯assistantã¨ã—ã¦è¿½åŠ ï¼ˆçµµæ–‡å­—ã®ã¿ã¯é™¤å¤–ï¼‰
                            if (!entry.emoji) {
                                conversationHistory.push({
                                    type: 'assistant',
                                    content: entry.comment,
                                    timestamp: entry.timestamp
                                });
                            }
                        }
                    } catch (e) {
                        console.warn(`Skipping invalid log entry at line ${index + 1}:`, line.substring(0, 100), e.message);
                    }
                });

                // ä¼šè©±å±¥æ­´ãŒä¸Šé™ã‚’è¶…ãˆã¦ã„ã‚‹å ´åˆã¯æœ€æ–°ã®ã‚‚ã®ã ã‘æ®‹ã™
                if (conversationHistory.length > conversationHistoryLimit) {
                    conversationHistory = conversationHistory.slice(-conversationHistoryLimit);
                    addLog(`ä¼šè©±å±¥æ­´ã‚’æœ€æ–°${conversationHistoryLimit}ä»¶ã«èª¿æ•´ã—ã¾ã—ãŸ`, 'info');
                }

                // commentCountã‚’æ›´æ–°
                commentCount = maxCount;

                // textareaã‚’æ›´æ–°
                textareaCommentLog.value = commentLog.join('\n');
                textareaCommentLog.scrollTop = textareaCommentLog.scrollHeight;

                // ä¼šè©±å±¥æ­´æ•°ã‚’æ›´æ–°
                updateCurrentHistoryCount();

                addLog(`${lines.length}ä»¶ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’åŒæœŸã—ã¾ã—ãŸï¼ˆä¼šè©±å±¥æ­´: ${conversationHistory.length}ä»¶ï¼‰`, 'info');

            } catch (error) {
                console.error('Error syncing comments:', error);
                if (showAlert) {
                    alert('ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã®åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                }
                addLog(`åŒæœŸã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // ãƒ­ã‚°å‡ºåŠ›é–¢æ•°
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateStatus(status, text) {
            statusIndicator.className = `status-indicator status-${status}`;
            statusText.textContent = text;
        }

        // è‡ªå‹•æŠ•ç¨¿ç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ
        function generateAutoPostPrompt(style) {
            const prompts = {
                mixed: [
                    "æˆæ¥­ã®é›°å›²æ°—ã‚’ç››ã‚Šä¸Šã’ã‚‹ã‚ˆã†ãªçŸ­ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’ã—ã¦ãã ã•ã„ã€‚",
                    "å­¦ç”ŸãŒèˆˆå‘³ã‚’æŒã¡ãã†ãªé›‘è«‡ã‚’120æ–‡å­—ä»¥å†…ã§ã—ã¦ãã ã•ã„ã€‚",
                    "æˆæ¥­ã«é–¢é€£ã™ã‚‹é¢ç™½ã„è±†çŸ¥è­˜ã‚’çŸ­ãæ•™ãˆã¦ãã ã•ã„ã€‚",
                    "ä»Šæ—¥ã®æ°—åˆ†ã‚„å¤©æ°—ã«ã¤ã„ã¦è»½ãã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãã ã•ã„ã€‚",
                    "å‹‰å¼·ã®ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ãŒä¸ŠãŒã‚‹ã‚ˆã†ãªå¿œæ´ã‚³ãƒ¡ãƒ³ãƒˆã‚’ã—ã¦ãã ã•ã„ã€‚"
                ],
                academic: [
                    "æˆæ¥­ã«é–¢é€£ã™ã‚‹èˆˆå‘³æ·±ã„è©±é¡Œã‚’120æ–‡å­—ä»¥å†…ã§æä¾›ã—ã¦ãã ã•ã„ã€‚",
                    "å­¦ç¿’ã«å½¹ç«‹ã¤è±†çŸ¥è­˜ã‚’çŸ­ãæ•™ãˆã¦ãã ã•ã„ã€‚",
                    "æˆæ¥­ã®å†…å®¹ã«é–¢é€£ã™ã‚‹è³ªå•ã‚’æŠ•ã’ã‹ã‘ã¦ãã ã•ã„ã€‚",
                    "å­¦ç¿’ã®ã‚³ãƒ„ã‚’çŸ­ãã‚¢ãƒ‰ãƒã‚¤ã‚¹ã—ã¦ãã ã•ã„ã€‚"
                ],
                casual: [
                    "ä»Šæ—¥ã®æ°—åˆ†ã«ã¤ã„ã¦è»½ãã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãã ã•ã„ã€‚",
                    "å­£ç¯€ã‚„å¤©æ°—ã«ã¤ã„ã¦çŸ­ãè©±ã—ã¦ãã ã•ã„ã€‚",
                    "é¢ç™½ã„é›‘è«‡ã‚’120æ–‡å­—ä»¥å†…ã§ã—ã¦ãã ã•ã„ã€‚",
                    "å­¦ç”Ÿç”Ÿæ´»ã®è©±é¡Œã§è»½ãç››ã‚Šä¸Šã’ã¦ãã ã•ã„ã€‚"
                ],
                reaction: "REACTION_MODE" // ç‰¹åˆ¥ãªãƒãƒ¼ã‚«ãƒ¼
            };

            if (style === 'reaction') {
                return prompts.reaction;
            }

            const stylePrompts = prompts[style] || prompts.mixed;
            const randomPrompt = stylePrompts[Math.floor(Math.random() * stylePrompts.length)];

            // æŒ‡ç¤ºã®ã¿ã‚’è¿”ã™ï¼ˆä¼šè©±å±¥æ­´ã¯buildPrompt()ã§å‡¦ç†ã•ã‚Œã‚‹ï¼‰
            return randomPrompt;
        }

        // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³å°‚ç”¨ã®é€ä¿¡é–¢æ•°
        function sendRandomReaction() {
            // çµµæ–‡å­—ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚µã‚¤ãƒ¬ãƒ³ãƒˆï¼‰
            const emojiReactions = ['ğŸ‘', 'ğŸ™', 'ğŸ™‹', 'ğŸ¥º', 'ğŸ¤«'];

            // ã‚µã‚¦ãƒ³ãƒ‰ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆéŸ³ä»˜ãï¼‰
            const soundReactions = [
                { emoji: 'ğŸ“¸', id: 0 },  // ã‚«ãƒ¡ãƒ©
                { emoji: 'ğŸ‘', id: 1 },  // æ‹æ‰‹
                { emoji: 'ğŸ‰', id: 2 },  // ã‚¯ãƒ©ãƒƒã‚«ãƒ¼
                { emoji: 'ğŸ¥³', id: 3 },  // å¤§æ­“å£°
                { emoji: 'ğŸ˜®', id: 4 },  // ã¸ã‡ã€œ
                { emoji: 'ğŸ¤”', id: 5 },  // ã¡ã‚‡ã£ã¨ã¾ã£ã¦
                { emoji: 'ğŸ‘Œ', id: 6 },  // OK
                { emoji: 'ğŸ‘Š', id: 7 },  // ãƒ‘ãƒ³ãƒ
                { emoji: 'ğŸ¤£', id: 8 },  // å¤§ç¬‘ã„
                { emoji: 'ğŸ˜', id: 9 }   // w
            ];

            // 70%ã®ç¢ºç‡ã§çµµæ–‡å­—ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€30%ã®ç¢ºç‡ã§ã‚µã‚¦ãƒ³ãƒ‰ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³
            const useSound = Math.random() < 0.3;

            let data;
            if (useSound) {
                // ã‚µã‚¦ãƒ³ãƒ‰ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³
                const reaction = soundReactions[Math.floor(Math.random() * soundReactions.length)];
                data = {
                    my_name: aiName,
                    comment: reaction.emoji,
                    flg_emoji: true,
                    flg_sound: true,
                    id_sound: reaction.id,
                    color_text: aiTextColor,
                    color_text_stroke: '#111111',
                    text_direction: aiTextDirection,
                    flg_speech: false,
                    hidden: -1
                };
                addLog(`ã‚µã‚¦ãƒ³ãƒ‰ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡: ${reaction.emoji} (ID: ${reaction.id})`, 'sent');
            } else {
                // çµµæ–‡å­—ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³
                const emoji = emojiReactions[Math.floor(Math.random() * emojiReactions.length)];
                data = {
                    my_name: aiName,
                    comment: emoji,
                    flg_emoji: true,
                    flg_sound: false,
                    id_sound: 0,
                    color_text: aiTextColor,
                    color_text_stroke: '#111111',
                    text_direction: aiTextDirection,
                    flg_speech: false,
                    hidden: -1
                };
                addLog(`çµµæ–‡å­—ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡: ${emoji}`, 'sent');
            }

            if (socket && isConnected) {
                socket.emit('comment', data);
                // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚‚ã‚³ãƒ¡ãƒ³ãƒˆãƒ­ã‚°ã«è¿½åŠ 
                addToCommentLog(data);
            }
        }

        // è‡ªå‹•æŠ•ç¨¿ã‚’å®Ÿè¡Œ
        async function executeAutoPosting() {
            if (!isConnected || !isAutoPosting) {
                return;
            }

            try {
                addLog('è‡ªå‹•æŠ•ç¨¿ã‚’å®Ÿè¡Œä¸­...', 'info');

                if (postingStyle === 'reaction') {
                    // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯çµµæ–‡å­—/ã‚µã‚¦ãƒ³ãƒ‰ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’é€ä¿¡
                    sendRandomReaction();
                } else {
                    // ãã®ä»–ã®ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆ
                    const prompt = generateAutoPostPrompt(postingStyle);
                    const aiResponse = await sendToLMStudio(prompt);

                    // æŠ•ç¨¿
                    setTimeout(() => {
                        sendComment(aiResponse);
                        // è‡ªå‹•æŠ•ç¨¿ã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆã‚‚ä¼šè©±å±¥æ­´ã«è¿½åŠ 
                        addToConversationHistory('assistant', aiResponse);
                        addLog(`è‡ªå‹•æŠ•ç¨¿å®Œäº†: ${aiResponse}`, 'info');
                    }, 500);
                }

            } catch (error) {
                addLog(`è‡ªå‹•æŠ•ç¨¿ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }

            // æ¬¡ã®æŠ•ç¨¿ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
            scheduleNextAutoPosting();
        }        // æ¬¡ã®è‡ªå‹•æŠ•ç¨¿ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
        function scheduleNextAutoPosting() {
            if (!isAutoPosting) {
                return;
            }

            // ãƒ©ãƒ³ãƒ€ãƒ ãªé–“éš”ã‚’è¨ˆç®—ï¼ˆåˆ†å˜ä½ã‚’ãƒŸãƒªç§’ã«å¤‰æ›ï¼‰
            const minMs = postingIntervalMin * 60 * 1000;
            const maxMs = postingIntervalMax * 60 * 1000;
            const randomInterval = Math.floor(Math.random() * (maxMs - minMs)) + minMs;

            const nextPostTime = new Date(Date.now() + randomInterval);
            addLog(`æ¬¡ã®è‡ªå‹•æŠ•ç¨¿äºˆå®š: ${nextPostTime.toLocaleTimeString()} (${Math.floor(randomInterval / 60000)}åˆ†å¾Œ)`, 'info');

            autoPostingTimer = setTimeout(executeAutoPosting, randomInterval);
        }

        // è‡ªå‹•æŠ•ç¨¿ã‚’é–‹å§‹
        function startAutoPosting() {
            if (!isConnected) {
                addLog('ã‚µãƒ¼ãƒã«æ¥ç¶šã—ã¦ã‹ã‚‰è‡ªå‹•æŠ•ç¨¿ã‚’é–‹å§‹ã—ã¦ãã ã•ã„', 'error');
                checkboxAutoPosting.checked = false;
                return;
            }

            isAutoPosting = true;
            addLog('è‡ªå‹•æŠ•ç¨¿ã‚’é–‹å§‹ã—ã¾ã—ãŸ', 'info');
            scheduleNextAutoPosting();
        }

        // è‡ªå‹•æŠ•ç¨¿ã‚’åœæ­¢
        function stopAutoPosting() {
            isAutoPosting = false;
            if (autoPostingTimer) {
                clearTimeout(autoPostingTimer);
                autoPostingTimer = null;
            }
            addLog('è‡ªå‹•æŠ•ç¨¿ã‚’åœæ­¢ã—ã¾ã—ãŸ', 'info');
        }

        // ãƒ†ã‚¹ãƒˆæŠ•ç¨¿
        async function testAutoPosting() {
            if (!isConnected) {
                alert('ã‚µãƒ¼ãƒã«æ¥ç¶šã—ã¦ã‹ã‚‰ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„');
                return;
            }

            try {
                addLog('ãƒ†ã‚¹ãƒˆæŠ•ç¨¿ã‚’å®Ÿè¡Œä¸­...', 'info');

                if (postingStyle === 'reaction') {
                    // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯çµµæ–‡å­—/ã‚µã‚¦ãƒ³ãƒ‰ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’é€ä¿¡
                    sendRandomReaction();
                } else {
                    // ãã®ä»–ã®ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆ
                    const prompt = generateAutoPostPrompt(postingStyle);
                    const aiResponse = await sendToLMStudio(prompt);

                    setTimeout(() => {
                        sendComment(aiResponse);
                        addLog(`ãƒ†ã‚¹ãƒˆæŠ•ç¨¿å®Œäº†: ${aiResponse}`, 'info');
                    }, 500);
                }

            } catch (error) {
                addLog(`ãƒ†ã‚¹ãƒˆæŠ•ç¨¿ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // ãƒã‚¤ã‚¯ãƒ‡ãƒã‚¤ã‚¹ä¸€è¦§ã‚’å–å¾—
        async function refreshMicrophones() {
            // éŸ³å£°èªè­˜ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                return;
            }

            try {
                // ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’è¦æ±‚
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop()); // ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢

                // ãƒ‡ãƒã‚¤ã‚¹ä¸€è¦§ã‚’å–å¾—
                const devices = await navigator.mediaDevices.enumerateDevices();
                const audioInputs = devices.filter(device => device.kind === 'audioinput');

                // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªã‚¢
                selectMicrophone.innerHTML = '<option value="">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒã‚¤ã‚¯</option>';

                // ãƒã‚¤ã‚¯ãƒ‡ãƒã‚¤ã‚¹ã‚’è¿½åŠ 
                audioInputs.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.textContent = device.label || `ãƒã‚¤ã‚¯ ${device.deviceId.substring(0, 8)}`;
                    selectMicrophone.appendChild(option);
                });

                addLog(`${audioInputs.length}å€‹ã®ãƒã‚¤ã‚¯ãƒ‡ãƒã‚¤ã‚¹ã‚’æ¤œå‡ºã—ã¾ã—ãŸ`, 'info');

            } catch (error) {
                addLog(`ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                alert('ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        }

        // Web Speech APIã®åˆæœŸåŒ–
        function initializeSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                // ãƒ–ãƒ©ã‚¦ã‚¶ã®åˆ¤å®š
                const isFirefox = navigator.userAgent.toLowerCase().indexOf('firefox') > -1;

                if (isFirefox) {
                    addLog('Firefoxã§éŸ³å£°èªè­˜ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã«ã¯: about:config ã§ã€Œmedia.webspeech.recognition.enableã€ã‚’ true ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚', 'error');

                    // æƒ…å ±ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚æ›´æ–°
                    const infoMessage = document.getElementById('speech_info_message');
                    if (infoMessage) {
                        infoMessage.innerHTML = '<i class="bi bi-exclamation-triangle text-warning"></i> ' +
                            'Firefoxã§éŸ³å£°èªè­˜ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€<code>about:config</code>ã‚’é–‹ãã€<code>media.webspeech.recognition.enable</code>ã‚’<strong>true</strong>ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚' +
                            '<br><small class="text-muted">è¨­å®šå¾Œã€ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚</small>';
                    }
                } else {
                    addLog('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚Chromeã€Edgeã€ã¾ãŸã¯Safariã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚', 'error');

                    // æƒ…å ±ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚æ›´æ–°
                    const infoMessage = document.getElementById('speech_info_message');
                    if (infoMessage) {
                        infoMessage.innerHTML = '<i class="bi bi-exclamation-triangle text-warning"></i> ' +
                            'éŸ³å£°èªè­˜ã¯ç¾åœ¨ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚Chromeã€Edgeã€ã¾ãŸã¯Safariã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚';
                    }
                }

                buttonStartSpeech.disabled = true;
                return false;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            speechRecognition = new SpeechRecognition();

            // åŸºæœ¬è¨­å®š
            speechRecognition.continuous = false; // åˆæœŸã¯å˜ç™ºãƒ¢ãƒ¼ãƒ‰
            speechRecognition.interimResults = true; // é€”ä¸­çµæœã‚‚è¡¨ç¤º
            speechRecognition.maxAlternatives = 1;
            speechRecognition.lang = recognitionLanguage;

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
            speechRecognition.onstart = function () {
                isRecognizing = true;
                buttonStartSpeech.disabled = true;
                buttonStopSpeech.disabled = false;
                addLog('éŸ³å£°èªè­˜ã‚’é–‹å§‹ã—ã¾ã—ãŸ', 'info');
            };

            speechRecognition.onresult = function (event) {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                // æš«å®šçµæœã‚’inputè¦ç´ ã«è¡¨ç¤º
                if (interimTranscript) {
                    inputSpeechInterim.value = interimTranscript;
                } else {
                    inputSpeechInterim.value = '';
                }

                // ç¢ºå®šçµæœã‚’ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«è¿½åŠ 
                if (finalTranscript) {
                    // æš«å®šçµæœã‚’ã‚¯ãƒªã‚¢
                    inputSpeechInterim.value = '';

                    const currentText = textareaSpeechResult.value;
                    const newText = currentText ? currentText + '\n' + finalTranscript : finalTranscript;
                    textareaSpeechResult.value = newText;
                    textareaSpeechResult.scrollTop = textareaSpeechResult.scrollHeight;

                    addLog(`éŸ³å£°èªè­˜çµæœ: ${finalTranscript}`, 'info');

                    // éŸ³å£°èªè­˜çµæœã‚’ãƒ­ã‚°ã«ä¿å­˜ï¼ˆé…ä¿¡è€…ã®ç™ºè¨€ã¨ã—ã¦ï¼‰
                    const speechLogData = {
                        my_name: 'é…ä¿¡è€…',
                        comment: finalTranscript,
                        flg_speech: false,
                        flg_emoji: false,
                        flg_sound: false,
                        source: 'speech'
                    };
                    addToCommentLog(speechLogData);

                    // ä¼šè©±å±¥æ­´ã«é…ä¿¡è€…ã®ç™ºè¨€ã¨ã—ã¦è¿½åŠ ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åãªã—ï¼‰
                    addToConversationHistory('user', finalTranscript, 'é…ä¿¡è€…');

                    // AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆåãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯è‡ªå‹•å¿œç­”ï¼ˆãƒˆã‚°ãƒ«è¨­å®šã«ã‚ˆã‚‹ï¼‰
                    if (isAiNameAutoResponse && finalTranscript.includes(aiName)) {
                        addLog(`éŸ³å£°èªè­˜ã§ã€Œ${aiName}ã€ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚AIå‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™ã€‚`, 'info');

                        setTimeout(async () => {
                            try {
                                const aiResponse = await sendToLMStudio(finalTranscript);
                                setTimeout(() => {
                                    sendComment(aiResponse, 'speech'); // éŸ³å£°èªè­˜ç”±æ¥ã§ã‚ã‚‹ã“ã¨ã‚’æ˜ç¤º
                                    // AIã®å¿œç­”ã‚‚ä¼šè©±å±¥æ­´ã«è¿½åŠ 
                                    addToConversationHistory('assistant', aiResponse);
                                    addLog(`éŸ³å£°èªè­˜ã‹ã‚‰ã®AIå¿œç­”: ${aiResponse}`, 'info');
                                }, 500);
                            } catch (error) {
                                addLog(`éŸ³å£°èªè­˜ã‹ã‚‰ã®AIå¿œç­”ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                            }
                        }, 1000);
                    }

                    // è‡ªå‹•é€ä¿¡æ©Ÿèƒ½ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸ
                }
            };

            speechRecognition.onerror = function (event) {
                // no-speechã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ç‰¹åˆ¥ãªå‡¦ç†
                if (event.error === 'no-speech') {
                    addLog('ç„¡éŸ³ã®ãŸã‚éŸ³å£°èªè­˜ãŒçµ‚äº†ã—ã¾ã—ãŸ', 'info');
                    resetSpeechRecognition();

                    // é€£ç¶šèªè­˜ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯è‡ªå‹•å†é–‹ï¼ˆno-speechã¯æ­£å¸¸ãªå‹•ä½œã¨ã—ã¦æ‰±ã†ï¼‰
                    if (isContinuous) {
                        setTimeout(() => {
                            if (isContinuous) { // å†åº¦ç¢ºèªï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåœæ­¢ã—ã¦ã„ãªã„å ´åˆã®ã¿ï¼‰
                                addLog('éŸ³å£°å…¥åŠ›ã‚’å†é–‹ã—ã¦ã„ã¾ã™...', 'info');
                                startSpeechRecognition();
                            }
                        }, 1000); // 1ç§’å¾…ã£ã¦ã‹ã‚‰å†é–‹
                    }
                    return;
                }

                addLog(`éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼: ${event.error}`, 'error');

                // å›å¾©å¯èƒ½ãªã‚¨ãƒ©ãƒ¼ã‹ã©ã†ã‹ã‚’åˆ¤å®š
                const recoverableErrors = ['network', 'audio-capture', 'service-not-allowed'];
                const isRecoverable = recoverableErrors.includes(event.error);

                resetSpeechRecognition();

                // é€£ç¶šèªè­˜ãƒ¢ãƒ¼ãƒ‰ã§å›å¾©å¯èƒ½ãªã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯è‡ªå‹•å†é–‹
                if (isContinuous && isRecoverable) {
                    addLog('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯éŸ³å£°å–å¾—ã‚¨ãƒ©ãƒ¼ã®ãŸã‚ã€3ç§’å¾Œã«éŸ³å£°èªè­˜ã‚’å†é–‹ã—ã¾ã™...', 'info');
                    setTimeout(() => {
                        if (isContinuous) { // å†åº¦ç¢ºèªï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåœæ­¢ã—ã¦ã„ãªã„å ´åˆã®ã¿ï¼‰
                            addLog('éŸ³å£°èªè­˜ã‚’è‡ªå‹•å†é–‹ã—ã¦ã„ã¾ã™...', 'info');
                            startSpeechRecognition();
                        }
                    }, 3000); // 3ç§’å¾…ã£ã¦ã‹ã‚‰å†é–‹
                } else if (isContinuous && !isRecoverable) {
                    // å›å¾©ä¸å¯èƒ½ãªã‚¨ãƒ©ãƒ¼ã§ã‚‚é€£ç¶šãƒ¢ãƒ¼ãƒ‰ã¯ç¶­æŒã—ã€5ç§’å¾Œã«å†è©¦è¡Œ
                    addLog(`å›å¾©ä¸å¯èƒ½ãªã‚¨ãƒ©ãƒ¼: ${event.error}ã€‚é€£ç¶šèªè­˜ãƒ¢ãƒ¼ãƒ‰ã‚’ç¶­æŒã—ã€5ç§’å¾Œã«å†è©¦è¡Œã—ã¾ã™ã€‚`, 'error');
                    setTimeout(() => {
                        if (isContinuous) {
                            addLog('éŸ³å£°èªè­˜ã‚’å†è©¦è¡Œã—ã¦ã„ã¾ã™...', 'info');
                            startSpeechRecognition();
                        }
                    }, 5000); // 5ç§’å¾…ã£ã¦ã‹ã‚‰å†é–‹
                }
            };

            speechRecognition.onend = function () {
                // é€£ç¶šãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹ã‚’å…ˆã«ç¢ºèªï¼ˆresetSpeechRecognitionå‰ã«ï¼‰
                const shouldContinue = isContinuous;

                resetSpeechRecognition();

                // é€£ç¶šãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯è‡ªå‹•çš„ã«å†é–‹
                if (shouldContinue) {
                    setTimeout(() => {
                        if (isContinuous) { // å†åº¦ç¢ºèªï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåœæ­¢ã—ã¦ã„ãªã„å ´åˆã®ã¿ï¼‰
                            addLog('éŸ³å£°èªè­˜ã‚’ç¶™ç¶šã—ã¦ã„ã¾ã™...', 'info');
                            startSpeechRecognition();
                        }
                    }, 500);
                }
            };

            return true;
        }

        // éŸ³å£°èªè­˜ã®ãƒªã‚»ãƒƒãƒˆ
        function resetSpeechRecognition() {
            isRecognizing = false;
            buttonStartSpeech.disabled = false;
            buttonStopSpeech.disabled = true;
            inputSpeechInterim.value = '';
        }

        // éŸ³å£°èªè­˜é–‹å§‹
        function startSpeechRecognition() {
            // æ—¢ã«èªè­˜ä¸­ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
            if (isRecognizing) {
                addLog('éŸ³å£°èªè­˜ã¯æ—¢ã«é–‹å§‹ã•ã‚Œã¦ã„ã¾ã™', 'info');
                return;
            }

            if (!speechRecognition) {
                if (!initializeSpeechRecognition()) {
                    return;
                }
            }

            // è¨­å®šã‚’æ›´æ–°
            speechRecognition.lang = recognitionLanguage;
            speechRecognition.continuous = isContinuous;
            speechRecognition.interimResults = true; // é€”ä¸­çµæœã®è¡¨ç¤ºã‚’ç¢ºå®Ÿã«æœ‰åŠ¹åŒ–
            speechRecognition.maxAlternatives = 1;

            try {
                speechRecognition.start();
            } catch (error) {
                addLog(`éŸ³å£°èªè­˜é–‹å§‹ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                resetSpeechRecognition();
            }
        }

        // éŸ³å£°èªè­˜åœæ­¢
        function stopSpeechRecognition() {
            // é€£ç¶šèªè­˜ãƒ¢ãƒ¼ãƒ‰ã‚’ç„¡åŠ¹åŒ–ï¼ˆè‡ªå‹•å†é–‹ã‚’é˜²ãï¼‰
            isContinuous = false;
            checkboxContinuousSpeech.checked = false;

            if (speechRecognition && isRecognizing) {
                speechRecognition.stop();
                addLog('éŸ³å£°èªè­˜ã‚’åœæ­¢ã—ã¾ã—ãŸ', 'info');
            }
            resetSpeechRecognition();
        }

        // éŸ³å£°èªè­˜çµæœã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadSpeechResult() {
            const speechText = textareaSpeechResult.value.trim();

            if (!speechText) {
                alert('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹éŸ³å£°èªè­˜çµæœãŒã‚ã‚Šã¾ã›ã‚“');
                addLog('éŸ³å£°èªè­˜çµæœãŒç©ºã®ãŸã‚ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã›ã‚“', 'info');
                return;
            }

            // ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
            const blob = new Blob([speechText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;

            // ãƒ•ã‚¡ã‚¤ãƒ«å: éŸ³å£°èªè­˜çµæœ_YYYY-MM-DD_HHMMSS.txt
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10); // YYYY-MM-DD
            const timeStr = now.toTimeString().slice(0, 8).replace(/:/g, ''); // HHMMSS
            link.download = `éŸ³å£°èªè­˜çµæœ_${dateStr}_${timeStr}.txt`;

            link.click();
            URL.revokeObjectURL(url);

            addLog('éŸ³å£°èªè­˜çµæœã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'info');
        }

        // éŸ³å£°èªè­˜çµæœã‚¯ãƒªã‚¢
        function clearSpeechResult() {
            inputSpeechInterim.value = '';
            textareaSpeechResult.value = '';
            addLog('éŸ³å£°èªè­˜çµæœã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'info');
        }

        // ç¾åœ¨ã®ä¼šè©±å±¥æ­´æ•°ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateCurrentHistoryCount() {
            if (spanCurrentHistoryCount) {
                spanCurrentHistoryCount.textContent = conversationHistory.length;
            }
        }

        // ä¼šè©±å±¥æ­´ã«è¿½åŠ 
        function addToConversationHistory(type, content, speaker = null) {
            const timestamp = new Date().toISOString();
            conversationHistory.push({
                type: type, // 'user' ã¾ãŸã¯ 'assistant'
                content: content,
                timestamp: timestamp,
                speaker: speaker // 'é…ä¿¡è€…' ã¾ãŸã¯ 'å‚åŠ è€…'
            });

            // å±¥æ­´æ•°ã®ä¸Šé™ã‚’è¶…ãˆãŸå ´åˆã€å¤ã„ã‚‚ã®ã‹ã‚‰å‰Šé™¤
            if (conversationHistory.length > conversationHistoryLimit) {
                conversationHistory = conversationHistory.slice(-conversationHistoryLimit);
            }

            // ç¾åœ¨ã®å±¥æ­´æ•°ã‚’æ›´æ–°
            updateCurrentHistoryCount();

            const speakerLabel = speaker ? `[${speaker}]` : '';
            addLog(`ä¼šè©±å±¥æ­´ã«è¿½åŠ : ${speakerLabel}[${type}] ${content.substring(0, 50)}${content.length > 50 ? '...' : ''}`, 'info');
        }

        // ä¼šè©±å±¥æ­´ã‚’ã‚¯ãƒªã‚¢
        function clearConversationHistory() {
            conversationHistory = [];
            updateCurrentHistoryCount();
            addLog('ä¼šè©±å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'info');
        }

        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰ï¼ˆsystem, user, assistantã‚’åˆ†é›¢ï¼‰
        function buildPrompt() {
            // ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: äº‹å‰çŸ¥è­˜ã®ã¿
            let systemPrompt = textareaSystemPrompt.value.trim();
            if (systemPrompt) {
                systemPrompt = systemPrompt.replace(/{AI_NAME}/g, aiName);
            }

            // ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: éå»ã®ä¼šè©±å±¥æ­´
            let assistantPrompt = '';

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: æŒ‡ç¤º
            let userPrompt = '';

            if (conversationHistory.length > 0) {
                // ãƒ‡ãƒãƒƒã‚°: ä¼šè©±å±¥æ­´ã®å†…å®¹ã‚’ç¢ºèª
                console.log('=== ä¼šè©±å±¥æ­´ãƒ‡ãƒãƒƒã‚° ===');
                conversationHistory.forEach((entry, index) => {
                    console.log(`[${index}] type: ${entry.type}, speaker: ${entry.speaker}, content: ${entry.content.substring(0, 50)}`);
                });
                console.log('===================');

                const historyText = conversationHistory.map(entry => {
                    if (entry.type === 'assistant') {
                        // AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã®å¿œç­”
                        return `ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ(${aiName}): ${entry.content}`;
                    } else {
                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç™ºè¨€
                        if (entry.speaker) {
                            // speaker ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚‹å ´åˆï¼ˆé…ä¿¡è€… or å‚åŠ è€…ï¼‰
                            return `${entry.speaker}: ${entry.content}`;
                        } else {
                            // speaker ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒãªã„å ´åˆï¼ˆäº’æ›æ€§ã®ãŸã‚ï¼‰
                            return `ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${entry.content}`;
                        }
                    }
                }).join('\n');

                // éå»ãƒ­ã‚°ã‚’ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨ã—ã¦è¨­å®š
                assistantPrompt = `ã€éå»ã®ä¼šè©±å±¥æ­´ã€‘\n${historyText}`;

                // æŒ‡ç¤ºã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨ã—ã¦è¨­å®š
                userPrompt = 'ã“ã‚Œã¾ã§ã®ä¼šè©±ã®æµã‚Œã‚’è€ƒæ…®ã—ã¦ã€è‡ªç„¶ã§é©åˆ‡ãªã‚³ãƒ¡ãƒ³ãƒˆã‚’ã—ã¦ãã ã•ã„ã€‚120æ–‡å­—ä»¥å†…ã§è¿”ç­”ã—ã¦ãã ã•ã„ã€‚';
            }

            // ãƒ‡ãƒãƒƒã‚°: å®Œæˆã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç¢ºèª
            console.log('=== ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ ===');
            console.log(systemPrompt);
            console.log('=== ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆéå»ãƒ­ã‚°ï¼‰ ===');
            console.log(assistantPrompt);
            console.log('=== ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆæŒ‡ç¤ºï¼‰ ===');
            console.log(userPrompt);
            console.log('================================');

            return {
                system: systemPrompt,
                assistant: assistantPrompt,
                user: userPrompt
            };
        }

        // LM Studio æ¥ç¶šãƒ†ã‚¹ãƒˆ
        async function testLMStudioConnection() {
            const testUrl = textLmStudioUrl.value.trim();
            addLog(`LM Studio æ¥ç¶šãƒ†ã‚¹ãƒˆã‚’é–‹å§‹: ${testUrl}`, 'info');

            try {
                const response = await sendToLMStudio('ãƒ†ã‚¹ãƒˆæ¥ç¶šã§ã™ã€‚120æ–‡å­—ä»¥å†…ã§ç°¡å˜ã«æŒ¨æ‹¶ã—ã¦ãã ã•ã„ã€‚');
                addLog('LM Studio æ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸï¼', 'info');
                alert('LM Studio ã¸ã®æ¥ç¶šã«æˆåŠŸã—ã¾ã—ãŸï¼');
            } catch (error) {
                addLog(`LM Studio æ¥ç¶šãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
                alert(`LM Studio ã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
            }
        }

        // LM Studio ã« API ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
        async function sendToLMStudio(message) {
            try {
                addLog(`LM Studio ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡: ${message}`, 'info');
                updateStatus('processing', 'AIå‡¦ç†ä¸­...');

                // LM Studio ã®æ¥ç¶šãƒ†ã‚¹ãƒˆ
                addLog(`æ¥ç¶šå…ˆ: ${lmStudioUrl}`, 'info');

                // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰ï¼ˆsystem, assistant, userã‚’åˆ†é›¢ï¼‰
                const prompts = buildPrompt();

                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…åˆ—ã‚’æ§‹ç¯‰
                const messages = [];

                // ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆäº‹å‰çŸ¥è­˜ï¼‰ã‚’è¿½åŠ 
                if (prompts.system) {
                    messages.push({
                        role: 'system',
                        content: prompts.system
                    });
                }

                // ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆéå»ãƒ­ã‚°ï¼‰ã‚’è¿½åŠ 
                if (prompts.assistant) {
                    messages.push({
                        role: 'assistant',
                        content: prompts.assistant
                    });
                }

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆæŒ‡ç¤º + ä»Šå›ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰ã‚’è¿½åŠ 
                let userContent = '';
                if (prompts.user) {
                    // ä¼šè©±å±¥æ­´ãŒã‚ã‚‹å ´åˆã¯æŒ‡ç¤ºã‚’å«ã‚ã‚‹
                    userContent = prompts.user + '\n\n' + message;
                } else {
                    // ä¼šè©±å±¥æ­´ãŒãªã„å ´åˆã¯ä»Šå›ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿
                    userContent = message;
                }

                messages.push({
                    role: 'user',
                    content: userContent
                });

                // ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚’è¨ˆç®—ã—ã¦è¨˜éŒ²ï¼ˆæ–‡å­—æ•° Ã· 0.75 ã§æ¨å®šï¼‰
                const totalCharLength = messages.reduce((sum, msg) => sum + msg.content.length, 0);
                const estimatedTokens = Math.round(totalCharLength / 0.75);
                updateContextStats(estimatedTokens);
                addLog(`æ¨å®šãƒˆãƒ¼ã‚¯ãƒ³æ•°: ${estimatedTokens} (æ–‡å­—æ•°: ${totalCharLength})`, 'info');

                addLog(`é€ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°: ${messages.length}`, 'info');
                console.log('=== LM Studioã«é€ä¿¡ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ===');
                console.log(JSON.stringify(messages, null, 2));
                console.log('====================================');

                const response = await fetch(`${textLmStudioUrl.value.trim()}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer lm-studio'
                    },
                    body: JSON.stringify({
                        model: 'local-model',
                        messages: messages,
                        temperature: 0.7,
                        max_tokens: 4096
                    })
                });

                addLog(`HTTP ãƒ¬ã‚¹ãƒãƒ³ã‚¹çŠ¶æ…‹: ${response.status}`, 'info');

                if (!response.ok) {
                    const errorText = await response.text();
                    addLog(`HTTP ã‚¨ãƒ©ãƒ¼è©³ç´°: ${errorText}`, 'error');
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }

                const data = await response.json();
                addLog(`ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿: ${JSON.stringify(data)}`, 'info');

                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('Invalid response format from LM Studio');
                }

                const aiResponse = data.choices[0].message.content;

                addLog(`LM Studio ã‹ã‚‰ã®å¿œç­”: ${aiResponse}`, 'info');

                // æ–‡å­—æ•°åˆ¶é™ã‚’é©ç”¨ï¼ˆ120æ–‡å­—ä»¥å†…ã«åˆ‡ã‚Šè©°ã‚ï¼‰
                let finalResponse = aiResponse.trim();
                if (finalResponse.length > 120) {
                    // 120æ–‡å­—ã§åˆ‡ã‚Šè©°ã‚ã¦ã€å¥èª­ç‚¹ã§è‡ªç„¶ã«åˆ‡ã‚Œã‚‹ä½ç½®ã‚’æ¢ã™
                    let truncated = finalResponse.substring(0, 120);
                    const lastPunctuation = Math.max(
                        truncated.lastIndexOf('ã€‚'),
                        truncated.lastIndexOf('ï¼'),
                        truncated.lastIndexOf('ï¼Ÿ'),
                        truncated.lastIndexOf('â™ª'),
                        truncated.lastIndexOf('âœ¨')
                    );

                    if (lastPunctuation > 60) { // 60æ–‡å­—ä»¥ä¸Šã®ä½ç½®ã«å¥èª­ç‚¹ãŒã‚ã‚Œã°ã€ãã“ã§åˆ‡ã‚‹
                        finalResponse = truncated.substring(0, lastPunctuation + 1);
                    } else {
                        // å¥èª­ç‚¹ãŒãªã„å ´åˆã¯117æ–‡å­—ã§åˆ‡ã£ã¦ã€Œ...ã€ã‚’è¿½åŠ 
                        finalResponse = truncated.substring(0, 117) + '...';
                    }

                    addLog(`æ–‡å­—æ•°åˆ¶é™ã«ã‚ˆã‚Šå¿œç­”ã‚’çŸ­ç¸®: ${finalResponse.length}æ–‡å­—`, 'info');
                }

                updateStatus('connected', 'æ¥ç¶šä¸­');

                return finalResponse;
            } catch (error) {
                addLog(`LM Studio ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');

                // CORS ã‚¨ãƒ©ãƒ¼ã®å ´åˆã®ç‰¹åˆ¥ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                if (error.message.includes('CORS') || error.message.includes('NetworkError')) {
                    addLog('CORS ã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚LM Studio ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
                    addLog('LM Studio ã§ CORS ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã‹ã€ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚', 'info');
                }

                updateStatus('connected', 'æ¥ç¶šä¸­ (AI ã‚¨ãƒ©ãƒ¼)');

                // é‡è¦: å‘¼ã³å‡ºã—å…ƒãŒæ¥ç¶šå¤±æ•—ã‚’æ¤œçŸ¥ã§ãã‚‹ã‚ˆã†ä¾‹å¤–ã‚’å†ã‚¹ãƒ­ãƒ¼ã™ã‚‹
                throw error;
            }
        }

        // ã‚³ãƒ¡ãƒ³ãƒˆã‚’ã‚µãƒ¼ãƒã«é€ä¿¡
        function sendComment(comment, source = 'comment') {
            if (!socket || !isConnected) {
                addLog('ã‚µãƒ¼ãƒã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            const data = {
                my_name: aiName,
                comment: comment,
                flg_speech: false,
                color_text: aiTextColor,
                color_text_stroke: '#111111',
                text_direction: aiTextDirection,
                flg_emoji: false,
                flg_sound: false,
                id_sound: 0,
                hidden: -1,
                source: source // 'speech' or 'comment'
            };

            socket.emit('comment', data);
            addLog(`ã‚³ãƒ¡ãƒ³ãƒˆé€ä¿¡: ${comment}`, 'sent');

            // è‡ªåˆ†ã®é€ä¿¡ã‚³ãƒ¡ãƒ³ãƒˆã‚‚ã‚³ãƒ¡ãƒ³ãƒˆãƒ­ã‚°ã«è¿½åŠ 
            addToCommentLog(data);
        }

        // æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’å—ä¿¡ã—ãŸã¨ãã®å‡¦ç†
        async function onNewComment(data) {
            addLog(`å—ä¿¡: [${data.my_name}] ${data.comment}`, 'received');

            // ã‚³ãƒ¡ãƒ³ãƒˆãƒ­ã‚°ã«è¿½åŠ ï¼ˆã™ã¹ã¦ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼‰
            addToCommentLog(data);

            // ã™ã¹ã¦ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä¼šè©±å±¥æ­´ã«è¿½åŠ ï¼ˆè‡ªåˆ†ã®ã‚³ãƒ¡ãƒ³ãƒˆä»¥å¤–ã€çµµæ–‡å­—ã®ã¿ã¯é™¤å¤–ï¼‰
            if (data.my_name !== aiName && !data.flg_emoji) {
                // sourceãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§è©±è€…ã‚’åˆ¤åˆ¥ï¼ˆspeech=é…ä¿¡è€…, comment=å‚åŠ è€…ï¼‰
                const speaker = data.source === 'speech' ? 'é…ä¿¡è€…' : 'å‚åŠ è€…';
                addToConversationHistory('user', `${data.my_name}: ${data.comment}`, speaker);
            }

            // AIåå‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if (isAutoResponse && data.comment.includes(aiName)) {
                addLog(`ã€Œ${aiName}ã€ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚AIå‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™ã€‚`, 'info');

                try {
                    const aiResponse = await sendToLMStudio(data.comment);

                    // AI ã®å¿œç­”ã‚’ã‚µãƒ¼ãƒã«é€ä¿¡
                    setTimeout(() => {
                        sendComment(aiResponse);
                        // AIã®å¿œç­”ã‚‚ä¼šè©±å±¥æ­´ã«è¿½åŠ 
                        addToConversationHistory('assistant', aiResponse);
                    }, 1000); // 1ç§’é…å»¶

                } catch (error) {
                    addLog(`å‡¦ç†ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                }
            }
        }

        // Socket.IO æ¥ç¶š
        function connectToServer() {
            roomName = textRoomName.value.trim();
            lmStudioUrl = textLmStudioUrl.value.trim();
            aiName = textAiName.value.trim();
            aiTextDirection = selectTextDirection.value;
            aiTextColor = inputTextColor.value;
            isAutoResponse = checkboxAutoResponse.checked;

            if (!roomName) {
                alert('éƒ¨å±‹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            addLog('ã‚µãƒ¼ãƒã«æ¥ç¶šã—ã¦ã„ã¾ã™...', 'info');
            updateStatus('processing', 'æ¥ç¶šä¸­...');

            // Socket.IO æ¥ç¶š
            socket = io.connect(window.location.origin);

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
            socket.on('connect', () => {
                addLog('ã‚µãƒ¼ãƒã«æ¥ç¶šã—ã¾ã—ãŸ', 'info');
                socket.emit('watcher', socket.id);
            });

            socket.on('you_are_connected', () => {
                addLog(`éƒ¨å±‹ "${roomName}" ã«å‚åŠ ã—ã¦ã„ã¾ã™...`, 'info');
                socket.emit('join', roomName);
            });

            socket.on('login', (data) => {
                isConnected = true;
                updateStatus('connected', 'æ¥ç¶šä¸­');
                addLog(`éƒ¨å±‹ "${roomName}" ã«å‚åŠ ã—ã¾ã—ãŸ (å‚åŠ è€…æ•°: ${data.numUsers})`, 'info');
                buttonConnect.textContent = 'åˆ‡æ–­';
                updateUserStats(data.numUsers);

                // æ¥ç¶šå¾Œã€ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã‚³ãƒ¡ãƒ³ãƒˆãƒ­ã‚°ã‚’è‡ªå‹•åŒæœŸï¼ˆã‚¢ãƒ©ãƒ¼ãƒˆãªã—ï¼‰
                setTimeout(() => {
                    syncCommentsFromServer(false);
                }, 500);
            });

            socket.on('comment', onNewComment);

            socket.on('user joined', (data) => {
                addLog(`${data.username} ãŒå‚åŠ ã—ã¾ã—ãŸ (å‚åŠ è€…æ•°: ${data.numUsers})`, 'info');
                updateUserStats(data.numUsers);
            });

            socket.on('user left', (data) => {
                addLog(`${data.username} ãŒé€€å‡ºã—ã¾ã—ãŸ (å‚åŠ è€…æ•°: ${data.numUsers})`, 'info');
                updateUserStats(data.numUsers);
            });

            socket.on('disconnect', () => {
                isConnected = false;
                stopAutoPosting(); // è‡ªå‹•æŠ•ç¨¿ã‚’åœæ­¢
                updateStatus('disconnected', 'åˆ‡æ–­ã•ã‚Œã¾ã—ãŸ');
                addLog('ã‚µãƒ¼ãƒã‹ã‚‰åˆ‡æ–­ã•ã‚Œã¾ã—ãŸ', 'error');
                buttonConnect.textContent = 'æ¥ç¶š';
            });

            socket.on('reconnect', () => {
                addLog('ã‚µãƒ¼ãƒã«å†æ¥ç¶šã—ã¾ã—ãŸ', 'info');
                socket.emit('join', roomName);
            });
        }

        // ã‚µãƒ¼ãƒã‹ã‚‰åˆ‡æ–­
        function disconnectFromServer() {
            if (socket) {
                socket.close();
                socket = null;
            }
            isConnected = false;
            stopAutoPosting(); // è‡ªå‹•æŠ•ç¨¿ã‚’åœæ­¢
            updateStatus('disconnected', 'åˆ‡æ–­ã•ã‚Œã¾ã—ãŸ');
            addLog('ã‚µãƒ¼ãƒã‹ã‚‰åˆ‡æ–­ã—ã¾ã—ãŸ', 'info');
            buttonConnect.textContent = 'æ¥ç¶š';
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        buttonConnect.addEventListener('click', () => {
            if (isConnected) {
                disconnectFromServer();
            } else {
                connectToServer();
            }
        });

        buttonClearLog.addEventListener('click', () => {
            logContainer.innerHTML = '';
        });

        buttonDownloadComments.addEventListener('click', () => {
            downloadCommentLog();
        });

        buttonDownloadCsv.addEventListener('click', () => {
            downloadCommentCsv();
        });

        buttonClearComments.addEventListener('click', () => {
            clearCommentLog();
        });

        // åŒæœŸãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('button_sync_comments').addEventListener('click', () => {
            syncCommentsFromServer(true); // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤ºã‚ã‚Š
        });

        // å‚åŠ è€…æ•°çµ±è¨ˆã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        document.getElementById('button_download_user_stats').addEventListener('click', () => {
            downloadUserStatsCSV();
        });

        // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆé•·çµ±è¨ˆã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        document.getElementById('button_download_context_stats').addEventListener('click', () => {
            downloadContextStatsCSV();
        });

        buttonTestLMStudio.addEventListener('click', () => {
            testLMStudioConnection();
        });

        // AIåå‰ã®å¤‰æ›´ç›£è¦–
        textAiName.addEventListener('input', () => {
            aiName = textAiName.value.trim() || 'ç±³å¤ªéƒ';
            updateAutoResponseLabel();
            updateAiNameAutoResponseLabel();
            // localStorageã«ä¿å­˜
            saveAiName(aiName);
            addLog(`AIåå‰ã‚’ã€Œ${aiName}ã€ã«å¤‰æ›´ã—ã¾ã—ãŸ`, 'info');
        });

        // æ–‡å­—ã®æµã‚Œã‚‹æ–¹å‘ã®å¤‰æ›´ç›£è¦–
        selectTextDirection.addEventListener('change', () => {
            aiTextDirection = selectTextDirection.value;
            const directionText = selectTextDirection.options[selectTextDirection.selectedIndex].text;
            addLog(`æ–‡å­—ã®æµã‚Œã‚‹æ–¹å‘ã‚’ã€Œ${directionText}ã€ã«å¤‰æ›´ã—ã¾ã—ãŸ`, 'info');
        });

        // æ–‡å­—è‰²ã®å¤‰æ›´ç›£è¦–
        inputTextColor.addEventListener('change', () => {
            aiTextColor = inputTextColor.value;
            addLog(`æ–‡å­—è‰²ã‚’ã€Œ${aiTextColor}ã€ã«å¤‰æ›´ã—ã¾ã—ãŸ`, 'info');
        });

        // ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å¤‰æ›´ç›£è¦–
        textareaSystemPrompt.addEventListener('input', () => {
            const prompt = textareaSystemPrompt.value;
            saveSystemPrompt(prompt);
        });

        // ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        buttonResetSystemPrompt.addEventListener('click', () => {
            resetSystemPrompt();
        });

        // è‡ªå‹•å¿œç­”ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateAutoResponseLabel() {
            const labelAutoResponse = document.getElementById('label_auto_response');
            labelAutoResponse.textContent = `ã€Œ${aiName}ã€ã‚’å«ã‚€ã‚³ãƒ¡ãƒ³ãƒˆã«è‡ªå‹•å¿œç­”`;
        }

        // éŸ³å£°èªè­˜ã®AIåå‰è‡ªå‹•å¿œç­”ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateAiNameAutoResponseLabel() {
            if (labelAiNameAutoResponse) {
                labelAiNameAutoResponse.textContent = `ã€Œ${aiName}ã€ã‚’å«ã‚€éŸ³å£°èªè­˜ã‚’è‡ªå‹•ã§AIã«é€ä¿¡`;
            }
        }

        // è‡ªå‹•æŠ•ç¨¿é–¢é€£ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        checkboxAutoPosting.addEventListener('change', () => {
            if (checkboxAutoPosting.checked) {
                startAutoPosting();
            } else {
                stopAutoPosting();
            }
        });

        rangePostingIntervalMin.addEventListener('input', () => {
            postingIntervalMin = parseInt(rangePostingIntervalMin.value);
            spanIntervalMin.textContent = postingIntervalMin;

            // æœ€å°å€¤ãŒæœ€å¤§å€¤ã‚’è¶…ãˆãªã„ã‚ˆã†ã«ã™ã‚‹
            if (postingIntervalMin >= postingIntervalMax) {
                postingIntervalMax = postingIntervalMin + 1;
                rangePostingIntervalMax.value = postingIntervalMax;
                spanIntervalMax.textContent = postingIntervalMax;
            }
        });

        rangePostingIntervalMax.addEventListener('input', () => {
            postingIntervalMax = parseInt(rangePostingIntervalMax.value);
            spanIntervalMax.textContent = postingIntervalMax;

            // æœ€å¤§å€¤ãŒæœ€å°å€¤ã‚’ä¸‹å›ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹
            if (postingIntervalMax <= postingIntervalMin) {
                postingIntervalMin = postingIntervalMax - 1;
                rangePostingIntervalMin.value = postingIntervalMin;
                spanIntervalMin.textContent = postingIntervalMin;
            }
        });

        selectPostingStyle.addEventListener('change', () => {
            postingStyle = selectPostingStyle.value;
            addLog(`æŠ•ç¨¿ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ã€Œ${selectPostingStyle.options[selectPostingStyle.selectedIndex].text}ã€ã«å¤‰æ›´`, 'info');
        });

        buttonTestAutoPosting.addEventListener('click', () => {
            testAutoPosting();
        });

        // éŸ³å£°èªè­˜é–¢é€£ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        buttonRefreshMics.addEventListener('click', () => {
            refreshMicrophones();
        });

        selectMicrophone.addEventListener('change', () => {
            selectedMicrophoneId = selectMicrophone.value;
            addLog(`ãƒã‚¤ã‚¯ã‚’å¤‰æ›´ã—ã¾ã—ãŸ: ${selectMicrophone.options[selectMicrophone.selectedIndex].text}`, 'info');
        });

        selectSpeechLanguage.addEventListener('change', () => {
            recognitionLanguage = selectSpeechLanguage.value;
            addLog(`éŸ³å£°èªè­˜è¨€èªã‚’å¤‰æ›´ã—ã¾ã—ãŸ: ${selectSpeechLanguage.options[selectSpeechLanguage.selectedIndex].text}`, 'info');
        });

        buttonStartSpeech.addEventListener('click', () => {
            startSpeechRecognition();
        });

        buttonStopSpeech.addEventListener('click', () => {
            stopSpeechRecognition();
        });

        // éŸ³å£°èªè­˜çµæœã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        buttonDownloadSpeech.addEventListener('click', () => {
            downloadSpeechResult();
        });

        buttonClearSpeech.addEventListener('click', () => {
            clearSpeechResult();
        });

        checkboxContinuousSpeech.addEventListener('change', () => {
            isContinuous = checkboxContinuousSpeech.checked;
            addLog(`é€£ç¶šèªè­˜ãƒ¢ãƒ¼ãƒ‰: ${isContinuous ? 'ON' : 'OFF'}`, 'info');
        });

        // checkboxAutoSendSpeech listener removed (auto-send feature deleted)

        checkboxAiNameAutoResponse.addEventListener('change', () => {
            isAiNameAutoResponse = checkboxAiNameAutoResponse.checked;
            addLog(`AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆåéŸ³å£°èªè­˜è‡ªå‹•å¿œç­”: ${isAiNameAutoResponse ? 'ON' : 'OFF'}`, 'info');
        });

        inputConversationHistoryLimit.addEventListener('change', () => {
            conversationHistoryLimit = parseInt(inputConversationHistoryLimit.value);
            addLog(`ä¼šè©±å±¥æ­´ä¿å­˜æ•°ã‚’${conversationHistoryLimit}ä»¶ã«å¤‰æ›´ã—ã¾ã—ãŸ`, 'info');

            // ç¾åœ¨ã®å±¥æ­´æ•°ãŒä¸Šé™ã‚’è¶…ãˆã¦ã„ã‚‹å ´åˆã¯å‰Šé™¤
            if (conversationHistory.length > conversationHistoryLimit) {
                conversationHistory = conversationHistory.slice(-conversationHistoryLimit);
                addLog(`å±¥æ­´ã‚’${conversationHistoryLimit}ä»¶ã«èª¿æ•´ã—ã¾ã—ãŸ`, 'info');
            }
            // ç¾åœ¨ã®å±¥æ­´æ•°ã‚’æ›´æ–°
            updateCurrentHistoryCount();
        });

        buttonClearHistory.addEventListener('click', () => {
            clearConversationHistory();
        });

        // è¨­å®šã®å¤‰æ›´ã‚’ç›£è¦–
        checkboxAutoResponse.addEventListener('change', () => {
            isAutoResponse = checkboxAutoResponse.checked;
            addLog(`è‡ªå‹•å¿œç­”: ${isAutoResponse ? 'ON' : 'OFF'}`, 'info');
        });

        // åˆæœŸåŒ–å‡¦ç†
        document.addEventListener('DOMContentLoaded', () => {
            // ãƒ–ãƒ©ã‚¦ã‚¶ãƒã‚§ãƒƒã‚¯
            checkBrowser();

            // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³æ©Ÿèƒ½ã‚’æœ€åˆã«åˆæœŸåŒ–
            initAccordionButtons();

            // URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ãƒ«ãƒ¼ãƒ åã‚’å–å¾—
            const params = getURLParams();
            if (params.room) {
                const roomFromUrl = decodeURIComponent(params.room);
                textRoomName.value = roomFromUrl;
                addLog(`éƒ¨å±‹åã€Œ${roomFromUrl}ã€ãŒè‡ªå‹•è¨­å®šã•ã‚Œã¾ã—ãŸ`, 'info');

                // è‡ªå‹•ã§æ¥ç¶šã‚’é–‹å§‹
                setTimeout(() => {
                    if (!isConnected) {
                        addLog('è‡ªå‹•æ¥ç¶šã‚’é–‹å§‹ã—ã¾ã™...', 'info');
                        connectToServer();
                    }
                }, 1000); // 1ç§’å¾…ã£ã¦ã‹ã‚‰è‡ªå‹•æ¥ç¶š
            }

            // åˆæœŸå€¤ã®è¨­å®š
            spanIntervalMin.textContent = postingIntervalMin;
            spanIntervalMax.textContent = postingIntervalMax;

            // AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆåã®åˆæœŸåŒ–ï¼ˆlocalStorageã‹ã‚‰èª­ã¿è¾¼ã¿ï¼‰
            textAiName.value = aiName;

            // è¡¨ç¤ºè¨­å®šã®åˆæœŸå€¤ã‚’è¨­å®š
            selectTextDirection.value = aiTextDirection;
            inputTextColor.value = aiTextColor;

            // è‡ªå‹•å¿œç­”ãƒ©ãƒ™ãƒ«ã‚’åˆæœŸè¨­å®š
            updateAutoResponseLabel();
            updateAiNameAutoResponseLabel();

            // éŸ³å£°èªè­˜ã®åˆæœŸåŒ–
            initializeSpeechRecognition();
            refreshMicrophones();

            // ä¼šè©±å±¥æ­´è¨­å®šã®åˆæœŸåŒ–
            conversationHistoryLimit = parseInt(inputConversationHistoryLimit.value);
            updateCurrentHistoryCount();

            // å‚åŠ è€…æ•°ã‚°ãƒ©ãƒ•ã®åˆæœŸåŒ–
            initUserStatsChart();

            // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆé•·ã‚°ãƒ©ãƒ•ã®åˆæœŸåŒ–
            initContextStatsChart();

            addLog(`${aiName} AI ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãŒèµ·å‹•ã—ã¾ã—ãŸ`, 'info');
            addLog(`ã€Œ${aiName}ã€ã‚’å«ã‚€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«è‡ªå‹•ã§ AI ãŒå¿œç­”ã—ã¾ã™`, 'info');
            addLog(`è¡¨ç¤ºè¨­å®š: ${selectTextDirection.options[selectTextDirection.selectedIndex].text}ã€è‰²: ${aiTextColor}`, 'info');
            addLog('è‡ªå‹•æŠ•ç¨¿æ©Ÿèƒ½ã§æˆæ¥­ã‚’ç››ã‚Šä¸Šã’ã‚‹ã“ã¨ãŒã§ãã¾ã™', 'info');
            addLog('éŸ³å£°èªè­˜æ©Ÿèƒ½ãŒåˆ©ç”¨å¯èƒ½ã§ã™', 'info');
            addLog(`ä¼šè©±å±¥æ­´æ©Ÿèƒ½ãŒæœ‰åŠ¹ã§ã™ï¼ˆä¿å­˜æ•°: ${conversationHistoryLimit}ä»¶ï¼‰`, 'info');
            // Packery ã®åˆæœŸåŒ–ã¨ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ãªé…ç½®
            (function initPackery() {
                const grid = document.querySelector('#dashboard-grid');
                if (!grid) return;

                const STORAGE_KEY = 'dashboard_card_order';

                // å„ã‚«ãƒ¼ãƒ‰ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªIDã‚’ä»˜ä¸
                function assignCardIds() {
                    const itemElems = Array.from(grid.children);
                    itemElems.forEach((elem, index) => {
                        if (!elem.dataset.cardId) {
                            // ã‚«ãƒ¼ãƒ‰å†…ã®æœ€åˆã®h6è¦ç´ ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’IDã¨ã—ã¦ä½¿ç”¨
                            const h6 = elem.querySelector('h6');
                            if (h6) {
                                elem.dataset.cardId = h6.textContent.trim();
                            } else {
                                elem.dataset.cardId = `card-${index}`;
                            }
                        }
                    });
                }

                // localStorageã‹ã‚‰ã‚«ãƒ¼ãƒ‰ã®é †åºã‚’å¾©å…ƒ
                function restoreCardOrder() {
                    try {
                        const savedOrder = localStorage.getItem(STORAGE_KEY);
                        if (!savedOrder) return false;

                        const orderArray = JSON.parse(savedOrder);
                        const itemElems = Array.from(grid.children);

                        // ä¿å­˜ã•ã‚ŒãŸé †åºã«å¾“ã£ã¦ã‚«ãƒ¼ãƒ‰ã‚’ä¸¦ã¹æ›¿ãˆ
                        const sortedElems = [];
                        orderArray.forEach(cardId => {
                            const elem = itemElems.find(el => el.dataset.cardId === cardId);
                            if (elem) {
                                sortedElems.push(elem);
                            }
                        });

                        // ä¿å­˜ã•ã‚Œã¦ã„ãªã„ã‚«ãƒ¼ãƒ‰ã‚’æœ€å¾Œã«è¿½åŠ 
                        itemElems.forEach(elem => {
                            if (!sortedElems.includes(elem)) {
                                sortedElems.push(elem);
                            }
                        });

                        // DOMé †åºã‚’æ›´æ–°
                        sortedElems.forEach(elem => {
                            grid.appendChild(elem);
                        });

                        return true;
                    } catch (e) {
                        console.error('ã‚«ãƒ¼ãƒ‰ã®é †åºå¾©å…ƒã«å¤±æ•—:', e);
                        return false;
                    }
                }

                // ã‚«ãƒ¼ãƒ‰ã®é †åºã‚’localStorageã«ä¿å­˜
                function saveCardOrder() {
                    try {
                        const itemElems = Array.from(grid.children);
                        const orderArray = itemElems.map(elem => elem.dataset.cardId);
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(orderArray));
                        console.log('ã‚«ãƒ¼ãƒ‰é †åºã‚’ä¿å­˜:', orderArray);
                    } catch (e) {
                        console.error('ã‚«ãƒ¼ãƒ‰ã®é †åºä¿å­˜ã«å¤±æ•—:', e);
                    }
                }

                function setup() {
                    if (typeof Packery === 'undefined' || typeof Draggabilly === 'undefined') {
                        // Packery ã¾ãŸã¯ Draggabilly ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãªã‘ã‚Œã°é…å»¶ãƒªãƒˆãƒ©ã‚¤
                        setTimeout(setup, 150);
                        return;
                    }

                    // ã‚«ãƒ¼ãƒ‰IDã‚’ä»˜ä¸
                    assignCardIds();

                    // ä¿å­˜ã•ã‚ŒãŸé †åºã‚’å¾©å…ƒï¼ˆPackeryåˆæœŸåŒ–å‰ã«å®Ÿè¡Œï¼‰
                    const restored = restoreCardOrder();
                    if (restored) {
                        console.log('ã‚«ãƒ¼ãƒ‰é †åºã‚’å¾©å…ƒã—ã¾ã—ãŸ');
                    }

                    // Packery ã§ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåˆæœŸåŒ–
                    const pckry = new Packery(grid, {
                        itemSelector: '.col-md-6, .col-lg-4',
                        percentPosition: true,
                        transitionDuration: '0.25s'
                    });

                    // å„ã‚«ãƒ¼ãƒ‰ã‚’ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ã«è¨­å®š
                    const itemElems = pckry.getItemElements();
                    itemElems.forEach(function (itemElem) {
                        const draggie = new Draggabilly(itemElem, {
                            handle: '.card-handle'
                        });
                        // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†æ™‚ã«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’æ›´æ–°
                        pckry.bindDraggabillyEvents(draggie);

                        // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†æ™‚ã«DOMé †åºã‚’æ›´æ–°ã—ã¦ä¿å­˜
                        draggie.on('dragEnd', function () {
                            // Packeryã®ã‚¢ã‚¤ãƒ†ãƒ é †åºã§DOMé †åºã‚’æ›´æ–°
                            const items = pckry.getItemElements();
                            items.forEach(item => {
                                grid.appendChild(item);
                            });
                            // é †åºã‚’ä¿å­˜
                            saveCardOrder();
                        });
                    });

                    // ç›£è¦–å¯¾è±¡ã® textarea ã‚’å–å¾—ï¼ˆã‚«ãƒ¼ãƒ‰å†…ã® textarea å…¨ã¦ï¼‰
                    const textareas = Array.from(grid.querySelectorAll('textarea'));
                    let layoutTimer = null;
                    const scheduleLayout = () => {
                        if (layoutTimer) clearTimeout(layoutTimer);
                        layoutTimer = setTimeout(() => pckry.layout(), 120);
                    };

                    if (typeof ResizeObserver !== 'undefined') {
                        const ro = new ResizeObserver(scheduleLayout);
                        textareas.forEach(t => ro.observe(t));
                    } else {
                        // ResizeObserver ãŒç„¡ã„å ´åˆã¯ input/resize ã§ä»£æ›¿
                        textareas.forEach(t => t.addEventListener('input', scheduleLayout));
                        window.addEventListener('resize', scheduleLayout);
                    }

                    // å†…å®¹å¤‰æ›´ã§ã‚‚å†ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
                    textareas.forEach(t => t.addEventListener('input', scheduleLayout));

                    // åˆå›ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
                    setTimeout(() => pckry.layout(), 300);
                }

                setup();
            })();
        });

        // ãƒ–ãƒ©ã‚¦ã‚¶ãƒã‚§ãƒƒã‚¯é–¢æ•°
        function checkBrowser() {
            // Chrome/Chromiumãƒ™ãƒ¼ã‚¹ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‹ãƒã‚§ãƒƒã‚¯
            const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
            const isEdge = /Edg/.test(navigator.userAgent);
            const isBrave = navigator.brave !== undefined;

            // Chromeã€Edgeã€Braveã¯è¨±å¯ï¼ˆã™ã¹ã¦Chromiumãƒ™ãƒ¼ã‚¹ï¼‰
            if (isChrome || isEdge || isBrave) {
                console.log('äº’æ›æ€§ã®ã‚ã‚‹ãƒ–ãƒ©ã‚¦ã‚¶ã§ã™:', navigator.userAgent);
                return;
            }

            // Chromeä»¥å¤–ã®å ´åˆã€è­¦å‘Šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            console.warn('Chromeä»¥å¤–ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã™:', navigator.userAgent);
            const browserWarningModal = new bootstrap.Modal(document.getElementById('browserWarningModal'));
            browserWarningModal.show();
        }

        // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³æ©Ÿèƒ½ã®åˆæœŸåŒ–ï¼ˆå…¨ã‚«ãƒ¼ãƒ‰å¯¾è±¡ï¼‰
        function initAccordionButtons() {
            const COLLAPSE_STATE_KEY = 'dashboard_card_collapse_state';

            // ä¿å­˜ã•ã‚ŒãŸæœ€å°åŒ–çŠ¶æ…‹ã‚’å¾©å…ƒ
            function restoreCollapseState() {
                try {
                    const savedState = localStorage.getItem(COLLAPSE_STATE_KEY);
                    if (!savedState) return;

                    const stateObj = JSON.parse(savedState);
                    Object.keys(stateObj).forEach(cardId => {
                        const cards = document.querySelectorAll('.card');
                        cards.forEach(card => {
                            const header = card.querySelector('.card-header');
                            const h6 = header?.querySelector('h6');
                            if (h6 && h6.textContent.trim() === cardId && stateObj[cardId] === true) {
                                const cardBody = card.querySelector('.card-body');
                                const toggleBtn = header.querySelector('.accordion-toggle');
                                if (cardBody && toggleBtn) {
                                    cardBody.classList.add('collapsed');
                                    toggleBtn.classList.add('collapsed');
                                }
                            }
                        });
                    });
                } catch (e) {
                    console.error('æœ€å°åŒ–çŠ¶æ…‹ã®å¾©å…ƒã«å¤±æ•—:', e);
                }
            }

            // æœ€å°åŒ–çŠ¶æ…‹ã‚’ä¿å­˜
            function saveCollapseState() {
                try {
                    const stateObj = {};
                    const cards = document.querySelectorAll('.card');
                    cards.forEach(card => {
                        const header = card.querySelector('.card-header');
                        const h6 = header?.querySelector('h6');
                        const cardBody = card.querySelector('.card-body');
                        if (h6 && cardBody) {
                            const cardId = h6.textContent.trim();
                            stateObj[cardId] = cardBody.classList.contains('collapsed');
                        }
                    });
                    localStorage.setItem(COLLAPSE_STATE_KEY, JSON.stringify(stateObj));
                } catch (e) {
                    console.error('æœ€å°åŒ–çŠ¶æ…‹ã®ä¿å­˜ã«å¤±æ•—:', e);
                }
            }

            // ã™ã¹ã¦ã®ã‚«ãƒ¼ãƒ‰ãƒ˜ãƒƒãƒ€ãƒ¼ã«ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ï¼ˆdashboard-gridå†…ã®ã‚«ãƒ¼ãƒ‰ã®ã¿ï¼‰
            const grid = document.querySelector('#dashboard-grid');
            if (!grid) {
                console.warn('dashboard-gridãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            const cardHeaders = grid.querySelectorAll('.card-header');
            console.log(`ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ãƒœã‚¿ãƒ³ã‚’${cardHeaders.length}å€‹ã®ã‚«ãƒ¼ãƒ‰ã«è¿½åŠ ã—ã¾ã™`);

            cardHeaders.forEach(header => {
                // ã™ã§ã«ãƒœã‚¿ãƒ³ãŒã‚ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                if (header.querySelector('.accordion-toggle')) {
                    console.log('æ—¢ã«ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ãƒœã‚¿ãƒ³ãŒå­˜åœ¨ã—ã¾ã™');
                    return;
                }

                // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ãƒœã‚¿ãƒ³ã‚’ä½œæˆ
                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'accordion-toggle';
                toggleBtn.innerHTML = '<i class="bi bi-chevron-down"></i>';
                toggleBtn.setAttribute('type', 'button');
                toggleBtn.setAttribute('aria-label', 'ã‚«ãƒ¼ãƒ‰ã‚’æœ€å°åŒ–/å±•é–‹');

                // ãƒ˜ãƒƒãƒ€ãƒ¼ã®æœ€åˆã«æŒ¿å…¥ï¼ˆprependã‚’ä½¿ç”¨ï¼‰
                if (header.firstChild) {
                    header.insertBefore(toggleBtn, header.firstChild);
                } else {
                    header.appendChild(toggleBtn);
                }

                // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
                toggleBtn.addEventListener('click', function (e) {
                    e.stopPropagation(); // ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆã¨å¹²æ¸‰ã—ãªã„ã‚ˆã†ã«
                    const card = header.closest('.card');
                    const cardBody = card.querySelector('.card-body');

                    if (cardBody) {
                        cardBody.classList.toggle('collapsed');
                        toggleBtn.classList.toggle('collapsed');

                        // æœ€å°åŒ–çŠ¶æ…‹ã‚’ä¿å­˜
                        saveCollapseState();

                        // Packeryãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’æ›´æ–°ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
                        const grid = document.querySelector('#dashboard-grid');
                        if (grid && window.packeryInstance) {
                            setTimeout(() => window.packeryInstance.layout(), 100);
                        }
                    }
                });
            });

            // ä¿å­˜ã•ã‚ŒãŸæœ€å°åŒ–çŠ¶æ…‹ã‚’å¾©å…ƒ
            restoreCollapseState();
        }

        // ãƒšãƒ¼ã‚¸ãŒé–‰ã˜ã‚‰ã‚Œã‚‹å‰ã«ã‚½ã‚±ãƒƒãƒˆã‚’é–‰ã˜ã‚‹
        window.addEventListener('beforeunload', () => {
            stopAutoPosting(); // è‡ªå‹•æŠ•ç¨¿ã‚’åœæ­¢
            if (socket) {
                socket.close();
            }
        });

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // ä¿å­˜ã•ã‚ŒãŸã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’èª­ã¿è¾¼ã¿
            const savedSystemPrompt = loadSystemPrompt();
            textareaSystemPrompt.value = savedSystemPrompt;

            // AIåã‚’èª­ã¿è¾¼ã¿
            const savedAiName = loadAiName();
            textAiName.value = savedAiName;
            aiName = savedAiName;

            // URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è¨­å®š
            const urlParams = getURLParams();
            if (urlParams.room) {
                textRoomName.value = urlParams.room;
            }

            // åˆæœŸåŒ–å®Œäº†ã®ãƒ­ã‚°
            addLog('è¨­å®šã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ', 'info');
        });
    </script>

</body>

</html>
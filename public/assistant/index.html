<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="../assets/css/custom.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js"
        integrity="sha384-GNFwBvfVxBkLMJpYMOABq3c+d3KnQxudP/mGPkzpZSTYykLBNsZEnG2D9G/X/+7D" crossorigin="anonymous"
        async></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@500&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/ed72a65202.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <meta charset="utf-8">
    <style>
        .card {
            animation: fadeIn 1.0s ease 0.0s 1 normal;
            transition: all 0.5s;
        }

        @keyframes fadeIn {
            0% {
                opacity: 0
            }

            100% {
                opacity: 1
            }
        }

        .transition_all {
            transition: all 0.5s;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-connected {
            background-color: #28a745;
        }

        .status-disconnected {
            background-color: #dc3545;
        }

        .status-processing {
            background-color: #ffc107;
        }

        .log-container {
            max-height: 300px;
            overflow-y: auto;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .log-entry {
            margin-bottom: 5px;
            white-space: pre-wrap;
        }

        .log-received {
            color: #0066cc;
        }

        .log-sent {
            color: #28a745;
        }

        .log-error {
            color: #dc3545;
        }

        .log-info {
            color: #6c757d;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <p><img class="mt-3 mb-1" src="../assets/logo_text.png" height="50px"><span class="badge bg-secondary">AI
                Assistant</span></p>

        <div class="row">
            <div class="col-12">
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <span id="status-indicator" class="status-indicator status-disconnected"></span>
                            Êé•Á∂öÁä∂ÊÖã: <span id="status-text">Êé•Á∂öÂæÖÊ©ü‰∏≠</span>
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="input-group mb-3">
                            <span class="input-group-text">ÈÉ®Â±ãÂêç</span>
                            <input class="form-control" type="text" id="text_room_name" placeholder="ÈÖç‰ø°‰∏≠„ÅÆÈÉ®Â±ãÂêç„ÅåËá™ÂãïÂÖ•Âäõ„Åï„Çå„Åæ„Åô"
                                value="">
                            <button class="btn btn-outline-primary" id="button_connect">Êé•Á∂ö</button>
                        </div>


                        <div class="row" data-masonry='{"percentPosition": true }'>
                            <div class="col-md-6 col-lg-4">
                                <div class="card border-info mb-3">
                                    <div class="card-header bg-info bg-opacity-10">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">AIË®≠ÂÆö</h6>

                                        </div>
                                    </div>

                                    <div class="card-body">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" role="switch"
                                                id="checkbox_auto_response" checked>
                                            <label class="small form-check-label" for="checkbox_auto_response"
                                                id="label_auto_response">
                                                „ÄåÁ±≥Â§™ÈÉé„Äç„ÇíÂê´„ÇÄ„Ç≥„É°„É≥„Éà„Å´Ëá™ÂãïÂøúÁ≠î
                                            </label>
                                        </div>
                                        <hr>
                                        <div class="input-group mb-3">
                                            <span class="input-group-text">LM Studio URL</span>
                                            <input class="form-control" type="text" id="text_lm_studio_url"
                                                value="http://127.0.0.1:1234/v1">
                                            <button class="btn btn-outline-secondary"
                                                id="button_test_lm_studio">„ÉÜ„Çπ„Éà</button>
                                        </div>


                                        <div class="input-group mb-3">
                                            <span class="input-group-text">AI„Ç¢„Ç∑„Çπ„Çø„É≥„ÉàÂêç</span>
                                            <input class="form-control" type="text" id="text_ai_name"
                                                placeholder="AI„Ç¢„Ç∑„Çπ„Çø„É≥„ÉàÂêç„ÇíÂÖ•Âäõ">
                                        </div>

                                        <div class="input-group mb-3">
                                            <span class="input-group-text">ÊñáÂ≠óÁßªÂãïÊñπÂêë</span>
                                            <select class="form-select" id="select_text_direction">
                                                <option value="still">ÈùôÊ≠¢</option>
                                                <option value="up">‚Üë</option>
                                                <option value="down">‚Üì</option>
                                                <option value="left" selected>‚Üê</option>
                                                <option value="right">‚Üí</option>
                                            </select>
                                            <span class="input-group-text">ÊñáÂ≠óËâ≤</span>
                                            <input type="color" class="form-control form-control-color"
                                                id="input_text_color" value="#FFD700" title="ÊñáÂ≠óËâ≤„ÇíÈÅ∏Êäû">
                                        </div>

                                        <div class="input-group mb-3">
                                            <span class="input-group-text">Max History</span>
                                            <input type="number" class="form-control"
                                                id="input_conversation_history_limit" value="50" min="0" max="200">
                                            <span class="input-group-text bg-light">
                                                <span id="span_current_history_count">0</span>‰ª∂
                                            </span>
                                            <button class="btn btn-outline-secondary btn-sm" id="button_clear_history">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>

                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <label for="textarea_system_prompt" class="form-label mb-0">‰∫ãÂâçÁü•Ë≠ò</label>
                                                <button class="btn btn-sm btn-outline-secondary"
                                                    id="button_reset_system_prompt">
                                                    <i class="bi bi-arrow-clockwise"></i>default
                                                </button>
                                            </div>
                                            <textarea class="form-control" id="textarea_system_prompt" rows="8"
                                                placeholder="AI„ÅÆÂΩπÂâ≤„ÇÑÊåØ„ÇãËàû„ÅÑ„ÄÅ‰∫ãÂâçÁü•Ë≠ò„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ">„ÅÇ„Å™„Åü„ÅÆÂêçÂâç„ÅØ{AI_NAME}„Åß„Åô„ÄÇË¶™„Åó„Åø„ÇÑ„Åô„ÅèË¶™Âàá„Å™AI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Åß„Åô„ÄÇ„Ç≥„É°„É≥„ÉàÁîªÈù¢„Å´ÊµÅ„Çå„Çã„Åü„ÇÅ„ÄÅËøîÁ≠î„ÅØÂøÖ„Åö120ÊñáÂ≠ó‰ª•ÂÜÖ„ÅÆÁü≠„ÅÑ‰∏ÄÊñá„Åß„ÅäÁ≠î„Åà„Åè„Å†„Åï„ÅÑ„ÄÇ</textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-4">
                                <div class="card border-success mb-3">
                                    <div class="card-header bg-success bg-opacity-10">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">Èü≥Â£∞Ë™çË≠ò</h6>
                                            <span class="small text-danger"><i class="bi bi-info-circle"></i>
                                                Èü≥Â£∞Ë™çË≠ò„ÅØChrome„ÅÆ„Åø</span>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox"
                                                id="checkbox_ai_name_auto_response" checked>
                                            <label class="form-check-label small" for="checkbox_ai_name_auto_response"
                                                id="label_ai_name_auto_response">
                                                „ÄåÁ±≥Â§™ÈÉé„Äç„ÇíÂê´„ÇÄÈü≥Â£∞Ë™çË≠ò„ÇíËá™Âãï„ÅßAI„Å´ÈÄÅ‰ø°
                                            </label>
                                        </div>
                                        <hr>
                                        <div class="input-group mb-3">
                                            <span class="input-group-text">„Éû„Ç§„ÇØÈÅ∏Êäû</span>
                                            <select class="form-select" id="select_microphone">
                                                <option value="">„Éû„Ç§„ÇØ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                                            </select>
                                            <button class="btn btn-outline-secondary"
                                                id="button_refresh_mics">Êõ¥Êñ∞</button>
                                        </div>

                                        <div class="input-group mb-3">
                                            <span class="input-group-text">Ë®ÄË™û</span>
                                            <select class="form-select" id="select_speech_language">
                                                <option value="ja-JP">Êó•Êú¨Ë™û</option>
                                                <option value="en-US">English (US)</option>
                                                <option value="en-GB">English (UK)</option>
                                                <option value="zh-CN">‰∏≠Êñá (ÁÆÄ‰Ωì)</option>
                                                <option value="ko-KR">ÌïúÍµ≠Ïñ¥</option>
                                            </select>
                                        </div>

                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <label for="input_speech_interim" class="form-label mb-0">
                                                    „É™„Ç¢„É´„Çø„Ç§„É†Ë™çË≠ò
                                                    <small class="text-muted">(Êö´ÂÆöÁµêÊûú)</small>
                                                </label>
                                                <div class="d-flex gap-2">
                                                    <button class="btn btn-sm btn-success" id="button_start_speech">
                                                        <i class="bi bi-mic"></i> ÈñãÂßã
                                                    </button>
                                                    <button class="btn btn-sm btn-danger" id="button_stop_speech"
                                                        disabled>
                                                        <i class="bi bi-mic-mute"></i> ÂÅúÊ≠¢
                                                    </button>
                                                </div>
                                            </div>
                                            <input type="text" class="form-control bg-light" id="input_speech_interim"
                                                placeholder="Èü≥Â£∞Ë™çË≠ò‰∏≠„ÅÆÊö´ÂÆöÁµêÊûú„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô" readonly>
                                        </div>

                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <label for="textarea_speech_result" class="form-label mb-0">
                                                    Á¢∫ÂÆöÁµêÊûú
                                                </label>
                                                <div class="d-flex gap-2">
                                                    <button class="btn btn-sm btn-outline-secondary"
                                                        id="button_clear_speech">
                                                        <i class="bi bi-trash"></i> „ÇØ„É™„Ç¢
                                                    </button>
                                                </div>
                                            </div>
                                            <textarea class="form-control" id="textarea_speech_result" rows="4"
                                                placeholder="Á¢∫ÂÆö„Åó„ÅüÈü≥Â£∞Ë™çË≠ò„ÅÆÁµêÊûú„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô" readonly></textarea>
                                        </div>

                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox"
                                                id="checkbox_continuous_speech" checked>
                                            <label class="form-check-label" for="checkbox_continuous_speech">
                                                ÈÄ£Á∂öË™çË≠ò„É¢„Éº„Éâ
                                            </label>
                                        </div>



                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-4">
                                <div class="card border-warning mb-3">
                                    <div class="card-header bg-warning bg-opacity-10">
                                        <h6 class="mb-0">Ëá™ÂãïÊäïÁ®øÊ©üËÉΩÔºàÊéàÊ•≠Áõõ„Çä‰∏ä„ÅíÔºâ</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input" type="checkbox" id="checkbox_auto_posting">
                                            <label class="small form-check-label" for="checkbox_auto_posting">
                                                ÂÆöÊúüÁöÑ„Å´Ëá™Âãï„Åß„Ç≥„É°„É≥„Éà„ÇíÊäïÁ®ø
                                            </label>
                                        </div>

                                        <div class="row mb-2">
                                            <div class="col-6">
                                                <label for="range_posting_interval_min"
                                                    class="form-label">ÊúÄÂ∞èÈñìÈöîÔºàÂàÜÔºâ</label>
                                                <input type="range" class="form-range" id="range_posting_interval_min"
                                                    min="1" max="10" value="2">
                                                <small class="text-muted"><span id="span_interval_min">2</span>ÂàÜ</small>
                                            </div>
                                            <div class="col-6">
                                                <label for="range_posting_interval_max"
                                                    class="form-label">ÊúÄÂ§ßÈñìÈöîÔºàÂàÜÔºâ</label>
                                                <input type="range" class="form-range" id="range_posting_interval_max"
                                                    min="5" max="20" value="8">
                                                <small class="text-muted"><span id="span_interval_max">8</span>ÂàÜ</small>
                                            </div>
                                        </div>
                                        <hr>

                                        <div class="mb-2">
                                            <label for="select_posting_style" class="form-label">ÊäïÁ®ø„Çπ„Çø„Ç§„É´</label>
                                            <select class="form-select form-select-sm" id="select_posting_style">
                                                <option value="mixed">„Éü„ÉÉ„ÇØ„ÇπÔºàÊéàÊ•≠Èñ¢ÈÄ£ÔºãÈõëË´áÔºâ</option>
                                                <option value="academic">ÊéàÊ•≠Èñ¢ÈÄ£„ÅÆ„Åø</option>
                                                <option value="casual">ÈõëË´á„ÅÆ„Åø</option>
                                                <option value="reaction">„É™„Ç¢„ÇØ„Ç∑„Éß„É≥„ÅÆ„Åø</option>
                                            </select>
                                        </div>

                                        <button class="btn btn-sm btn-outline-success" id="button_test_auto_posting">
                                            „ÉÜ„Çπ„ÉàÊäïÁ®ø
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-4">
                                <!-- „Ç≥„É°„É≥„Éà„É≠„Ç∞„Ç´„Éº„Éâ -->
                                <div class="card mb-3">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">„Ç≥„É°„É≥„Éà„É≠„Ç∞</h6>
                                        <div>
                                            <button class="btn btn-sm btn-outline-primary me-1"
                                                id="button_sync_comments" title="„Çµ„Éº„Éê„Éº„Åã„Çâ„É≠„Ç∞„ÇíÂêåÊúü">
                                                <i class="bi bi-arrow-clockwise"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-primary me-1"
                                                id="button_download_comments" title="„É≠„Ç∞„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ">
                                                <i class="bi bi-download"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-success me-1" id="button_download_csv"
                                                title="„É¶„Éº„Ç∂„ÉºÂà•ÈõÜË®àCSV„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ">
                                                <i class="bi bi-file-earmark-spreadsheet"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-secondary" id="button_clear_comments">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <textarea id="textarea_comment_log" readonly class="form-control" rows="6"
                                            placeholder="Âèó‰ø°„Åó„Åü„Ç≥„É°„É≥„Éà„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô"></textarea>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6 col-lg-4">
                                <!-- ÂèÇÂä†ËÄÖÊï∞„Ç∞„É©„Éï -->
                                <div class="card mb-3">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">
                                            <i class="bi bi-people-fill"></i> ÂèÇÂä†ËÄÖÊï∞„ÅÆÊé®Áßª
                                        </h6>
                                        <button class="btn btn-sm btn-outline-primary" id="button_download_user_stats">
                                            <i class="bi bi-download"></i> CSV
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="userStatsChart" style="max-height: 300px;"></canvas>
                                        <div class="text-muted small mt-2">
                                            <i class="bi bi-info-circle"></i>
                                            ÂèÇÂä†ËÄÖ„ÅÆÂÖ•ÈÄÄÂÆ§„Åå„É™„Ç¢„É´„Çø„Ç§„É†„ÅßË®òÈå≤„Åï„Çå„Åæ„Åô
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6 col-lg-4">
                                <!-- „Ç≥„É≥„ÉÜ„Ç≠„Çπ„ÉàÈï∑„Ç∞„É©„Éï -->
                                <div class="card mb-3">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">
                                            <i class="bi bi-chat-dots"></i> AI„Éà„Éº„ÇØ„É≥Êï∞„ÅÆÊé®Áßª
                                        </h6>
                                        <button class="btn btn-sm btn-outline-primary"
                                            id="button_download_context_stats">
                                            <i class="bi bi-download"></i> CSV
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="contextStatsChart" style="max-height: 300px;"></canvas>
                                        <div class="text-muted small mt-2">
                                            <i class="bi bi-info-circle"></i>
                                            LM Studio„Å´ÈÄÅ‰ø°„Åô„Çã„Éà„Éº„ÇØ„É≥Êï∞ÔºàÊé®ÂÆöÔºâ„Åå„É™„Ç¢„É´„Çø„Ç§„É†„ÅßË®òÈå≤„Åï„Çå„Åæ„Åô
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6 col-lg-4">
                                <!-- Ê¥ªÂãï„É≠„Ç∞ -->
                                <div class="card mb-3">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">Ê¥ªÂãï„É≠„Ç∞</h6>
                                        <button class="btn btn-sm btn-outline-secondary" id="button_clear_log">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <div id="log-container" class="log-container"></div>
                                    </div>
                                </div>
                            </div>
                        </div>


                    </div>
                </div>


            </div>
        </div>

        <hr>

        <footer class="page-footer font-small">
            <div class="footer-copyright small text-center">
                Commentable Kometaro AI Assistant<br>
                &copy; 2025 <a href="https://tetsuakibaba.jp">Tetsuaki Baba</a>
            </div>
        </footer>
    </div>

    <!-- Scripts -->
    <!-- <script src="../p5.min.js"></script> -->
    <script src="/socket.io/socket.io.js"></script>

    <script>
        // „Éá„Éï„Ç©„É´„Éà„ÅÆ„Ç∑„Çπ„ÉÜ„É†„Éó„É≠„É≥„Éó„Éà
        const DEFAULT_SYSTEM_PROMPT = '„ÅÇ„Å™„Åü„ÅÆÂêçÂâç„ÅØ{AI_NAME}„Åß„Åô„ÄÇË¶™„Åó„Åø„ÇÑ„Åô„ÅèË¶™Âàá„Å™AI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Åß„Åô„ÄÇ„Ç≥„É°„É≥„ÉàÁîªÈù¢„Å´ÊµÅ„Çå„Çã„Åü„ÇÅ„ÄÅËøîÁ≠î„ÅØÂøÖ„Åö120ÊñáÂ≠ó‰ª•ÂÜÖ„ÅÆÁü≠„ÅÑ‰∏ÄÊñá„Åß„ÅäÁ≠î„Åà„Åè„Å†„Åï„ÅÑ„ÄÇ';

        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let socket;
        let isConnected = false;
        let isAutoResponse = true;
        let isAutoPosting = false;
        let autoPostingTimer = null;
        let lmStudioUrl = 'http://127.0.0.1:1234/v1';
        let aiName = localStorage.getItem('aiAssistantName') || 'Á±≥Â§™ÈÉé';
        let aiTextDirection = 'left';
        let aiTextColor = '#FFD700';
        let roomName = '';
        let postingIntervalMin = 2; // ÂàÜ
        let postingIntervalMax = 8; // ÂàÜ
        let postingStyle = 'mixed';

        // Èü≥Â£∞Ë™çË≠òÈñ¢ÈÄ£„ÅÆÂ§âÊï∞
        let speechRecognition = null;
        let isRecognizing = false;
        let recognitionLanguage = 'ja-JP';
        let isContinuous = true;
        // isAutoSendSpeech removed per user request
        let isAiNameAutoResponse = true; // AI„Ç¢„Ç∑„Çπ„Çø„É≥„ÉàÂêç„ÇíÂê´„ÇÄÈü≥Â£∞Ë™çË≠ò„ÅÆËá™ÂãïÂøúÁ≠î
        let selectedMicrophoneId = null;
        let conversationHistory = []; // ‰ºöË©±Â±•Ê≠¥„Çí‰øùÂ≠ò
        let conversationHistoryLimit = 50; // Â±•Ê≠¥‰øùÂ≠òÊï∞„ÅÆ‰∏äÈôê
        let commentLog = []; // „Ç≥„É°„É≥„Éà„É≠„Ç∞„Çí‰øùÂ≠òÔºàË°®Á§∫Áî®„ÉÜ„Ç≠„Çπ„ÉàÔºâ
        let commentLogJSON = []; // „Ç≥„É°„É≥„Éà„É≠„Ç∞„ÅÆJSONÂΩ¢Âºè„Éá„Éº„ÇøÔºà„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÁî®Ôºâ
        let commentCount = 0; // ÊäïÁ®ø„Åï„Çå„Åü„Ç≥„É°„É≥„ÉàÊï∞„Çí„Ç´„Ç¶„É≥„Éà

        // ÂèÇÂä†ËÄÖÊï∞Áµ±Ë®àÈñ¢ÈÄ£„ÅÆÂ§âÊï∞
        let userStatsChart = null;
        let userStatsHistory = []; // { timestamp, count } „ÅÆÈÖçÂàó

        // „Éà„Éº„ÇØ„É≥Êï∞Áµ±Ë®àÈñ¢ÈÄ£„ÅÆÂ§âÊï∞
        let contextStatsChart = null;
        let contextStatsHistory = []; // { timestamp, tokens } „ÅÆÈÖçÂàó

        // DOMË¶ÅÁ¥†
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        const logContainer = document.getElementById('log-container');
        const textRoomName = document.getElementById('text_room_name');
        const textLmStudioUrl = document.getElementById('text_lm_studio_url');
        const textAiName = document.getElementById('text_ai_name');
        const selectTextDirection = document.getElementById('select_text_direction');
        const inputTextColor = document.getElementById('input_text_color');
        const textareaSystemPrompt = document.getElementById('textarea_system_prompt');
        const buttonResetSystemPrompt = document.getElementById('button_reset_system_prompt');
        const checkboxAutoResponse = document.getElementById('checkbox_auto_response');
        const buttonConnect = document.getElementById('button_connect');
        const buttonClearLog = document.getElementById('button_clear_log');
        const buttonTestLMStudio = document.getElementById('button_test_lm_studio');

        // Ëá™ÂãïÊäïÁ®øÈñ¢ÈÄ£„ÅÆDOMË¶ÅÁ¥†
        const checkboxAutoPosting = document.getElementById('checkbox_auto_posting');
        const rangePostingIntervalMin = document.getElementById('range_posting_interval_min');
        const rangePostingIntervalMax = document.getElementById('range_posting_interval_max');
        const spanIntervalMin = document.getElementById('span_interval_min');
        const spanIntervalMax = document.getElementById('span_interval_max');
        const selectPostingStyle = document.getElementById('select_posting_style');
        const buttonTestAutoPosting = document.getElementById('button_test_auto_posting');

        // Èü≥Â£∞Ë™çË≠òÈñ¢ÈÄ£„ÅÆDOMË¶ÅÁ¥†
        const selectMicrophone = document.getElementById('select_microphone');
        const buttonRefreshMics = document.getElementById('button_refresh_mics');
        const selectSpeechLanguage = document.getElementById('select_speech_language');
        const buttonStartSpeech = document.getElementById('button_start_speech');
        const buttonStopSpeech = document.getElementById('button_stop_speech');
        const buttonClearSpeech = document.getElementById('button_clear_speech');
        const inputSpeechInterim = document.getElementById('input_speech_interim');
        const textareaSpeechResult = document.getElementById('textarea_speech_result');
        const checkboxContinuousSpeech = document.getElementById('checkbox_continuous_speech');
        const checkboxAiNameAutoResponse = document.getElementById('checkbox_ai_name_auto_response');
        const labelAiNameAutoResponse = document.getElementById('label_ai_name_auto_response');
        const inputConversationHistoryLimit = document.getElementById('input_conversation_history_limit');
        const spanCurrentHistoryCount = document.getElementById('span_current_history_count');
        const buttonClearHistory = document.getElementById('button_clear_history');

        // „Ç≥„É°„É≥„Éà„É≠„Ç∞Èñ¢ÈÄ£„ÅÆDOMË¶ÅÁ¥†
        const textareaCommentLog = document.getElementById('textarea_comment_log');
        const buttonDownloadComments = document.getElementById('button_download_comments');
        const buttonDownloadCsv = document.getElementById('button_download_csv');
        const buttonClearComments = document.getElementById('button_clear_comments');

        // URL „Éë„É©„É°„Éº„Çø„ÇíÂèñÂæó„Åó„Å¶„É´„Éº„É†Âêç„ÇíË®≠ÂÆö
        function getURLParams() {
            const params = new URLSearchParams(window.location.search);
            const result = {};
            for (const [key, value] of params) {
                result[key] = value;
            }
            return result;
        }

        // AI„Ç¢„Ç∑„Çπ„Çø„É≥„ÉàÂêç„ÇílocalStorage„Å´‰øùÂ≠ò
        function saveAiName(name) {
            if (name && name.trim() !== '') {
                localStorage.setItem('aiAssistantName', name.trim());
                addLog(`AIÂêç„Äå${name.trim()}„Äç„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü`, 'info');
            }
        }

        // AI„Ç¢„Ç∑„Çπ„Çø„É≥„ÉàÂêç„ÇílocalStorage„Åã„ÇâÂèñÂæó
        function loadAiName() {
            const savedName = localStorage.getItem('aiAssistantName');
            if (savedName) {
                addLog(`‰øùÂ≠ò„Åï„Çå„ÅüAIÂêç„Äå${savedName}„Äç„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü`, 'info');
                return savedName;
            }
            return 'Á±≥Â§™ÈÉé'; // „Éá„Éï„Ç©„É´„ÉàÂÄ§
        }

        // „Ç∑„Çπ„ÉÜ„É†„Éó„É≠„É≥„Éó„Éà„ÇílocalStorage„Å´‰øùÂ≠ò
        function saveSystemPrompt(prompt) {
            if (prompt && prompt.trim() !== '') {
                localStorage.setItem('systemPrompt', prompt.trim());
                addLog('„Ç∑„Çπ„ÉÜ„É†„Éó„É≠„É≥„Éó„Éà„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'info');
            }
        }

        // „Ç∑„Çπ„ÉÜ„É†„Éó„É≠„É≥„Éó„Éà„ÇílocalStorage„Åã„ÇâÂèñÂæó
        function loadSystemPrompt() {
            const savedPrompt = localStorage.getItem('systemPrompt');
            if (savedPrompt) {
                addLog('‰øùÂ≠ò„Åï„Çå„Åü„Ç∑„Çπ„ÉÜ„É†„Éó„É≠„É≥„Éó„Éà„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü', 'info');
                return savedPrompt;
            }
            return DEFAULT_SYSTEM_PROMPT; // „Éá„Éï„Ç©„É´„ÉàÂÄ§
        }

        // „Ç∑„Çπ„ÉÜ„É†„Éó„É≠„É≥„Éó„Éà„Çí„Éá„Éï„Ç©„É´„Éà„Å´„É™„Çª„ÉÉ„Éà
        function resetSystemPrompt() {
            textareaSystemPrompt.value = DEFAULT_SYSTEM_PROMPT;
            localStorage.removeItem('systemPrompt');
            addLog('„Ç∑„Çπ„ÉÜ„É†„Éó„É≠„É≥„Éó„Éà„Çí„Éá„Éï„Ç©„É´„Éà„Å´„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü', 'info');
        }

        // ÂèÇÂä†ËÄÖÊï∞„Ç∞„É©„Éï„ÅÆÂàùÊúüÂåñ
        function initUserStatsChart() {
            const ctx = document.getElementById('userStatsChart').getContext('2d');
            userStatsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'ÂèÇÂä†ËÄÖÊï∞',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            ticks: {
                                maxTicksLimit: 10
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }

        // „Éà„Éº„ÇØ„É≥Êï∞„Ç∞„É©„Éï„ÅÆÂàùÊúüÂåñ
        function initContextStatsChart() {
            const ctx = document.getElementById('contextStatsChart').getContext('2d');
            contextStatsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '„Éà„Éº„ÇØ„É≥Êï∞ÔºàÊé®ÂÆöÔºâ',
                        data: [],
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 200
                            }
                        },
                        x: {
                            ticks: {
                                maxTicksLimit: 10
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }

        // ÂèÇÂä†ËÄÖÊï∞„ÅÆÊõ¥Êñ∞
        function updateUserStats(count) {
            const timestamp = new Date();
            const timeString = timestamp.toLocaleTimeString('ja-JP');

            // Â±•Ê≠¥„Å´ËøΩÂä†
            userStatsHistory.push({
                timestamp: timestamp.toISOString(),
                count: count
            });

            // „Ç∞„É©„Éï„Å´ËøΩÂä†
            if (userStatsChart) {
                userStatsChart.data.labels.push(timeString);
                userStatsChart.data.datasets[0].data.push(count);

                // ÊúÄÂ§ß50„Éù„Ç§„É≥„Éà„Å´Âà∂Èôê
                if (userStatsChart.data.labels.length > 50) {
                    userStatsChart.data.labels.shift();
                    userStatsChart.data.datasets[0].data.shift();
                }

                userStatsChart.update();
            }
        }

        // „Éà„Éº„ÇØ„É≥Êï∞„ÅÆÊõ¥Êñ∞
        function updateContextStats(tokens) {
            const timestamp = new Date();
            const timeString = timestamp.toLocaleTimeString('ja-JP');

            // Â±•Ê≠¥„Å´ËøΩÂä†
            contextStatsHistory.push({
                timestamp: timestamp.toISOString(),
                tokens: tokens
            });

            // „Ç∞„É©„Éï„Å´ËøΩÂä†
            if (contextStatsChart) {
                contextStatsChart.data.labels.push(timeString);
                contextStatsChart.data.datasets[0].data.push(tokens);

                // ÊúÄÂ§ß50„Éù„Ç§„É≥„Éà„Å´Âà∂Èôê
                if (contextStatsChart.data.labels.length > 50) {
                    contextStatsChart.data.labels.shift();
                    contextStatsChart.data.datasets[0].data.shift();
                }

                contextStatsChart.update();
            }
        }

        // ÂèÇÂä†ËÄÖÊï∞Áµ±Ë®à„ÅÆCSV„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
        function downloadUserStatsCSV() {
            if (userStatsHistory.length === 0) {
                alert('„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }

            // CSV„Éò„ÉÉ„ÉÄ„Éº
            let csvContent = '„Çø„Ç§„É†„Çπ„Çø„É≥„Éó,ÂèÇÂä†ËÄÖÊï∞\n';

            // „Éá„Éº„ÇøË°å
            userStatsHistory.forEach(item => {
                const timestamp = new Date(item.timestamp).toLocaleString('ja-JP');
                csvContent += `${timestamp},${item.count}\n`;
            });

            // BOM„ÇíËøΩÂä†„Åó„Å¶Excel„ÅßÊ≠£„Åó„ÅèÈñã„Åë„Çã„Çà„ÅÜ„Å´„Åô„Çã
            const bom = '\uFEFF';
            const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ÂèÇÂä†ËÄÖÊï∞Áµ±Ë®à_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();
            URL.revokeObjectURL(url);

            addLog('ÂèÇÂä†ËÄÖÊï∞Áµ±Ë®à„ÇíCSV„Åß„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü', 'info');
        }

        // „Éà„Éº„ÇØ„É≥Êï∞Áµ±Ë®à„ÅÆCSV„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
        function downloadContextStatsCSV() {
            if (contextStatsHistory.length === 0) {
                alert('„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }

            // CSV„Éò„ÉÉ„ÉÄ„Éº
            let csvContent = '„Çø„Ç§„É†„Çπ„Çø„É≥„Éó,„Éà„Éº„ÇØ„É≥Êï∞ÔºàÊé®ÂÆöÔºâ\n';

            // „Éá„Éº„ÇøË°å
            contextStatsHistory.forEach(item => {
                const timestamp = new Date(item.timestamp).toLocaleString('ja-JP');
                csvContent += `${timestamp},${item.tokens}\n`;
            });

            // BOM„ÇíËøΩÂä†„Åó„Å¶Excel„ÅßÊ≠£„Åó„ÅèÈñã„Åë„Çã„Çà„ÅÜ„Å´„Åô„Çã
            const bom = '\uFEFF';
            const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `„Éà„Éº„ÇØ„É≥Êï∞Áµ±Ë®à_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();
            URL.revokeObjectURL(url);

            addLog('„Éà„Éº„ÇØ„É≥Êï∞Áµ±Ë®à„ÇíCSV„Åß„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü', 'info');
        }

        // ‰ºöË©±Â±•Ê≠¥„ÇíÊñáÂ≠óÂàó„Å®„Åó„Å¶Êï¥ÂΩ¢
        function formatConversationHistory() {
            if (conversationHistory.length === 0) {
                return "„Åì„Çå„Åæ„Åß„ÅÆ‰ºöË©±Â±•Ê≠¥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ";
            }
            const recentHistory = conversationHistory; // ÂÖ®„Å¶„ÅÆÂ±•Ê≠¥„Çí‰ΩøÁî®
            const formattedHistory = recentHistory.map(item => {
                const time = new Date(item.timestamp).toLocaleTimeString();
                if (item.type === 'user') {
                    return `[${time}] ${item.content}`;
                } else {
                    return `[${time}] ${aiName}: ${item.content}`;
                }
            }).join('\n');

            return `„Åì„Çå„Åæ„Åß„ÅÆ‰ºöË©±Â±•Ê≠¥:\n${formattedHistory}`;
        }

        // „Ç≥„É°„É≥„Éà„É≠„Ç∞„Å´ËøΩÂä†
        function addToCommentLog(data) {
            const timestamp = new Date();
            commentCount++; // „Ç≥„É°„É≥„ÉàÊï∞„Çí„Ç§„É≥„ÇØ„É™„É°„É≥„Éà

            // JSONÂΩ¢Âºè„Éá„Éº„Çø„Çí‰øùÂ≠òÔºà„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÁî®Ôºâ
            const jsonData = {
                timestamp: data.timestamp || timestamp.toISOString(),
                room: data.room || roomName || 'unknown',
                username: data.my_name || data.name || 'ÂåøÂêç',
                comment: data.comment || '',
                emoji: data.flg_emoji || false,
                sound: data.flg_sound || false,
                socketid: data.socketid || '',
                source: data.source || 'comment' // 'speech' or 'comment'
            };
            commentLogJSON.push(jsonData);

            // ÂΩ¢Âºè: [2025:08:26:21:06:19-0005] üòÆ [sound][ÂåøÂêç]
            const year = timestamp.getFullYear();
            const month = String(timestamp.getMonth() + 1).padStart(2, '0');
            const day = String(timestamp.getDate()).padStart(2, '0');
            const hour = String(timestamp.getHours()).padStart(2, '0');
            const minute = String(timestamp.getMinutes()).padStart(2, '0');
            const second = String(timestamp.getSeconds()).padStart(2, '0');
            const commentCountStr = String(commentCount).padStart(4, '0');
            const timeStr = `${year}:${month}:${day}:${hour}:${minute}:${second}-${commentCountStr}`;

            let content = '';
            let extraInfo = '';

            // „Ç≥„É°„É≥„ÉàÂÜÖÂÆπ„ÅÆÂá¶ÁêÜ
            if (data.flg_emoji && data.comment) {
                // ÁµµÊñáÂ≠ó„ÅÆÂ†¥Âêà
                content = data.comment;
                extraInfo = data.flg_sound ? '[sound]' : '';
            } else if (data.comment) {
                // ÈÄöÂ∏∏„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„Ç≥„É°„É≥„Éà„ÅÆÂ†¥Âêà
                content = data.comment;
            }

            const logEntry = `[${timeStr}] ${content} ${extraInfo}[${data.my_name || data.name || 'ÂåøÂêç'}]`.trim();
            commentLog.push(logEntry);

            // textarea„ÇíÊõ¥Êñ∞
            textareaCommentLog.value = commentLog.join('\n');
            textareaCommentLog.scrollTop = textareaCommentLog.scrollHeight;
        }

        // „Ç≥„É°„É≥„Éà„É≠„Ç∞„Çí„ÇØ„É™„Ç¢
        function clearCommentLog() {
            commentLog = [];
            commentLogJSON = [];
            commentCount = 0; // „Ç≥„É°„É≥„ÉàÊï∞„ÇÇ„É™„Çª„ÉÉ„Éà
            textareaCommentLog.value = '';
            addLog('„Ç≥„É°„É≥„Éà„É≠„Ç∞„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü', 'info');
        }

        // „Ç≥„É°„É≥„Éà„É≠„Ç∞„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
        function downloadCommentLog() {
            if (commentLogJSON.length === 0) {
                addLog('„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åô„Çã„Ç≥„É°„É≥„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'info');
                return;
            }

            // JSON LinesÂΩ¢ÂºèÔºàÂêÑË°å„Åå1„Å§„ÅÆJSON„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÔºâ„ÅßÂá∫Âäõ
            const jsonLines = commentLogJSON.map(item => JSON.stringify(item)).join('\n');

            const currentTime = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            const roomPrefix = roomName ? `${roomName}_` : '';
            const filename = `${roomPrefix}${currentTime}.log`;

            const blob = new Blob([jsonLines], { type: 'application/json;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            addLog(`„Ç≥„É°„É≥„Éà„É≠„Ç∞„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü: ${filename}`, 'info');
        }

        // „É¶„Éº„Ç∂„ÉºÂà•ÈõÜË®àCSV„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
        function downloadCommentCsv() {
            if (commentLogJSON.length === 0) {
                addLog('„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åô„Çã„Ç≥„É°„É≥„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'info');
                return;
            }

            // „É¶„Éº„Ç∂„Éº„Åî„Å®„Å´ÈõÜË®à
            const userStats = {};

            commentLogJSON.forEach(entry => {
                const username = entry.username || 'ÂåøÂêç';

                if (!userStats[username]) {
                    userStats[username] = {
                        comments: [],
                        emojiCount: 0,
                        textCount: 0,
                        firstTimestamp: entry.timestamp,
                        lastTimestamp: entry.timestamp
                    };
                }

                const stats = userStats[username];
                stats.comments.push(entry.comment);

                // ÁµµÊñáÂ≠ó„Åã„ÉÜ„Ç≠„Çπ„Éà„Åã„Çí„Ç´„Ç¶„É≥„Éà
                if (entry.emoji) {
                    stats.emojiCount++;
                } else {
                    stats.textCount++;
                }

                // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„ÇíÊõ¥Êñ∞
                if (new Date(entry.timestamp) < new Date(stats.firstTimestamp)) {
                    stats.firstTimestamp = entry.timestamp;
                }
                if (new Date(entry.timestamp) > new Date(stats.lastTimestamp)) {
                    stats.lastTimestamp = entry.timestamp;
                }
            });

            // CSV„Éò„ÉÉ„ÉÄ„Éº
            let csvContent = 'Â≠¶‰øÆÁï™Âè∑/ÊäïÁ®øËÄÖ,„Ç≥„É°„É≥„ÉàÂÜÖÂÆπÔºà„Ç´„É≥„ÉûÂå∫Âàá„ÇäÔºâ,„Ç≥„É°„É≥„ÉàÊï∞,ÁµµÊñáÂ≠óÊï∞,„ÉÜ„Ç≠„Çπ„ÉàÊï∞,ÊúÄÂàù„ÅÆÊäïÁ®øÊôÇÂàª,ÊúÄÂæå„ÅÆÊäïÁ®øÊôÇÂàª\n';

            // „É¶„Éº„Ç∂„Éº„Åî„Å®„Å´CSVË°å„ÇíÁîüÊàê
            Object.entries(userStats).forEach(([username, stats]) => {
                const commentsStr = stats.comments.join(', ');
                const totalCount = stats.emojiCount + stats.textCount;

                // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„Çí„Éï„Ç©„Éº„Éû„ÉÉ„Éà
                const formatTimestamp = (isoString) => {
                    const date = new Date(isoString);
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hour = String(date.getHours()).padStart(2, '0');
                    const minute = String(date.getMinutes()).padStart(2, '0');
                    const second = String(date.getSeconds()).padStart(2, '0');
                    return `${year}:${month}:${day}:${hour}:${minute}:${second}`;
                };

                const firstTime = formatTimestamp(stats.firstTimestamp);
                const lastTime = formatTimestamp(stats.lastTimestamp);

                // CSV„ÅÆÂÄ§„Çí„Ç®„Çπ„Ç±„Éº„ÉóÔºà„Ç´„É≥„Éû„ÇÑÊîπË°å„ÄÅ„ÉÄ„Éñ„É´„ÇØ„Ç©„Éº„Éà„ÇíÂê´„ÇÄÂ†¥ÂêàÔºâ
                const escapeCsv = (str) => {
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return `"${str.replace(/"/g, '""')}"`;
                    }
                    return str;
                };

                csvContent += `${escapeCsv(username)},${escapeCsv(commentsStr)},${totalCount},${stats.emojiCount},${stats.textCount},${firstTime},${lastTime}\n`;
            });

            // CSV„Éï„Ç°„Ç§„É´„Å®„Åó„Å¶„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
            const currentTime = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            const roomPrefix = roomName ? `${roomName}_` : '';
            const filename = `${roomPrefix}user_stats_${currentTime}.csv`;

            // BOMÔºàByte Order MarkÔºâ„ÇíËøΩÂä†„Åó„Å¶UTF-8„ÅßÊñáÂ≠óÂåñ„Åë„ÇíÈò≤„Åê
            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            const blob = new Blob([bom, csvContent], { type: 'text/csv;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            addLog(`„É¶„Éº„Ç∂„ÉºÂà•ÈõÜË®àCSV„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü: ${filename}`, 'info');
        }

        // „Çµ„Éº„Éê„Éº„Åã„Çâ„Ç≥„É°„É≥„Éà„É≠„Ç∞„ÇíÂêåÊúü
        async function syncCommentsFromServer(showAlert = true) {
            try {
                const roomName = textRoomName.value.trim();

                if (!roomName) {
                    if (showAlert) {
                        alert('ÈÉ®Â±ãÂêç„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
                    }
                    addLog('ÂêåÊúüÂ§±Êïó: ÈÉ®Â±ãÂêç„ÅåÊú™Ë®≠ÂÆö', 'error');
                    return;
                }

                // „Éï„Ç°„Ç§„É´Âêç„Å®„Åó„Å¶ÂÆâÂÖ®„Å™ÊñáÂ≠óÂàó„Å´Â§âÊèõ
                const safeRoomName = roomName.replace(/[^a-zA-Z0-9_-]/g, '_');

                addLog(`„Çµ„Éº„Éê„Éº„Åã„Çâ„É≠„Ç∞„ÇíÂêåÊúü‰∏≠: ${roomName}`, 'info');

                // „Çµ„Éº„Éê„Éº„Åã„Çâ„ÉÅ„É£„ÉÉ„Éà„É≠„Ç∞„ÇíÂèñÂæó
                const response = await fetch(`/chatlogs/${safeRoomName}.log`);

                if (!response.ok) {
                    if (response.status === 404) {
                        if (showAlert) {
                            alert('„Åæ„Å†„Åì„ÅÆÈÉ®Â±ã„ÅÆ„É≠„Ç∞„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
                        }
                        addLog('ÂêåÊúü: „É≠„Ç∞„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', 'info');
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const logContent = await response.text();
                const lines = logContent.trim().split('\n').filter(line => line.length > 0);

                // commentLog„Å®commentLogJSON„Çí„ÇØ„É™„Ç¢„Åó„Å¶„ÄÅ„Çµ„Éº„Éê„Éº„Åã„ÇâÂèñÂæó„Åó„Åü„É≠„Ç∞„ÅßÁΩÆ„ÅçÊèõ„Åà
                commentLog = [];
                commentLogJSON = [];
                conversationHistory = []; // ‰ºöË©±Â±•Ê≠¥„ÇÇ„ÇØ„É™„Ç¢
                let maxCount = 0;

                lines.forEach((line, index) => {
                    try {
                        // Á©∫Ë°å„ÇÑ‰∏çÊ≠£„Å™Ë°å„Çí„Çπ„Ç≠„ÉÉ„Éó
                        const trimmedLine = line.trim();
                        if (!trimmedLine || !trimmedLine.startsWith('{')) {
                            return;
                        }

                        const entry = JSON.parse(trimmedLine);

                        // JSONÂΩ¢Âºè„Éá„Éº„Çø„Çí‰øùÂ≠òÔºà„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÁî®Ôºâ
                        commentLogJSON.push(entry);

                        const timestamp = new Date(entry.timestamp);
                        const year = timestamp.getFullYear();
                        const month = String(timestamp.getMonth() + 1).padStart(2, '0');
                        const day = String(timestamp.getDate()).padStart(2, '0');
                        const hour = String(timestamp.getHours()).padStart(2, '0');
                        const minute = String(timestamp.getMinutes()).padStart(2, '0');
                        const second = String(timestamp.getSeconds()).padStart(2, '0');

                        // „Ç´„Ç¶„É≥„Éà„Çí„Ç§„É≥„ÇØ„É™„É°„É≥„Éà
                        maxCount++;
                        const commentCountStr = String(maxCount).padStart(4, '0');
                        const timeStr = `${year}:${month}:${day}:${hour}:${minute}:${second}-${commentCountStr}`;

                        const emoji = entry.emoji ? '' : '';
                        const sound = entry.sound ? '[sound]' : '';
                        const formattedLine = `[${timeStr}] ${entry.comment} ${emoji}${sound}[${entry.username}]`.trim();
                        commentLog.push(formattedLine);

                        // ‰ºöË©±Â±•Ê≠¥„Å´ËøΩÂä†ÔºàAI„Ç¢„Ç∑„Çπ„Çø„É≥„ÉàËá™Ë∫´„ÅÆ„Ç≥„É°„É≥„Éà„ÅØÈô§Â§ñÔºâ
                        if (entry.username !== aiName) {
                            // ÁµµÊñáÂ≠ó„ÅÆ„Åø„ÅÆ„Ç≥„É°„É≥„Éà„ÅØ‰ºöË©±Â±•Ê≠¥„Åã„ÇâÈô§Â§ñ
                            if (!entry.emoji) {
                                // source„Éï„Ç£„Éº„É´„Éâ„ÅßË©±ËÄÖ„ÇíÂà§Âà•Ôºàspeech=ÈÖç‰ø°ËÄÖ, comment=ÂèÇÂä†ËÄÖÔºâ
                                const speaker = entry.source === 'speech' ? 'ÈÖç‰ø°ËÄÖ' : 'ÂèÇÂä†ËÄÖ';
                                // Èü≥Â£∞Ë™çË≠òÔºàÈÖç‰ø°ËÄÖÔºâ„ÅÆÂ†¥Âêà„ÅØ„É¶„Éº„Ç∂„ÉºÂêç„Å™„Åó„ÄÅ„Ç≥„É°„É≥„ÉàÔºàÂèÇÂä†ËÄÖÔºâ„ÅÆÂ†¥Âêà„ÅØ„É¶„Éº„Ç∂„ÉºÂêç„ÅÇ„Çä
                                const content = entry.source === 'speech'
                                    ? entry.comment
                                    : `${entry.username}: ${entry.comment}`;
                                conversationHistory.push({
                                    type: 'user',
                                    content: content,
                                    timestamp: entry.timestamp,
                                    speaker: speaker
                                });
                            }
                        } else {
                            // AI„Ç¢„Ç∑„Çπ„Çø„É≥„ÉàËá™Ë∫´„ÅÆ„Ç≥„É°„É≥„Éà„ÅØassistant„Å®„Åó„Å¶ËøΩÂä†ÔºàÁµµÊñáÂ≠ó„ÅÆ„Åø„ÅØÈô§Â§ñÔºâ
                            if (!entry.emoji) {
                                conversationHistory.push({
                                    type: 'assistant',
                                    content: entry.comment,
                                    timestamp: entry.timestamp
                                });
                            }
                        }
                    } catch (e) {
                        console.warn(`Skipping invalid log entry at line ${index + 1}:`, line.substring(0, 100), e.message);
                    }
                });

                // ‰ºöË©±Â±•Ê≠¥„Åå‰∏äÈôê„ÇíË∂Ö„Åà„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÊúÄÊñ∞„ÅÆ„ÇÇ„ÅÆ„Å†„ÅëÊÆã„Åô
                if (conversationHistory.length > conversationHistoryLimit) {
                    conversationHistory = conversationHistory.slice(-conversationHistoryLimit);
                    addLog(`‰ºöË©±Â±•Ê≠¥„ÇíÊúÄÊñ∞${conversationHistoryLimit}‰ª∂„Å´Ë™øÊï¥„Åó„Åæ„Åó„Åü`, 'info');
                }

                // commentCount„ÇíÊõ¥Êñ∞
                commentCount = maxCount;

                // textarea„ÇíÊõ¥Êñ∞
                textareaCommentLog.value = commentLog.join('\n');
                textareaCommentLog.scrollTop = textareaCommentLog.scrollHeight;

                // ‰ºöË©±Â±•Ê≠¥Êï∞„ÇíÊõ¥Êñ∞
                updateCurrentHistoryCount();

                addLog(`${lines.length}‰ª∂„ÅÆ„Ç≥„É°„É≥„Éà„ÇíÂêåÊúü„Åó„Åæ„Åó„ÅüÔºà‰ºöË©±Â±•Ê≠¥: ${conversationHistory.length}‰ª∂Ôºâ`, 'info');

            } catch (error) {
                console.error('Error syncing comments:', error);
                if (showAlert) {
                    alert('„Çµ„Éº„Éê„Éº„Åã„Çâ„Ç≥„É°„É≥„Éà„ÅÆÂêåÊúü„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
                }
                addLog(`ÂêåÊúü„Ç®„É©„Éº: ${error.message}`, 'error');
            }
        }

        // „É≠„Ç∞Âá∫ÂäõÈñ¢Êï∞
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // „Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞
        function updateStatus(status, text) {
            statusIndicator.className = `status-indicator status-${status}`;
            statusText.textContent = text;
        }

        // Ëá™ÂãïÊäïÁ®øÁî®„ÅÆ„Éó„É≠„É≥„Éó„ÉàÁîüÊàê
        function generateAutoPostPrompt(style) {
            const prompts = {
                mixed: [
                    "ÊéàÊ•≠„ÅÆÈõ∞Âõ≤Ê∞ó„ÇíÁõõ„Çä‰∏ä„Åí„Çã„Çà„ÅÜ„Å™Áü≠„ÅÑ„Ç≥„É°„É≥„Éà„Çí„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
                    "Â≠¶Áîü„ÅåËààÂë≥„ÇíÊåÅ„Å°„Åù„ÅÜ„Å™ÈõëË´á„Çí120ÊñáÂ≠ó‰ª•ÂÜÖ„Åß„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
                    "ÊéàÊ•≠„Å´Èñ¢ÈÄ£„Åô„ÇãÈù¢ÁôΩ„ÅÑË±ÜÁü•Ë≠ò„ÇíÁü≠„ÅèÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
                    "‰ªäÊó•„ÅÆÊ∞óÂàÜ„ÇÑÂ§©Ê∞ó„Å´„Å§„ÅÑ„Å¶ËªΩ„Åè„Ç≥„É°„É≥„Éà„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
                    "ÂãâÂº∑„ÅÆ„É¢„ÉÅ„Éô„Éº„Ç∑„Éß„É≥„Åå‰∏ä„Åå„Çã„Çà„ÅÜ„Å™ÂøúÊè¥„Ç≥„É°„É≥„Éà„Çí„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
                ],
                academic: [
                    "ÊéàÊ•≠„Å´Èñ¢ÈÄ£„Åô„ÇãËààÂë≥Ê∑±„ÅÑË©±È°å„Çí120ÊñáÂ≠ó‰ª•ÂÜÖ„ÅßÊèê‰æõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
                    "Â≠¶Áøí„Å´ÂΩπÁ´ã„Å§Ë±ÜÁü•Ë≠ò„ÇíÁü≠„ÅèÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
                    "ÊéàÊ•≠„ÅÆÂÜÖÂÆπ„Å´Èñ¢ÈÄ£„Åô„ÇãË≥™Âïè„ÇíÊäï„Åí„Åã„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
                    "Â≠¶Áøí„ÅÆ„Ç≥„ÉÑ„ÇíÁü≠„Åè„Ç¢„Éâ„Éê„Ç§„Çπ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
                ],
                casual: [
                    "‰ªäÊó•„ÅÆÊ∞óÂàÜ„Å´„Å§„ÅÑ„Å¶ËªΩ„Åè„Ç≥„É°„É≥„Éà„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
                    "Â≠£ÁØÄ„ÇÑÂ§©Ê∞ó„Å´„Å§„ÅÑ„Å¶Áü≠„ÅèË©±„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
                    "Èù¢ÁôΩ„ÅÑÈõëË´á„Çí120ÊñáÂ≠ó‰ª•ÂÜÖ„Åß„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
                    "Â≠¶ÁîüÁîüÊ¥ª„ÅÆË©±È°å„ÅßËªΩ„ÅèÁõõ„Çä‰∏ä„Åí„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
                ],
                reaction: "REACTION_MODE" // ÁâπÂà•„Å™„Éû„Éº„Ç´„Éº
            };

            if (style === 'reaction') {
                return prompts.reaction;
            }

            const stylePrompts = prompts[style] || prompts.mixed;
            const randomPrompt = stylePrompts[Math.floor(Math.random() * stylePrompts.length)];

            // ÊåáÁ§∫„ÅÆ„Åø„ÇíËøî„ÅôÔºà‰ºöË©±Â±•Ê≠¥„ÅØbuildPrompt()„ÅßÂá¶ÁêÜ„Åï„Çå„ÇãÔºâ
            return randomPrompt;
        }

        // „É™„Ç¢„ÇØ„Ç∑„Éß„É≥Â∞ÇÁî®„ÅÆÈÄÅ‰ø°Èñ¢Êï∞
        function sendRandomReaction() {
            // ÁµµÊñáÂ≠ó„É™„Ç¢„ÇØ„Ç∑„Éß„É≥Ôºà„Çµ„Ç§„É¨„É≥„ÉàÔºâ
            const emojiReactions = ['üëç', 'üôè', 'üôã', 'ü•∫', 'ü§´'];

            // „Çµ„Ç¶„É≥„Éâ„É™„Ç¢„ÇØ„Ç∑„Éß„É≥ÔºàÈü≥‰ªò„ÅçÔºâ
            const soundReactions = [
                { emoji: 'üì∏', id: 0 },  // „Ç´„É°„É©
                { emoji: 'üëè', id: 1 },  // ÊãçÊâã
                { emoji: 'üéâ', id: 2 },  // „ÇØ„É©„ÉÉ„Ç´„Éº
                { emoji: 'ü•≥', id: 3 },  // Â§ßÊ≠ìÂ£∞
                { emoji: 'üòÆ', id: 4 },  // „Å∏„Åá„Äú
                { emoji: 'ü§î', id: 5 },  // „Å°„Çá„Å£„Å®„Åæ„Å£„Å¶
                { emoji: 'üëå', id: 6 },  // OK
                { emoji: 'üëä', id: 7 },  // „Éë„É≥„ÉÅ
                { emoji: 'ü§£', id: 8 },  // Â§ßÁ¨ë„ÅÑ
                { emoji: 'üòè', id: 9 }   // w
            ];

            // 70%„ÅÆÁ¢∫Áéá„ÅßÁµµÊñáÂ≠ó„É™„Ç¢„ÇØ„Ç∑„Éß„É≥„ÄÅ30%„ÅÆÁ¢∫Áéá„Åß„Çµ„Ç¶„É≥„Éâ„É™„Ç¢„ÇØ„Ç∑„Éß„É≥
            const useSound = Math.random() < 0.3;

            let data;
            if (useSound) {
                // „Çµ„Ç¶„É≥„Éâ„É™„Ç¢„ÇØ„Ç∑„Éß„É≥
                const reaction = soundReactions[Math.floor(Math.random() * soundReactions.length)];
                data = {
                    my_name: aiName,
                    comment: reaction.emoji,
                    flg_emoji: true,
                    flg_sound: true,
                    id_sound: reaction.id,
                    color_text: aiTextColor,
                    color_text_stroke: '#111111',
                    text_direction: aiTextDirection,
                    flg_speech: false,
                    hidden: -1
                };
                addLog(`„Çµ„Ç¶„É≥„Éâ„É™„Ç¢„ÇØ„Ç∑„Éß„É≥ÈÄÅ‰ø°: ${reaction.emoji} (ID: ${reaction.id})`, 'sent');
            } else {
                // ÁµµÊñáÂ≠ó„É™„Ç¢„ÇØ„Ç∑„Éß„É≥
                const emoji = emojiReactions[Math.floor(Math.random() * emojiReactions.length)];
                data = {
                    my_name: aiName,
                    comment: emoji,
                    flg_emoji: true,
                    flg_sound: false,
                    id_sound: 0,
                    color_text: aiTextColor,
                    color_text_stroke: '#111111',
                    text_direction: aiTextDirection,
                    flg_speech: false,
                    hidden: -1
                };
                addLog(`ÁµµÊñáÂ≠ó„É™„Ç¢„ÇØ„Ç∑„Éß„É≥ÈÄÅ‰ø°: ${emoji}`, 'sent');
            }

            if (socket && isConnected) {
                socket.emit('comment', data);
                // „É™„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇÇ„Ç≥„É°„É≥„Éà„É≠„Ç∞„Å´ËøΩÂä†
                addToCommentLog(data);
            }
        }

        // Ëá™ÂãïÊäïÁ®ø„ÇíÂÆüË°å
        async function executeAutoPosting() {
            if (!isConnected || !isAutoPosting) {
                return;
            }

            try {
                addLog('Ëá™ÂãïÊäïÁ®ø„ÇíÂÆüË°å‰∏≠...', 'info');

                if (postingStyle === 'reaction') {
                    // „É™„Ç¢„ÇØ„Ç∑„Éß„É≥„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÅØÁµµÊñáÂ≠ó/„Çµ„Ç¶„É≥„Éâ„É™„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÈÄÅ‰ø°
                    sendRandomReaction();
                } else {
                    // „Åù„ÅÆ‰ªñ„ÅÆ„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÅØ„ÉÜ„Ç≠„Çπ„Éà„Ç≥„É°„É≥„Éà„ÇíÁîüÊàê
                    const prompt = generateAutoPostPrompt(postingStyle);
                    const aiResponse = await sendToLMStudio(prompt);

                    // ÊäïÁ®ø
                    setTimeout(() => {
                        sendComment(aiResponse);
                        // Ëá™ÂãïÊäïÁ®ø„Åï„Çå„Åü„Ç≥„É°„É≥„Éà„ÇÇ‰ºöË©±Â±•Ê≠¥„Å´ËøΩÂä†
                        addToConversationHistory('assistant', aiResponse);
                        addLog(`Ëá™ÂãïÊäïÁ®øÂÆå‰∫Ü: ${aiResponse}`, 'info');
                    }, 500);
                }

            } catch (error) {
                addLog(`Ëá™ÂãïÊäïÁ®ø„Ç®„É©„Éº: ${error.message}`, 'error');
            }

            // Ê¨°„ÅÆÊäïÁ®ø„Çí„Çπ„Ç±„Ç∏„É•„Éº„É´
            scheduleNextAutoPosting();
        }        // Ê¨°„ÅÆËá™ÂãïÊäïÁ®ø„Çí„Çπ„Ç±„Ç∏„É•„Éº„É´
        function scheduleNextAutoPosting() {
            if (!isAutoPosting) {
                return;
            }

            // „É©„É≥„ÉÄ„É†„Å™ÈñìÈöî„ÇíË®àÁÆóÔºàÂàÜÂçò‰Ωç„Çí„Éü„É™Áßí„Å´Â§âÊèõÔºâ
            const minMs = postingIntervalMin * 60 * 1000;
            const maxMs = postingIntervalMax * 60 * 1000;
            const randomInterval = Math.floor(Math.random() * (maxMs - minMs)) + minMs;

            const nextPostTime = new Date(Date.now() + randomInterval);
            addLog(`Ê¨°„ÅÆËá™ÂãïÊäïÁ®ø‰∫àÂÆö: ${nextPostTime.toLocaleTimeString()} (${Math.floor(randomInterval / 60000)}ÂàÜÂæå)`, 'info');

            autoPostingTimer = setTimeout(executeAutoPosting, randomInterval);
        }

        // Ëá™ÂãïÊäïÁ®ø„ÇíÈñãÂßã
        function startAutoPosting() {
            if (!isConnected) {
                addLog('„Çµ„Éº„Éê„Å´Êé•Á∂ö„Åó„Å¶„Åã„ÇâËá™ÂãïÊäïÁ®ø„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                checkboxAutoPosting.checked = false;
                return;
            }

            isAutoPosting = true;
            addLog('Ëá™ÂãïÊäïÁ®ø„ÇíÈñãÂßã„Åó„Åæ„Åó„Åü', 'info');
            scheduleNextAutoPosting();
        }

        // Ëá™ÂãïÊäïÁ®ø„ÇíÂÅúÊ≠¢
        function stopAutoPosting() {
            isAutoPosting = false;
            if (autoPostingTimer) {
                clearTimeout(autoPostingTimer);
                autoPostingTimer = null;
            }
            addLog('Ëá™ÂãïÊäïÁ®ø„ÇíÂÅúÊ≠¢„Åó„Åæ„Åó„Åü', 'info');
        }

        // „ÉÜ„Çπ„ÉàÊäïÁ®ø
        async function testAutoPosting() {
            if (!isConnected) {
                alert('„Çµ„Éº„Éê„Å´Êé•Á∂ö„Åó„Å¶„Åã„Çâ„ÉÜ„Çπ„Éà„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            try {
                addLog('„ÉÜ„Çπ„ÉàÊäïÁ®ø„ÇíÂÆüË°å‰∏≠...', 'info');

                if (postingStyle === 'reaction') {
                    // „É™„Ç¢„ÇØ„Ç∑„Éß„É≥„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÅØÁµµÊñáÂ≠ó/„Çµ„Ç¶„É≥„Éâ„É™„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÈÄÅ‰ø°
                    sendRandomReaction();
                } else {
                    // „Åù„ÅÆ‰ªñ„ÅÆ„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÅØ„ÉÜ„Ç≠„Çπ„Éà„Ç≥„É°„É≥„Éà„ÇíÁîüÊàê
                    const prompt = generateAutoPostPrompt(postingStyle);
                    const aiResponse = await sendToLMStudio(prompt);

                    setTimeout(() => {
                        sendComment(aiResponse);
                        addLog(`„ÉÜ„Çπ„ÉàÊäïÁ®øÂÆå‰∫Ü: ${aiResponse}`, 'info');
                    }, 500);
                }

            } catch (error) {
                addLog(`„ÉÜ„Çπ„ÉàÊäïÁ®ø„Ç®„É©„Éº: ${error.message}`, 'error');
            }
        }

        // „Éû„Ç§„ÇØ„Éá„Éê„Ç§„Çπ‰∏ÄË¶ß„ÇíÂèñÂæó
        async function refreshMicrophones() {
            // Èü≥Â£∞Ë™çË≠ò„Åå„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                return;
            }

            try {
                // „Éû„Ç§„ÇØ„Å∏„ÅÆ„Ç¢„ÇØ„Çª„ÇπË®±ÂèØ„ÇíË¶ÅÊ±Ç
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop()); // „Çπ„Éà„É™„Éº„É†„ÇíÂÅúÊ≠¢

                // „Éá„Éê„Ç§„Çπ‰∏ÄË¶ß„ÇíÂèñÂæó
                const devices = await navigator.mediaDevices.enumerateDevices();
                const audioInputs = devices.filter(device => device.kind === 'audioinput');

                // „Çª„É¨„ÇØ„Éà„Éú„ÉÉ„ÇØ„Çπ„Çí„ÇØ„É™„Ç¢
                selectMicrophone.innerHTML = '<option value="">„Éá„Éï„Ç©„É´„Éà„Éû„Ç§„ÇØ</option>';

                // „Éû„Ç§„ÇØ„Éá„Éê„Ç§„Çπ„ÇíËøΩÂä†
                audioInputs.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.textContent = device.label || `„Éû„Ç§„ÇØ ${device.deviceId.substring(0, 8)}`;
                    selectMicrophone.appendChild(option);
                });

                addLog(`${audioInputs.length}ÂÄã„ÅÆ„Éû„Ç§„ÇØ„Éá„Éê„Ç§„Çπ„ÇíÊ§úÂá∫„Åó„Åæ„Åó„Åü`, 'info');

            } catch (error) {
                addLog(`„Éû„Ç§„ÇØ„Ç¢„ÇØ„Çª„Çπ„Ç®„É©„Éº: ${error.message}`, 'error');
                alert('„Éû„Ç§„ÇØ„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÅåÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
        }

        // Web Speech API„ÅÆÂàùÊúüÂåñ
        function initializeSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                // „Éñ„É©„Ç¶„Ç∂„ÅÆÂà§ÂÆö
                const isFirefox = navigator.userAgent.toLowerCase().indexOf('firefox') > -1;

                if (isFirefox) {
                    addLog('Firefox„ÅßÈü≥Â£∞Ë™çË≠ò„ÇíÊúâÂäπ„Å´„Åô„Çã„Å´„ÅØ: about:config „Åß„Äåmedia.webspeech.recognition.enable„Äç„Çí true „Å´Ë®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');

                    // ÊÉÖÂ†±„É°„ÉÉ„Çª„Éº„Ç∏„ÇÇÊõ¥Êñ∞
                    const infoMessage = document.getElementById('speech_info_message');
                    if (infoMessage) {
                        infoMessage.innerHTML = '<i class="bi bi-exclamation-triangle text-warning"></i> ' +
                            'Firefox„ÅßÈü≥Â£∞Ë™çË≠ò„Çí‰ΩøÁî®„Åô„Çã„Å´„ÅØ„ÄÅ<code>about:config</code>„ÇíÈñã„Åç„ÄÅ<code>media.webspeech.recognition.enable</code>„Çí<strong>true</strong>„Å´Ë®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ' +
                            '<br><small class="text-muted">Ë®≠ÂÆöÂæå„ÄÅ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</small>';
                    }
                } else {
                    addLog('„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØÈü≥Â£∞Ë™çË≠ò„Çí„Çµ„Éù„Éº„Éà„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇChrome„ÄÅEdge„ÄÅ„Åæ„Åü„ÅØSafari„Çí„ÅîÂà©Áî®„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');

                    // ÊÉÖÂ†±„É°„ÉÉ„Çª„Éº„Ç∏„ÇÇÊõ¥Êñ∞
                    const infoMessage = document.getElementById('speech_info_message');
                    if (infoMessage) {
                        infoMessage.innerHTML = '<i class="bi bi-exclamation-triangle text-warning"></i> ' +
                            'Èü≥Â£∞Ë™çË≠ò„ÅØÁèæÂú®„ÅÆ„Éñ„É©„Ç¶„Ç∂„Åß„ÅØ„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇChrome„ÄÅEdge„ÄÅ„Åæ„Åü„ÅØSafari„Çí„ÅîÂà©Áî®„Åè„Å†„Åï„ÅÑ„ÄÇ';
                    }
                }

                buttonStartSpeech.disabled = true;
                return false;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            speechRecognition = new SpeechRecognition();

            // Âü∫Êú¨Ë®≠ÂÆö
            speechRecognition.continuous = false; // ÂàùÊúü„ÅØÂçòÁô∫„É¢„Éº„Éâ
            speechRecognition.interimResults = true; // ÈÄî‰∏≠ÁµêÊûú„ÇÇË°®Á§∫
            speechRecognition.maxAlternatives = 1;
            speechRecognition.lang = recognitionLanguage;

            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
            speechRecognition.onstart = function () {
                isRecognizing = true;
                buttonStartSpeech.disabled = true;
                buttonStopSpeech.disabled = false;
                addLog('Èü≥Â£∞Ë™çË≠ò„ÇíÈñãÂßã„Åó„Åæ„Åó„Åü', 'info');
            };

            speechRecognition.onresult = function (event) {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                // Êö´ÂÆöÁµêÊûú„ÇíinputË¶ÅÁ¥†„Å´Ë°®Á§∫
                if (interimTranscript) {
                    inputSpeechInterim.value = interimTranscript;
                } else {
                    inputSpeechInterim.value = '';
                }

                // Á¢∫ÂÆöÁµêÊûú„Çí„ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„Å´ËøΩÂä†
                if (finalTranscript) {
                    // Êö´ÂÆöÁµêÊûú„Çí„ÇØ„É™„Ç¢
                    inputSpeechInterim.value = '';

                    const currentText = textareaSpeechResult.value;
                    const newText = currentText ? currentText + '\n' + finalTranscript : finalTranscript;
                    textareaSpeechResult.value = newText;
                    textareaSpeechResult.scrollTop = textareaSpeechResult.scrollHeight;

                    addLog(`Èü≥Â£∞Ë™çË≠òÁµêÊûú: ${finalTranscript}`, 'info');

                    // Èü≥Â£∞Ë™çË≠òÁµêÊûú„Çí„É≠„Ç∞„Å´‰øùÂ≠òÔºàÈÖç‰ø°ËÄÖ„ÅÆÁô∫Ë®Ä„Å®„Åó„Å¶Ôºâ
                    const speechLogData = {
                        my_name: 'ÈÖç‰ø°ËÄÖ',
                        comment: finalTranscript,
                        flg_speech: false,
                        flg_emoji: false,
                        flg_sound: false,
                        source: 'speech'
                    };
                    addToCommentLog(speechLogData);

                    // ‰ºöË©±Â±•Ê≠¥„Å´ÈÖç‰ø°ËÄÖ„ÅÆÁô∫Ë®Ä„Å®„Åó„Å¶ËøΩÂä†Ôºà„É¶„Éº„Ç∂„ÉºÂêç„Å™„ÅóÔºâ
                    addToConversationHistory('user', finalTranscript, 'ÈÖç‰ø°ËÄÖ');

                    // AI„Ç¢„Ç∑„Çπ„Çø„É≥„ÉàÂêç„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØËá™ÂãïÂøúÁ≠îÔºà„Éà„Ç∞„É´Ë®≠ÂÆö„Å´„Çà„ÇãÔºâ
                    if (isAiNameAutoResponse && finalTranscript.includes(aiName)) {
                        addLog(`Èü≥Â£∞Ë™çË≠ò„Åß„Äå${aiName}„Äç„ÇíÊ§úÂá∫„Åó„Åæ„Åó„Åü„ÄÇAIÂá¶ÁêÜ„ÇíÈñãÂßã„Åó„Åæ„Åô„ÄÇ`, 'info');

                        setTimeout(async () => {
                            try {
                                const aiResponse = await sendToLMStudio(finalTranscript);
                                setTimeout(() => {
                                    sendComment(aiResponse, 'speech'); // Èü≥Â£∞Ë™çË≠òÁî±Êù•„Åß„ÅÇ„Çã„Åì„Å®„ÇíÊòéÁ§∫
                                    // AI„ÅÆÂøúÁ≠î„ÇÇ‰ºöË©±Â±•Ê≠¥„Å´ËøΩÂä†
                                    addToConversationHistory('assistant', aiResponse);
                                    addLog(`Èü≥Â£∞Ë™çË≠ò„Åã„Çâ„ÅÆAIÂøúÁ≠î: ${aiResponse}`, 'info');
                                }, 500);
                            } catch (error) {
                                addLog(`Èü≥Â£∞Ë™çË≠ò„Åã„Çâ„ÅÆAIÂøúÁ≠î„Ç®„É©„Éº: ${error.message}`, 'error');
                            }
                        }, 1000);
                    }

                    // Ëá™ÂãïÈÄÅ‰ø°Ê©üËÉΩ„ÅØÂâäÈô§„Åï„Çå„Åæ„Åó„Åü
                }
            };

            speechRecognition.onerror = function (event) {
                // no-speech„Ç®„É©„Éº„ÅÆÂ†¥Âêà„ÅØÁâπÂà•„Å™Âá¶ÁêÜ
                if (event.error === 'no-speech') {
                    addLog('ÁÑ°Èü≥„ÅÆ„Åü„ÇÅÈü≥Â£∞Ë™çË≠ò„ÅåÁµÇ‰∫Ü„Åó„Åæ„Åó„Åü', 'info');
                    resetSpeechRecognition();

                    // ÈÄ£Á∂öË™çË≠ò„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÅØËá™ÂãïÂÜçÈñãÔºàno-speech„ÅØÊ≠£Â∏∏„Å™Âãï‰Ωú„Å®„Åó„Å¶Êâ±„ÅÜÔºâ
                    if (isContinuous) {
                        setTimeout(() => {
                            if (isContinuous) { // ÂÜçÂ∫¶Á¢∫Ë™çÔºà„É¶„Éº„Ç∂„Éº„ÅåÂÅúÊ≠¢„Åó„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøÔºâ
                                addLog('Èü≥Â£∞ÂÖ•Âäõ„ÇíÂÜçÈñã„Åó„Å¶„ÅÑ„Åæ„Åô...', 'info');
                                startSpeechRecognition();
                            }
                        }, 1000); // 1ÁßíÂæÖ„Å£„Å¶„Åã„ÇâÂÜçÈñã
                    }
                    return;
                }

                addLog(`Èü≥Â£∞Ë™çË≠ò„Ç®„É©„Éº: ${event.error}`, 'error');

                // ÂõûÂæ©ÂèØËÉΩ„Å™„Ç®„É©„Éº„Åã„Å©„ÅÜ„Åã„ÇíÂà§ÂÆö
                const recoverableErrors = ['network', 'audio-capture', 'service-not-allowed'];
                const isRecoverable = recoverableErrors.includes(event.error);

                resetSpeechRecognition();

                // ÈÄ£Á∂öË™çË≠ò„É¢„Éº„Éâ„ÅßÂõûÂæ©ÂèØËÉΩ„Å™„Ç®„É©„Éº„ÅÆÂ†¥Âêà„ÅØËá™ÂãïÂÜçÈñã
                if (isContinuous && isRecoverable) {
                    addLog('„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„Åæ„Åü„ÅØÈü≥Â£∞ÂèñÂæó„Ç®„É©„Éº„ÅÆ„Åü„ÇÅ„ÄÅ3ÁßíÂæå„Å´Èü≥Â£∞Ë™çË≠ò„ÇíÂÜçÈñã„Åó„Åæ„Åô...', 'info');
                    setTimeout(() => {
                        if (isContinuous) { // ÂÜçÂ∫¶Á¢∫Ë™çÔºà„É¶„Éº„Ç∂„Éº„ÅåÂÅúÊ≠¢„Åó„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøÔºâ
                            addLog('Èü≥Â£∞Ë™çË≠ò„ÇíËá™ÂãïÂÜçÈñã„Åó„Å¶„ÅÑ„Åæ„Åô...', 'info');
                            startSpeechRecognition();
                        }
                    }, 3000); // 3ÁßíÂæÖ„Å£„Å¶„Åã„ÇâÂÜçÈñã
                } else if (isContinuous && !isRecoverable) {
                    // ÂõûÂæ©‰∏çÂèØËÉΩ„Å™„Ç®„É©„Éº„Åß„ÇÇÈÄ£Á∂ö„É¢„Éº„Éâ„ÅØÁ∂≠ÊåÅ„Åó„ÄÅ5ÁßíÂæå„Å´ÂÜçË©¶Ë°å
                    addLog(`ÂõûÂæ©‰∏çÂèØËÉΩ„Å™„Ç®„É©„Éº: ${event.error}„ÄÇÈÄ£Á∂öË™çË≠ò„É¢„Éº„Éâ„ÇíÁ∂≠ÊåÅ„Åó„ÄÅ5ÁßíÂæå„Å´ÂÜçË©¶Ë°å„Åó„Åæ„Åô„ÄÇ`, 'error');
                    setTimeout(() => {
                        if (isContinuous) {
                            addLog('Èü≥Â£∞Ë™çË≠ò„ÇíÂÜçË©¶Ë°å„Åó„Å¶„ÅÑ„Åæ„Åô...', 'info');
                            startSpeechRecognition();
                        }
                    }, 5000); // 5ÁßíÂæÖ„Å£„Å¶„Åã„ÇâÂÜçÈñã
                }
            };

            speechRecognition.onend = function () {
                // ÈÄ£Á∂ö„É¢„Éº„Éâ„Åã„Å©„ÅÜ„Åã„ÇíÂÖà„Å´Á¢∫Ë™çÔºàresetSpeechRecognitionÂâç„Å´Ôºâ
                const shouldContinue = isContinuous;

                resetSpeechRecognition();

                // ÈÄ£Á∂ö„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÅØËá™ÂãïÁöÑ„Å´ÂÜçÈñã
                if (shouldContinue) {
                    setTimeout(() => {
                        if (isContinuous) { // ÂÜçÂ∫¶Á¢∫Ë™çÔºà„É¶„Éº„Ç∂„Éº„ÅåÂÅúÊ≠¢„Åó„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøÔºâ
                            addLog('Èü≥Â£∞Ë™çË≠ò„ÇíÁ∂ôÁ∂ö„Åó„Å¶„ÅÑ„Åæ„Åô...', 'info');
                            startSpeechRecognition();
                        }
                    }, 500);
                }
            };

            return true;
        }

        // Èü≥Â£∞Ë™çË≠ò„ÅÆ„É™„Çª„ÉÉ„Éà
        function resetSpeechRecognition() {
            isRecognizing = false;
            buttonStartSpeech.disabled = false;
            buttonStopSpeech.disabled = true;
            inputSpeechInterim.value = '';
        }

        // Èü≥Â£∞Ë™çË≠òÈñãÂßã
        function startSpeechRecognition() {
            // Êó¢„Å´Ë™çË≠ò‰∏≠„ÅÆÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
            if (isRecognizing) {
                addLog('Èü≥Â£∞Ë™çË≠ò„ÅØÊó¢„Å´ÈñãÂßã„Åï„Çå„Å¶„ÅÑ„Åæ„Åô', 'info');
                return;
            }

            if (!speechRecognition) {
                if (!initializeSpeechRecognition()) {
                    return;
                }
            }

            // Ë®≠ÂÆö„ÇíÊõ¥Êñ∞
            speechRecognition.lang = recognitionLanguage;
            speechRecognition.continuous = isContinuous;
            speechRecognition.interimResults = true; // ÈÄî‰∏≠ÁµêÊûú„ÅÆË°®Á§∫„ÇíÁ¢∫ÂÆü„Å´ÊúâÂäπÂåñ
            speechRecognition.maxAlternatives = 1;

            try {
                speechRecognition.start();
            } catch (error) {
                addLog(`Èü≥Â£∞Ë™çË≠òÈñãÂßã„Ç®„É©„Éº: ${error.message}`, 'error');
                resetSpeechRecognition();
            }
        }

        // Èü≥Â£∞Ë™çË≠òÂÅúÊ≠¢
        function stopSpeechRecognition() {
            // ÈÄ£Á∂öË™çË≠ò„É¢„Éº„Éâ„ÇíÁÑ°ÂäπÂåñÔºàËá™ÂãïÂÜçÈñã„ÇíÈò≤„ÅêÔºâ
            isContinuous = false;
            checkboxContinuousSpeech.checked = false;

            if (speechRecognition && isRecognizing) {
                speechRecognition.stop();
                addLog('Èü≥Â£∞Ë™çË≠ò„ÇíÂÅúÊ≠¢„Åó„Åæ„Åó„Åü', 'info');
            }
            resetSpeechRecognition();
        }

        // Èü≥Â£∞Ë™çË≠òÁµêÊûú„ÇØ„É™„Ç¢
        function clearSpeechResult() {
            inputSpeechInterim.value = '';
            textareaSpeechResult.value = '';
            addLog('Èü≥Â£∞Ë™çË≠òÁµêÊûú„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü', 'info');
        }

        // ÁèæÂú®„ÅÆ‰ºöË©±Â±•Ê≠¥Êï∞„ÇíÊõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞
        function updateCurrentHistoryCount() {
            if (spanCurrentHistoryCount) {
                spanCurrentHistoryCount.textContent = conversationHistory.length;
            }
        }

        // ‰ºöË©±Â±•Ê≠¥„Å´ËøΩÂä†
        function addToConversationHistory(type, content, speaker = null) {
            const timestamp = new Date().toISOString();
            conversationHistory.push({
                type: type, // 'user' „Åæ„Åü„ÅØ 'assistant'
                content: content,
                timestamp: timestamp,
                speaker: speaker // 'ÈÖç‰ø°ËÄÖ' „Åæ„Åü„ÅØ 'ÂèÇÂä†ËÄÖ'
            });

            // Â±•Ê≠¥Êï∞„ÅÆ‰∏äÈôê„ÇíË∂Ö„Åà„ÅüÂ†¥Âêà„ÄÅÂè§„ÅÑ„ÇÇ„ÅÆ„Åã„ÇâÂâäÈô§
            if (conversationHistory.length > conversationHistoryLimit) {
                conversationHistory = conversationHistory.slice(-conversationHistoryLimit);
            }

            // ÁèæÂú®„ÅÆÂ±•Ê≠¥Êï∞„ÇíÊõ¥Êñ∞
            updateCurrentHistoryCount();

            const speakerLabel = speaker ? `[${speaker}]` : '';
            addLog(`‰ºöË©±Â±•Ê≠¥„Å´ËøΩÂä†: ${speakerLabel}[${type}] ${content.substring(0, 50)}${content.length > 50 ? '...' : ''}`, 'info');
        }

        // ‰ºöË©±Â±•Ê≠¥„Çí„ÇØ„É™„Ç¢
        function clearConversationHistory() {
            conversationHistory = [];
            updateCurrentHistoryCount();
            addLog('‰ºöË©±Â±•Ê≠¥„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü', 'info');
        }

        // „Éó„É≠„É≥„Éó„Éà„ÇíÊßãÁØâÔºàsystem, user, assistant„ÇíÂàÜÈõ¢Ôºâ
        function buildPrompt() {
            // „Ç∑„Çπ„ÉÜ„É†„Éó„É≠„É≥„Éó„Éà: ‰∫ãÂâçÁü•Ë≠ò„ÅÆ„Åø
            let systemPrompt = textareaSystemPrompt.value.trim();
            if (systemPrompt) {
                systemPrompt = systemPrompt.replace(/{AI_NAME}/g, aiName);
            }

            // „Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Éó„É≠„É≥„Éó„Éà: ÈÅéÂéª„ÅÆ‰ºöË©±Â±•Ê≠¥
            let assistantPrompt = '';

            // „É¶„Éº„Ç∂„Éº„Éó„É≠„É≥„Éó„Éà: ÊåáÁ§∫
            let userPrompt = '';

            if (conversationHistory.length > 0) {
                // „Éá„Éê„ÉÉ„Ç∞: ‰ºöË©±Â±•Ê≠¥„ÅÆÂÜÖÂÆπ„ÇíÁ¢∫Ë™ç
                console.log('=== ‰ºöË©±Â±•Ê≠¥„Éá„Éê„ÉÉ„Ç∞ ===');
                conversationHistory.forEach((entry, index) => {
                    console.log(`[${index}] type: ${entry.type}, speaker: ${entry.speaker}, content: ${entry.content.substring(0, 50)}`);
                });
                console.log('===================');

                const historyText = conversationHistory.map(entry => {
                    if (entry.type === 'assistant') {
                        // AI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„ÅÆÂøúÁ≠î
                        return `„Ç¢„Ç∑„Çπ„Çø„É≥„Éà(${aiName}): ${entry.content}`;
                    } else {
                        // „É¶„Éº„Ç∂„Éº„ÅÆÁô∫Ë®Ä
                        if (entry.speaker) {
                            // speaker „Éï„Ç£„Éº„É´„Éâ„Åå„ÅÇ„ÇãÂ†¥ÂêàÔºàÈÖç‰ø°ËÄÖ or ÂèÇÂä†ËÄÖÔºâ
                            return `${entry.speaker}: ${entry.content}`;
                        } else {
                            // speaker „Éï„Ç£„Éº„É´„Éâ„Åå„Å™„ÅÑÂ†¥ÂêàÔºà‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÔºâ
                            return `„É¶„Éº„Ç∂„Éº: ${entry.content}`;
                        }
                    }
                }).join('\n');

                // ÈÅéÂéª„É≠„Ç∞„Çí„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Éó„É≠„É≥„Éó„Éà„Å®„Åó„Å¶Ë®≠ÂÆö
                assistantPrompt = `„ÄêÈÅéÂéª„ÅÆ‰ºöË©±Â±•Ê≠¥„Äë\n${historyText}`;

                // ÊåáÁ§∫„Çí„É¶„Éº„Ç∂„Éº„Éó„É≠„É≥„Éó„Éà„Å®„Åó„Å¶Ë®≠ÂÆö
                userPrompt = '„Åì„Çå„Åæ„Åß„ÅÆ‰ºöË©±„ÅÆÊµÅ„Çå„ÇíËÄÉÊÖÆ„Åó„Å¶„ÄÅËá™ÁÑ∂„ÅßÈÅ©Âàá„Å™„Ç≥„É°„É≥„Éà„Çí„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ120ÊñáÂ≠ó‰ª•ÂÜÖ„ÅßËøîÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
            }

            // „Éá„Éê„ÉÉ„Ç∞: ÂÆåÊàê„Åó„Åü„Éó„É≠„É≥„Éó„Éà„ÇíÁ¢∫Ë™ç
            console.log('=== „Ç∑„Çπ„ÉÜ„É†„Éó„É≠„É≥„Éó„Éà ===');
            console.log(systemPrompt);
            console.log('=== „Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Éó„É≠„É≥„Éó„ÉàÔºàÈÅéÂéª„É≠„Ç∞Ôºâ ===');
            console.log(assistantPrompt);
            console.log('=== „É¶„Éº„Ç∂„Éº„Éó„É≠„É≥„Éó„ÉàÔºàÊåáÁ§∫Ôºâ ===');
            console.log(userPrompt);
            console.log('================================');

            return {
                system: systemPrompt,
                assistant: assistantPrompt,
                user: userPrompt
            };
        }

        // LM Studio Êé•Á∂ö„ÉÜ„Çπ„Éà
        async function testLMStudioConnection() {
            const testUrl = textLmStudioUrl.value.trim();
            addLog(`LM Studio Êé•Á∂ö„ÉÜ„Çπ„Éà„ÇíÈñãÂßã: ${testUrl}`, 'info');

            try {
                const response = await sendToLMStudio('„ÉÜ„Çπ„ÉàÊé•Á∂ö„Åß„Åô„ÄÇ120ÊñáÂ≠ó‰ª•ÂÜÖ„ÅßÁ∞°Âçò„Å´Êå®Êã∂„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                addLog('LM Studio Êé•Á∂ö„ÉÜ„Çπ„ÉàÊàêÂäüÔºÅ', 'info');
                alert('LM Studio „Å∏„ÅÆÊé•Á∂ö„Å´ÊàêÂäü„Åó„Åæ„Åó„ÅüÔºÅ');
            } catch (error) {
                addLog(`LM Studio Êé•Á∂ö„ÉÜ„Çπ„ÉàÂ§±Êïó: ${error.message}`, 'error');
                alert(`LM Studio „Å∏„ÅÆÊé•Á∂ö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`);
            }
        }

        // LM Studio „Å´ API „É™„ÇØ„Ç®„Çπ„Éà„ÇíÈÄÅ‰ø°
        async function sendToLMStudio(message) {
            try {
                addLog(`LM Studio „Å´„É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°: ${message}`, 'info');
                updateStatus('processing', 'AIÂá¶ÁêÜ‰∏≠...');

                // LM Studio „ÅÆÊé•Á∂ö„ÉÜ„Çπ„Éà
                addLog(`Êé•Á∂öÂÖà: ${lmStudioUrl}`, 'info');

                // „Éó„É≠„É≥„Éó„Éà„ÇíÊßãÁØâÔºàsystem, assistant, user„ÇíÂàÜÈõ¢Ôºâ
                const prompts = buildPrompt();

                // „É°„ÉÉ„Çª„Éº„Ç∏ÈÖçÂàó„ÇíÊßãÁØâ
                const messages = [];

                // „Ç∑„Çπ„ÉÜ„É†„Éó„É≠„É≥„Éó„ÉàÔºà‰∫ãÂâçÁü•Ë≠òÔºâ„ÇíËøΩÂä†
                if (prompts.system) {
                    messages.push({
                        role: 'system',
                        content: prompts.system
                    });
                }

                // „Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Éó„É≠„É≥„Éó„ÉàÔºàÈÅéÂéª„É≠„Ç∞Ôºâ„ÇíËøΩÂä†
                if (prompts.assistant) {
                    messages.push({
                        role: 'assistant',
                        content: prompts.assistant
                    });
                }

                // „É¶„Éº„Ç∂„Éº„Éó„É≠„É≥„Éó„ÉàÔºàÊåáÁ§∫ + ‰ªäÂõû„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏Ôºâ„ÇíËøΩÂä†
                let userContent = '';
                if (prompts.user) {
                    // ‰ºöË©±Â±•Ê≠¥„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÊåáÁ§∫„ÇíÂê´„ÇÅ„Çã
                    userContent = prompts.user + '\n\n' + message;
                } else {
                    // ‰ºöË©±Â±•Ê≠¥„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ‰ªäÂõû„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆ„Åø
                    userContent = message;
                }

                messages.push({
                    role: 'user',
                    content: userContent
                });

                // „Éà„Éº„ÇØ„É≥Êï∞„ÇíË®àÁÆó„Åó„Å¶Ë®òÈå≤ÔºàÊñáÂ≠óÊï∞ √∑ 0.75 „ÅßÊé®ÂÆöÔºâ
                const totalCharLength = messages.reduce((sum, msg) => sum + msg.content.length, 0);
                const estimatedTokens = Math.round(totalCharLength / 0.75);
                updateContextStats(estimatedTokens);
                addLog(`Êé®ÂÆö„Éà„Éº„ÇØ„É≥Êï∞: ${estimatedTokens} (ÊñáÂ≠óÊï∞: ${totalCharLength})`, 'info');

                addLog(`ÈÄÅ‰ø°„É°„ÉÉ„Çª„Éº„Ç∏Êï∞: ${messages.length}`, 'info');
                console.log('=== LM Studio„Å´ÈÄÅ‰ø°„Åô„Çã„É°„ÉÉ„Çª„Éº„Ç∏ ===');
                console.log(JSON.stringify(messages, null, 2));
                console.log('====================================');

                const response = await fetch(`${textLmStudioUrl.value.trim()}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer lm-studio'
                    },
                    body: JSON.stringify({
                        model: 'local-model',
                        messages: messages,
                        temperature: 0.7,
                        max_tokens: 4096
                    })
                });

                addLog(`HTTP „É¨„Çπ„Éù„É≥„ÇπÁä∂ÊÖã: ${response.status}`, 'info');

                if (!response.ok) {
                    const errorText = await response.text();
                    addLog(`HTTP „Ç®„É©„ÉºË©≥Á¥∞: ${errorText}`, 'error');
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }

                const data = await response.json();
                addLog(`„É¨„Çπ„Éù„É≥„Çπ„Éá„Éº„Çø: ${JSON.stringify(data)}`, 'info');

                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('Invalid response format from LM Studio');
                }

                const aiResponse = data.choices[0].message.content;

                addLog(`LM Studio „Åã„Çâ„ÅÆÂøúÁ≠î: ${aiResponse}`, 'info');

                // ÊñáÂ≠óÊï∞Âà∂Èôê„ÇíÈÅ©Áî®Ôºà120ÊñáÂ≠ó‰ª•ÂÜÖ„Å´Âàá„ÇäË©∞„ÇÅÔºâ
                let finalResponse = aiResponse.trim();
                if (finalResponse.length > 120) {
                    // 120ÊñáÂ≠ó„ÅßÂàá„ÇäË©∞„ÇÅ„Å¶„ÄÅÂè•Ë™≠ÁÇπ„ÅßËá™ÁÑ∂„Å´Âàá„Çå„Çã‰ΩçÁΩÆ„ÇíÊé¢„Åô
                    let truncated = finalResponse.substring(0, 120);
                    const lastPunctuation = Math.max(
                        truncated.lastIndexOf('„ÄÇ'),
                        truncated.lastIndexOf('ÔºÅ'),
                        truncated.lastIndexOf('Ôºü'),
                        truncated.lastIndexOf('‚ô™'),
                        truncated.lastIndexOf('‚ú®')
                    );

                    if (lastPunctuation > 60) { // 60ÊñáÂ≠ó‰ª•‰∏ä„ÅÆ‰ΩçÁΩÆ„Å´Âè•Ë™≠ÁÇπ„Åå„ÅÇ„Çå„Å∞„ÄÅ„Åù„Åì„ÅßÂàá„Çã
                        finalResponse = truncated.substring(0, lastPunctuation + 1);
                    } else {
                        // Âè•Ë™≠ÁÇπ„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ117ÊñáÂ≠ó„ÅßÂàá„Å£„Å¶„Äå...„Äç„ÇíËøΩÂä†
                        finalResponse = truncated.substring(0, 117) + '...';
                    }

                    addLog(`ÊñáÂ≠óÊï∞Âà∂Èôê„Å´„Çà„ÇäÂøúÁ≠î„ÇíÁü≠Á∏Æ: ${finalResponse.length}ÊñáÂ≠ó`, 'info');
                }

                updateStatus('connected', 'Êé•Á∂ö‰∏≠');

                return finalResponse;
            } catch (error) {
                addLog(`LM Studio „Ç®„É©„Éº: ${error.message}`, 'error');

                // CORS „Ç®„É©„Éº„ÅÆÂ†¥Âêà„ÅÆÁâπÂà•„Å™„É°„ÉÉ„Çª„Éº„Ç∏
                if (error.message.includes('CORS') || error.message.includes('NetworkError')) {
                    addLog('CORS „Ç®„É©„Éº„ÅÆÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇLM Studio „ÅÆË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
                    addLog('LM Studio „Åß CORS „ÇíÊúâÂäπ„Å´„Åô„Çã„Åã„ÄÅ„Éó„É≠„Ç≠„Ç∑„Çµ„Éº„Éê„Çí‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'info');
                }

                updateStatus('connected', 'Êé•Á∂ö‰∏≠ (AI „Ç®„É©„Éº)');

                // ÈáçË¶Å: Âëº„Å≥Âá∫„ÅóÂÖÉ„ÅåÊé•Á∂öÂ§±Êïó„ÇíÊ§úÁü•„Åß„Åç„Çã„Çà„ÅÜ‰æãÂ§ñ„ÇíÂÜç„Çπ„É≠„Éº„Åô„Çã
                throw error;
            }
        }

        // „Ç≥„É°„É≥„Éà„Çí„Çµ„Éº„Éê„Å´ÈÄÅ‰ø°
        function sendComment(comment, source = 'comment') {
            if (!socket || !isConnected) {
                addLog('„Çµ„Éº„Éê„Å´Êé•Á∂ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
                return;
            }

            const data = {
                my_name: aiName,
                comment: comment,
                flg_speech: false,
                color_text: aiTextColor,
                color_text_stroke: '#111111',
                text_direction: aiTextDirection,
                flg_emoji: false,
                flg_sound: false,
                id_sound: 0,
                hidden: -1,
                source: source // 'speech' or 'comment'
            };

            socket.emit('comment', data);
            addLog(`„Ç≥„É°„É≥„ÉàÈÄÅ‰ø°: ${comment}`, 'sent');

            // Ëá™ÂàÜ„ÅÆÈÄÅ‰ø°„Ç≥„É°„É≥„Éà„ÇÇ„Ç≥„É°„É≥„Éà„É≠„Ç∞„Å´ËøΩÂä†
            addToCommentLog(data);
        }

        // Êñ∞„Åó„ÅÑ„Ç≥„É°„É≥„Éà„ÇíÂèó‰ø°„Åó„Åü„Å®„Åç„ÅÆÂá¶ÁêÜ
        async function onNewComment(data) {
            addLog(`Âèó‰ø°: [${data.my_name}] ${data.comment}`, 'received');

            // „Ç≥„É°„É≥„Éà„É≠„Ç∞„Å´ËøΩÂä†Ôºà„Åô„Åπ„Å¶„ÅÆ„Ç≥„É°„É≥„ÉàÔºâ
            addToCommentLog(data);

            // „Åô„Åπ„Å¶„ÅÆ„Ç≥„É°„É≥„Éà„Çí‰ºöË©±Â±•Ê≠¥„Å´ËøΩÂä†ÔºàËá™ÂàÜ„ÅÆ„Ç≥„É°„É≥„Éà‰ª•Â§ñ„ÄÅÁµµÊñáÂ≠ó„ÅÆ„Åø„ÅØÈô§Â§ñÔºâ
            if (data.my_name !== aiName && !data.flg_emoji) {
                // source„Éï„Ç£„Éº„É´„Éâ„ÅßË©±ËÄÖ„ÇíÂà§Âà•Ôºàspeech=ÈÖç‰ø°ËÄÖ, comment=ÂèÇÂä†ËÄÖÔºâ
                const speaker = data.source === 'speech' ? 'ÈÖç‰ø°ËÄÖ' : 'ÂèÇÂä†ËÄÖ';
                addToConversationHistory('user', `${data.my_name}: ${data.comment}`, speaker);
            }

            // AIÂêçÂâç„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            if (isAutoResponse && data.comment.includes(aiName)) {
                addLog(`„Äå${aiName}„Äç„ÇíÊ§úÂá∫„Åó„Åæ„Åó„Åü„ÄÇAIÂá¶ÁêÜ„ÇíÈñãÂßã„Åó„Åæ„Åô„ÄÇ`, 'info');

                try {
                    const aiResponse = await sendToLMStudio(data.comment);

                    // AI „ÅÆÂøúÁ≠î„Çí„Çµ„Éº„Éê„Å´ÈÄÅ‰ø°
                    setTimeout(() => {
                        sendComment(aiResponse);
                        // AI„ÅÆÂøúÁ≠î„ÇÇ‰ºöË©±Â±•Ê≠¥„Å´ËøΩÂä†
                        addToConversationHistory('assistant', aiResponse);
                    }, 1000); // 1ÁßíÈÅÖÂª∂

                } catch (error) {
                    addLog(`Âá¶ÁêÜ„Ç®„É©„Éº: ${error.message}`, 'error');
                }
            }
        }

        // Socket.IO Êé•Á∂ö
        function connectToServer() {
            roomName = textRoomName.value.trim();
            lmStudioUrl = textLmStudioUrl.value.trim();
            aiName = textAiName.value.trim();
            aiTextDirection = selectTextDirection.value;
            aiTextColor = inputTextColor.value;
            isAutoResponse = checkboxAutoResponse.checked;

            if (!roomName) {
                alert('ÈÉ®Â±ãÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            addLog('„Çµ„Éº„Éê„Å´Êé•Á∂ö„Åó„Å¶„ÅÑ„Åæ„Åô...', 'info');
            updateStatus('processing', 'Êé•Á∂ö‰∏≠...');

            // Socket.IO Êé•Á∂ö
            socket = io.connect(window.location.origin);

            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
            socket.on('connect', () => {
                addLog('„Çµ„Éº„Éê„Å´Êé•Á∂ö„Åó„Åæ„Åó„Åü', 'info');
                socket.emit('watcher', socket.id);
            });

            socket.on('you_are_connected', () => {
                addLog(`ÈÉ®Â±ã "${roomName}" „Å´ÂèÇÂä†„Åó„Å¶„ÅÑ„Åæ„Åô...`, 'info');
                socket.emit('join', roomName);
            });

            socket.on('login', (data) => {
                isConnected = true;
                updateStatus('connected', 'Êé•Á∂ö‰∏≠');
                addLog(`ÈÉ®Â±ã "${roomName}" „Å´ÂèÇÂä†„Åó„Åæ„Åó„Åü (ÂèÇÂä†ËÄÖÊï∞: ${data.numUsers})`, 'info');
                buttonConnect.textContent = 'ÂàáÊñ≠';
                updateUserStats(data.numUsers);

                // Êé•Á∂öÂæå„ÄÅ„Çµ„Éº„Éê„Éº„Åã„Çâ„Ç≥„É°„É≥„Éà„É≠„Ç∞„ÇíËá™ÂãïÂêåÊúüÔºà„Ç¢„É©„Éº„Éà„Å™„ÅóÔºâ
                setTimeout(() => {
                    syncCommentsFromServer(false);
                }, 500);
            });

            socket.on('comment', onNewComment);

            socket.on('user joined', (data) => {
                addLog(`${data.username} „ÅåÂèÇÂä†„Åó„Åæ„Åó„Åü (ÂèÇÂä†ËÄÖÊï∞: ${data.numUsers})`, 'info');
                updateUserStats(data.numUsers);
            });

            socket.on('user left', (data) => {
                addLog(`${data.username} „ÅåÈÄÄÂá∫„Åó„Åæ„Åó„Åü (ÂèÇÂä†ËÄÖÊï∞: ${data.numUsers})`, 'info');
                updateUserStats(data.numUsers);
            });

            socket.on('disconnect', () => {
                isConnected = false;
                stopAutoPosting(); // Ëá™ÂãïÊäïÁ®ø„ÇíÂÅúÊ≠¢
                updateStatus('disconnected', 'ÂàáÊñ≠„Åï„Çå„Åæ„Åó„Åü');
                addLog('„Çµ„Éº„Éê„Åã„ÇâÂàáÊñ≠„Åï„Çå„Åæ„Åó„Åü', 'error');
                buttonConnect.textContent = 'Êé•Á∂ö';
            });

            socket.on('reconnect', () => {
                addLog('„Çµ„Éº„Éê„Å´ÂÜçÊé•Á∂ö„Åó„Åæ„Åó„Åü', 'info');
                socket.emit('join', roomName);
            });
        }

        // „Çµ„Éº„Éê„Åã„ÇâÂàáÊñ≠
        function disconnectFromServer() {
            if (socket) {
                socket.close();
                socket = null;
            }
            isConnected = false;
            stopAutoPosting(); // Ëá™ÂãïÊäïÁ®ø„ÇíÂÅúÊ≠¢
            updateStatus('disconnected', 'ÂàáÊñ≠„Åï„Çå„Åæ„Åó„Åü');
            addLog('„Çµ„Éº„Éê„Åã„ÇâÂàáÊñ≠„Åó„Åæ„Åó„Åü', 'info');
            buttonConnect.textContent = 'Êé•Á∂ö';
        }

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
        buttonConnect.addEventListener('click', () => {
            if (isConnected) {
                disconnectFromServer();
            } else {
                connectToServer();
            }
        });

        buttonClearLog.addEventListener('click', () => {
            logContainer.innerHTML = '';
        });

        buttonDownloadComments.addEventListener('click', () => {
            downloadCommentLog();
        });

        buttonDownloadCsv.addEventListener('click', () => {
            downloadCommentCsv();
        });

        buttonClearComments.addEventListener('click', () => {
            clearCommentLog();
        });

        // ÂêåÊúü„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        document.getElementById('button_sync_comments').addEventListener('click', () => {
            syncCommentsFromServer(true); // „Ç¢„É©„Éº„ÉàË°®Á§∫„ÅÇ„Çä
        });

        // ÂèÇÂä†ËÄÖÊï∞Áµ±Ë®à„ÅÆ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
        document.getElementById('button_download_user_stats').addEventListener('click', () => {
            downloadUserStatsCSV();
        });

        // „Ç≥„É≥„ÉÜ„Ç≠„Çπ„ÉàÈï∑Áµ±Ë®à„ÅÆ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
        document.getElementById('button_download_context_stats').addEventListener('click', () => {
            downloadContextStatsCSV();
        });

        buttonTestLMStudio.addEventListener('click', () => {
            testLMStudioConnection();
        });

        // AIÂêçÂâç„ÅÆÂ§âÊõ¥Áõ£Ë¶ñ
        textAiName.addEventListener('input', () => {
            aiName = textAiName.value.trim() || 'Á±≥Â§™ÈÉé';
            updateAutoResponseLabel();
            updateAiNameAutoResponseLabel();
            // localStorage„Å´‰øùÂ≠ò
            saveAiName(aiName);
            addLog(`AIÂêçÂâç„Çí„Äå${aiName}„Äç„Å´Â§âÊõ¥„Åó„Åæ„Åó„Åü`, 'info');
        });

        // ÊñáÂ≠ó„ÅÆÊµÅ„Çå„ÇãÊñπÂêë„ÅÆÂ§âÊõ¥Áõ£Ë¶ñ
        selectTextDirection.addEventListener('change', () => {
            aiTextDirection = selectTextDirection.value;
            const directionText = selectTextDirection.options[selectTextDirection.selectedIndex].text;
            addLog(`ÊñáÂ≠ó„ÅÆÊµÅ„Çå„ÇãÊñπÂêë„Çí„Äå${directionText}„Äç„Å´Â§âÊõ¥„Åó„Åæ„Åó„Åü`, 'info');
        });

        // ÊñáÂ≠óËâ≤„ÅÆÂ§âÊõ¥Áõ£Ë¶ñ
        inputTextColor.addEventListener('change', () => {
            aiTextColor = inputTextColor.value;
            addLog(`ÊñáÂ≠óËâ≤„Çí„Äå${aiTextColor}„Äç„Å´Â§âÊõ¥„Åó„Åæ„Åó„Åü`, 'info');
        });

        // „Ç∑„Çπ„ÉÜ„É†„Éó„É≠„É≥„Éó„Éà„ÅÆÂ§âÊõ¥Áõ£Ë¶ñ
        textareaSystemPrompt.addEventListener('input', () => {
            const prompt = textareaSystemPrompt.value;
            saveSystemPrompt(prompt);
        });

        // „Ç∑„Çπ„ÉÜ„É†„Éó„É≠„É≥„Éó„Éà„É™„Çª„ÉÉ„Éà„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        buttonResetSystemPrompt.addEventListener('click', () => {
            resetSystemPrompt();
        });

        // Ëá™ÂãïÂøúÁ≠î„É©„Éô„É´„ÇíÊõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞
        function updateAutoResponseLabel() {
            const labelAutoResponse = document.getElementById('label_auto_response');
            labelAutoResponse.textContent = `„Äå${aiName}„Äç„ÇíÂê´„ÇÄ„É°„ÉÉ„Çª„Éº„Ç∏„Å´Ëá™ÂãïÂøúÁ≠î`;
        }

        // Èü≥Â£∞Ë™çË≠ò„ÅÆAIÂêçÂâçËá™ÂãïÂøúÁ≠î„É©„Éô„É´„ÇíÊõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞
        function updateAiNameAutoResponseLabel() {
            if (labelAiNameAutoResponse) {
                labelAiNameAutoResponse.textContent = `„Äå${aiName}„Äç„ÇíÂê´„ÇÄÈü≥Â£∞Ë™çË≠ò„ÇíËá™Âãï„ÅßAI„Å´ÈÄÅ‰ø°`;
            }
        }

        // Ëá™ÂãïÊäïÁ®øÈñ¢ÈÄ£„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        checkboxAutoPosting.addEventListener('change', () => {
            if (checkboxAutoPosting.checked) {
                startAutoPosting();
            } else {
                stopAutoPosting();
            }
        });

        rangePostingIntervalMin.addEventListener('input', () => {
            postingIntervalMin = parseInt(rangePostingIntervalMin.value);
            spanIntervalMin.textContent = postingIntervalMin;

            // ÊúÄÂ∞èÂÄ§„ÅåÊúÄÂ§ßÂÄ§„ÇíË∂Ö„Åà„Å™„ÅÑ„Çà„ÅÜ„Å´„Åô„Çã
            if (postingIntervalMin >= postingIntervalMax) {
                postingIntervalMax = postingIntervalMin + 1;
                rangePostingIntervalMax.value = postingIntervalMax;
                spanIntervalMax.textContent = postingIntervalMax;
            }
        });

        rangePostingIntervalMax.addEventListener('input', () => {
            postingIntervalMax = parseInt(rangePostingIntervalMax.value);
            spanIntervalMax.textContent = postingIntervalMax;

            // ÊúÄÂ§ßÂÄ§„ÅåÊúÄÂ∞èÂÄ§„Çí‰∏ãÂõû„Çâ„Å™„ÅÑ„Çà„ÅÜ„Å´„Åô„Çã
            if (postingIntervalMax <= postingIntervalMin) {
                postingIntervalMin = postingIntervalMax - 1;
                rangePostingIntervalMin.value = postingIntervalMin;
                spanIntervalMin.textContent = postingIntervalMin;
            }
        });

        selectPostingStyle.addEventListener('change', () => {
            postingStyle = selectPostingStyle.value;
            addLog(`ÊäïÁ®ø„Çπ„Çø„Ç§„É´„Çí„Äå${selectPostingStyle.options[selectPostingStyle.selectedIndex].text}„Äç„Å´Â§âÊõ¥`, 'info');
        });

        buttonTestAutoPosting.addEventListener('click', () => {
            testAutoPosting();
        });

        // Èü≥Â£∞Ë™çË≠òÈñ¢ÈÄ£„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        buttonRefreshMics.addEventListener('click', () => {
            refreshMicrophones();
        });

        selectMicrophone.addEventListener('change', () => {
            selectedMicrophoneId = selectMicrophone.value;
            addLog(`„Éû„Ç§„ÇØ„ÇíÂ§âÊõ¥„Åó„Åæ„Åó„Åü: ${selectMicrophone.options[selectMicrophone.selectedIndex].text}`, 'info');
        });

        selectSpeechLanguage.addEventListener('change', () => {
            recognitionLanguage = selectSpeechLanguage.value;
            addLog(`Èü≥Â£∞Ë™çË≠òË®ÄË™û„ÇíÂ§âÊõ¥„Åó„Åæ„Åó„Åü: ${selectSpeechLanguage.options[selectSpeechLanguage.selectedIndex].text}`, 'info');
        });

        buttonStartSpeech.addEventListener('click', () => {
            startSpeechRecognition();
        });

        buttonStopSpeech.addEventListener('click', () => {
            stopSpeechRecognition();
        });

        buttonClearSpeech.addEventListener('click', () => {
            clearSpeechResult();
        });

        checkboxContinuousSpeech.addEventListener('change', () => {
            isContinuous = checkboxContinuousSpeech.checked;
            addLog(`ÈÄ£Á∂öË™çË≠ò„É¢„Éº„Éâ: ${isContinuous ? 'ON' : 'OFF'}`, 'info');
        });

        // checkboxAutoSendSpeech listener removed (auto-send feature deleted)

        checkboxAiNameAutoResponse.addEventListener('change', () => {
            isAiNameAutoResponse = checkboxAiNameAutoResponse.checked;
            addLog(`AI„Ç¢„Ç∑„Çπ„Çø„É≥„ÉàÂêçÈü≥Â£∞Ë™çË≠òËá™ÂãïÂøúÁ≠î: ${isAiNameAutoResponse ? 'ON' : 'OFF'}`, 'info');
        });

        inputConversationHistoryLimit.addEventListener('change', () => {
            conversationHistoryLimit = parseInt(inputConversationHistoryLimit.value);
            addLog(`‰ºöË©±Â±•Ê≠¥‰øùÂ≠òÊï∞„Çí${conversationHistoryLimit}‰ª∂„Å´Â§âÊõ¥„Åó„Åæ„Åó„Åü`, 'info');

            // ÁèæÂú®„ÅÆÂ±•Ê≠¥Êï∞„Åå‰∏äÈôê„ÇíË∂Ö„Åà„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÂâäÈô§
            if (conversationHistory.length > conversationHistoryLimit) {
                conversationHistory = conversationHistory.slice(-conversationHistoryLimit);
                addLog(`Â±•Ê≠¥„Çí${conversationHistoryLimit}‰ª∂„Å´Ë™øÊï¥„Åó„Åæ„Åó„Åü`, 'info');
            }
            // ÁèæÂú®„ÅÆÂ±•Ê≠¥Êï∞„ÇíÊõ¥Êñ∞
            updateCurrentHistoryCount();
        });

        buttonClearHistory.addEventListener('click', () => {
            clearConversationHistory();
        });

        // Ë®≠ÂÆö„ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
        checkboxAutoResponse.addEventListener('change', () => {
            isAutoResponse = checkboxAutoResponse.checked;
            addLog(`Ëá™ÂãïÂøúÁ≠î: ${isAutoResponse ? 'ON' : 'OFF'}`, 'info');
        });

        // ÂàùÊúüÂåñÂá¶ÁêÜ
        document.addEventListener('DOMContentLoaded', () => {
            // URL „Éë„É©„É°„Éº„Çø„Åã„Çâ„É´„Éº„É†Âêç„ÇíÂèñÂæó
            const params = getURLParams();
            if (params.room) {
                const roomFromUrl = decodeURIComponent(params.room);
                textRoomName.value = roomFromUrl;
                addLog(`ÈÉ®Â±ãÂêç„Äå${roomFromUrl}„Äç„ÅåËá™ÂãïË®≠ÂÆö„Åï„Çå„Åæ„Åó„Åü`, 'info');

                // Ëá™Âãï„ÅßÊé•Á∂ö„ÇíÈñãÂßã
                setTimeout(() => {
                    if (!isConnected) {
                        addLog('Ëá™ÂãïÊé•Á∂ö„ÇíÈñãÂßã„Åó„Åæ„Åô...', 'info');
                        connectToServer();
                    }
                }, 1000); // 1ÁßíÂæÖ„Å£„Å¶„Åã„ÇâËá™ÂãïÊé•Á∂ö
            }

            // ÂàùÊúüÂÄ§„ÅÆË®≠ÂÆö
            spanIntervalMin.textContent = postingIntervalMin;
            spanIntervalMax.textContent = postingIntervalMax;

            // AI„Ç¢„Ç∑„Çπ„Çø„É≥„ÉàÂêç„ÅÆÂàùÊúüÂåñÔºàlocalStorage„Åã„ÇâË™≠„ÅøËæº„ÅøÔºâ
            textAiName.value = aiName;

            // Ë°®Á§∫Ë®≠ÂÆö„ÅÆÂàùÊúüÂÄ§„ÇíË®≠ÂÆö
            selectTextDirection.value = aiTextDirection;
            inputTextColor.value = aiTextColor;

            // Ëá™ÂãïÂøúÁ≠î„É©„Éô„É´„ÇíÂàùÊúüË®≠ÂÆö
            updateAutoResponseLabel();
            updateAiNameAutoResponseLabel();

            // Èü≥Â£∞Ë™çË≠ò„ÅÆÂàùÊúüÂåñ
            initializeSpeechRecognition();
            refreshMicrophones();

            // ‰ºöË©±Â±•Ê≠¥Ë®≠ÂÆö„ÅÆÂàùÊúüÂåñ
            conversationHistoryLimit = parseInt(inputConversationHistoryLimit.value);
            updateCurrentHistoryCount();

            // ÂèÇÂä†ËÄÖÊï∞„Ç∞„É©„Éï„ÅÆÂàùÊúüÂåñ
            initUserStatsChart();

            // „Ç≥„É≥„ÉÜ„Ç≠„Çπ„ÉàÈï∑„Ç∞„É©„Éï„ÅÆÂàùÊúüÂåñ
            initContextStatsChart();

            addLog(`${aiName} AI „Ç¢„Ç∑„Çπ„Çø„É≥„Éà„ÅåËµ∑Âãï„Åó„Åæ„Åó„Åü`, 'info');
            addLog(`„Äå${aiName}„Äç„ÇíÂê´„ÇÄ„É°„ÉÉ„Çª„Éº„Ç∏„Å´Ëá™Âãï„Åß AI „ÅåÂøúÁ≠î„Åó„Åæ„Åô`, 'info');
            addLog(`Ë°®Á§∫Ë®≠ÂÆö: ${selectTextDirection.options[selectTextDirection.selectedIndex].text}„ÄÅËâ≤: ${aiTextColor}`, 'info');
            addLog('Ëá™ÂãïÊäïÁ®øÊ©üËÉΩ„ÅßÊéàÊ•≠„ÇíÁõõ„Çä‰∏ä„Åí„Çã„Åì„Å®„Åå„Åß„Åç„Åæ„Åô', 'info');
            addLog('Èü≥Â£∞Ë™çË≠òÊ©üËÉΩ„ÅåÂà©Áî®ÂèØËÉΩ„Åß„Åô', 'info');
            addLog(`‰ºöË©±Â±•Ê≠¥Ê©üËÉΩ„ÅåÊúâÂäπ„Åß„ÅôÔºà‰øùÂ≠òÊï∞: ${conversationHistoryLimit}‰ª∂Ôºâ`, 'info');
            // Masonry „ÅÆÂàùÊúüÂåñ„Å® textarea „ÅÆ Resize „ÇíÁõ£Ë¶ñ„Åó„Å¶ÂÜç„É¨„Ç§„Ç¢„Ç¶„Éà
            (function initResponsiveMasonry() {
                const grid = document.querySelector('[data-masonry]');
                if (!grid) return;

                function setup() {
                    if (typeof Masonry === 'undefined') {
                        // Masonry „Åå„É≠„Éº„Éâ„Åï„Çå„Å¶„ÅÑ„Å™„Åë„Çå„Å∞ÈÅÖÂª∂„É™„Éà„É©„Ç§
                        setTimeout(setup, 150);
                        return;
                    }

                    // .col-md-6 „Çí„Ç¢„Ç§„ÉÜ„É†„Å®„Åó„Å¶Êâ±„ÅÜ
                    const msnry = new Masonry(grid, {
                        itemSelector: '.col-md-6',
                        percentPosition: true,
                        transitionDuration: '0.25s'
                    });

                    // Áõ£Ë¶ñÂØæË±°„ÅÆ textarea „ÇíÂèñÂæóÔºà„Ç´„Éº„ÉâÂÜÖ„ÅÆ textarea ÂÖ®„Å¶Ôºâ
                    const textareas = Array.from(grid.querySelectorAll('textarea'));
                    let layoutTimer = null;
                    const scheduleLayout = () => {
                        if (layoutTimer) clearTimeout(layoutTimer);
                        layoutTimer = setTimeout(() => msnry.layout(), 120);
                    };

                    if (typeof ResizeObserver !== 'undefined') {
                        const ro = new ResizeObserver(scheduleLayout);
                        textareas.forEach(t => ro.observe(t));
                    } else {
                        // ResizeObserver „ÅåÁÑ°„ÅÑÂ†¥Âêà„ÅØ input/resize „Åß‰ª£Êõø
                        textareas.forEach(t => t.addEventListener('input', scheduleLayout));
                        window.addEventListener('resize', scheduleLayout);
                    }

                    // ÂÜÖÂÆπÂ§âÊõ¥„Åß„ÇÇÂÜç„É¨„Ç§„Ç¢„Ç¶„Éà
                    textareas.forEach(t => t.addEventListener('input', scheduleLayout));

                    // ÂàùÂõû„É¨„Ç§„Ç¢„Ç¶„Éà
                    setTimeout(() => msnry.layout(), 300);
                }

                setup();
            })();
        });

        // „Éö„Éº„Ç∏„ÅåÈñâ„Åò„Çâ„Çå„ÇãÂâç„Å´„ÇΩ„Ç±„ÉÉ„Éà„ÇíÈñâ„Åò„Çã
        window.addEventListener('beforeunload', () => {
            stopAutoPosting(); // Ëá™ÂãïÊäïÁ®ø„ÇíÂÅúÊ≠¢
            if (socket) {
                socket.close();
            }
        });

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„ÅÆÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            // ‰øùÂ≠ò„Åï„Çå„Åü„Ç∑„Çπ„ÉÜ„É†„Éó„É≠„É≥„Éó„Éà„ÇíË™≠„ÅøËæº„Åø
            const savedSystemPrompt = loadSystemPrompt();
            textareaSystemPrompt.value = savedSystemPrompt;

            // AIÂêç„ÇíË™≠„ÅøËæº„Åø
            const savedAiName = loadAiName();
            textAiName.value = savedAiName;
            aiName = savedAiName;

            // URL „Éë„É©„É°„Éº„Çø„ÅÆË®≠ÂÆö
            const urlParams = getURLParams();
            if (urlParams.room) {
                textRoomName.value = urlParams.room;
            }

            // ÂàùÊúüÂåñÂÆå‰∫Ü„ÅÆ„É≠„Ç∞
            addLog('Ë®≠ÂÆö„ÇíÂàùÊúüÂåñ„Åó„Åæ„Åó„Åü', 'info');
        });
    </script>

</body>

</html>